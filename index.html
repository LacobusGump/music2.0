<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Soundtrack: Real Instruments</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle at center, #001100 0%, #000 100%);
      color: #0f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    
    .title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px #0f0;
      animation: pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { text-shadow: 0 0 20px #0f0; }
      to { text-shadow: 0 0 30px #0f0, 0 0 40px #0a0; }
    }
    
    .start-btn {
      padding: 15px 30px;
      background: linear-gradient(45deg, #0f0, #0a0);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,255,0,0.3);
      transition: all 0.3s;
    }
    
    .start-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0,255,0,0.5);
    }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .control-btn {
      padding: 10px 20px;
      background: rgba(0,255,0,0.1);
      color: #0f0;
      border: 2px solid #0f0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(0,255,0,0.2);
      transform: translateY(-2px);
    }
    
    .control-btn.active {
      background: rgba(0,255,0,0.4);
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
    }
    
    .status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
      font-size: 0.9rem;
    }
    
    .status-item {
      background: rgba(0,255,0,0.1);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,0,0.3);
      backdrop-filter: blur(10px);
    }
    
    .layer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    
    .layer-indicator {
      background: rgba(0,255,0,0.1);
      border: 2px solid rgba(0,255,0,0.3);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      font-size: 0.8rem;
      transition: all 0.3s;
    }
    
    .layer-indicator.active {
      background: rgba(0,255,0,0.3);
      border-color: #0f0;
      box-shadow: 0 0 15px rgba(0,255,0,0.5);
      transform: scale(1.05);
    }
    
    .evolution-bar {
      width: 100%;
      height: 25px;
      background: rgba(0,255,0,0.1);
      border: 2px solid rgba(0,255,0,0.3);
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .evolution-progress {
      height: 100%;
      background: linear-gradient(90deg, #0f0, #0a0, #0f0);
      background-size: 200% 100%;
      animation: shimmer 2s ease-in-out infinite;
      transition: width 0.5s ease;
      box-shadow: 0 0 20px rgba(0,255,0,0.5);
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .rhythm-pattern {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 10px 0;
    }
    
    .beat-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,255,0,0.3);
      transition: all 0.2s;
    }
    
    .beat-dot.active {
      background: #0f0;
      box-shadow: 0 0 15px #0f0;
      transform: scale(1.3);
    }
    
    .complexity-bars {
      display: flex;
      justify-content: center;
      gap: 3px;
      margin: 10px 0;
    }
    
    .complexity-bar {
      width: 8px;
      height: 30px;
      background: rgba(0,255,0,0.2);
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .complexity-bar.active {
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    
    .hidden { display: none; }
    
    .instrument-name {
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .instrument-info {
      font-size: 0.7rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">LIFE SOUNDTRACK: REAL INSTRUMENTS</h1>
    <button class="start-btn" id="startBtn">Initialize Orchestra</button>
    
    <div class="controls hidden" id="controls">
      <button class="control-btn" id="btnMotionPermission">Enable Motion Detection</button>
      <button class="control-btn" id="btnComplexity">Force Evolution</button>
      <button class="control-btn" id="btnChaos">Chaos Mode</button>
      <div style="margin-top: 10px; font-size: 0.8rem; color: #0a0;">
        <div id="motionStatus">Motion detection inactive</div>
        <div id="motionDebug">Move device to trigger evolution</div>
      </div>
    </div>
    
    <div class="status hidden" id="status">
      <div class="status-item">
        <div>Motion: <span id="motionLevel">0</span></div>
        <div>State: <span id="currentState">Still</span></div>
        <div>Evolution: <span id="evolutionLevel">0</span>%</div>
      </div>
      <div class="status-item">
        <div>Tempo: <span id="currentTempo">72</span> BPM</div>
        <div>Key: <span id="currentKey">A Minor</span></div>
        <div>Instruments: <span id="layerCount">1</span>/12</div>
      </div>
      <div class="status-item">
        <div>Stage: <span id="evolutionStage">Dormant</span></div>
        <div>Complexity: <span id="complexity">Minimal</span></div>
        <div>Chaos: <span id="chaosLevel">0</span>%</div>
      </div>
    </div>
    
    <div class="layers hidden" id="layers">
      <div>Evolution Progress:</div>
      <div class="evolution-bar">
        <div class="evolution-progress" id="evolutionProgress"></div>
      </div>
      
      <div class="complexity-bars">
        <div class="complexity-bar" data-level="1"></div>
        <div class="complexity-bar" data-level="2"></div>
        <div class="complexity-bar" data-level="3"></div>
        <div class="complexity-bar" data-level="4"></div>
        <div class="complexity-bar" data-level="5"></div>
        <div class="complexity-bar" data-level="6"></div>
        <div class="complexity-bar" data-level="7"></div>
        <div class="complexity-bar" data-level="8"></div>
        <div class="complexity-bar" data-level="9"></div>
        <div class="complexity-bar" data-level="10"></div>
      </div>
      
      <div class="rhythm-pattern" id="rhythmPattern"></div>
      
      <div class="layer-grid" id="layerGrid"></div>
    </div>
  </div>

  <script>
    const KEYS = {
      A_MINOR: {
        name: 'A Minor',
        chords: {
          i: ['A3', 'C4', 'E4'],
          ii: ['B3', 'D4', 'F4'],
          III: ['C4', 'E4', 'G4'],
          iv: ['D4', 'F4', 'A4'],
          v: ['E4', 'G4', 'B4'],
          VI: ['F4', 'A4', 'C5'],
          VII: ['G4', 'B4', 'D5'],
          'i7': ['A3', 'C4', 'E4', 'G4'],
          'ii7': ['B3', 'D4', 'F4', 'A4']
        }
      },
      D_MINOR: {
        name: 'D Minor',
        chords: {
          i: ['D3', 'F3', 'A3'],
          ii: ['E3', 'G3', 'Bb3'],
          III: ['F3', 'A3', 'C4'],
          iv: ['G3', 'Bb3', 'D4']
        }
      }
    };
    
    const PROGRESSIONS = {
      dormant: ['i'],
      awakening: ['i', 'VI', 'iv'],
      building: ['i', 'VI', 'III', 'VII', 'iv'],
      active: ['i', 'iv', 'VI', 'v', 'III', 'VII'],
      evolved: ['i7', 'ii7', 'VI', 'iv', 'v', 'VII', 'III', 'i'],
      transcendent: ['i7', 'ii7', 'VI', 'iv', 'v', 'VII', 'III', 'i', 'ii', 'VI', 'iv', 'v']
    };
    
    const LAYERS = {
      piano: { name: 'Piano', threshold: 0, info: 'Steinway grand' },
      violin: { name: 'Violin', threshold: 5, info: 'String section' },
      cello: { name: 'Cello', threshold: 10, info: 'Deep strings' },
      flute: { name: 'Flute', threshold: 15, info: 'Woodwind melody' },
      trumpet: { name: 'Trumpet', threshold: 25, info: 'Brass lead' },
      saxophone: { name: 'Saxophone', threshold: 30, info: 'Jazz tenor' },
      drums: { name: 'Drums', threshold: 35, info: 'Acoustic kit' },
      guitar: { name: 'Guitar', threshold: 40, info: 'Steel string' },
      harp: { name: 'Harp', threshold: 45, info: 'Concert harp' },
      organ: { name: 'Organ', threshold: 50, info: 'Church organ' },
      choir: { name: 'Choir', threshold: 60, info: 'Vocal ensemble' },
      orchestra: { name: 'Orchestra', threshold: 70, info: 'Full symphony' }
    };
    
    let state = {
      active: false,
      currentKey: KEYS.A_MINOR,
      motionIntensity: 0,
      activityState: 'still',
      tempo: 72,
      evolutionStage: 'dormant',
      evolutionLevel: 0,
      activeLayers: new Set(['piano']),
      complexity: 0,
      chaosLevel: 0,
      chordIndex: 0,
      beatCount: 0,
      motionPermissionGranted: false,
      forceEvolution: false,
      chaosMode: false,
      lastMotionTime: 0,
      motionHistory: []
    };
    
    let instruments = {};
    let effects = {};
    let audioInitialized = false;
    
    async function initAudio() {
      if (audioInitialized) return;
      
      await Tone.start();
      
      // Effects
      effects.reverb = new Tone.Reverb({
        decay: 4,
        wet: 0.3
      });
      effects.delay = new Tone.PingPongDelay("8n", 0.2);
      effects.chorus = new Tone.Chorus(6, 2.5, 0.5);
      effects.compressor = new Tone.Compressor(-30, 3);
      
      await effects.reverb.generate();
      
      // Real instrument simulations
      instruments.piano = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: "fmtriangle",
          harmonicity: 2,
          modulationType: "sine",
          modulationIndex: 1
        },
        envelope: {
          attack: 0.002,
          decay: 0.3,
          sustain: 0.2,
          release: 1.2
        }
      }).chain(effects.compressor, effects.reverb, Tone.Destination);
      
      instruments.violin = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: "fatsawtooth"
        },
        envelope: {
          attack: 0.08,
          decay: 0.2,
          sustain: 0.9,
          release: 0.8
        }
      }).chain(effects.chorus, effects.reverb, Tone.Destination);
      
      instruments.cello = new Tone.MonoSynth({
        oscillator: {
          type: "fatsawtooth"
        },
        envelope: {
          attack: 0.1,
          decay: 0.3,
          sustain: 0.8,
          release: 1.0
        },
        filter: {
          Q: 2,
          frequency: 600,
          type: "lowpass"
        }
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.flute = new Tone.MonoSynth({
        oscillator: {
          type: "sine"
        },
        envelope: {
          attack: 0.05,
          decay: 0.1,
          sustain: 0.8,
          release: 0.4
        },
        filter: {
          Q: 15,
          frequency: 5000,
          type: "highpass"
        }
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.trumpet = new Tone.MonoSynth({
        oscillator: {
          type: "square"
        },
        envelope: {
          attack: 0.01,
          decay: 0.2,
          sustain: 0.7,
          release: 0.3
        },
        filter: {
          Q: 5,
          frequency: 2000,
          type: "bandpass"
        }
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.saxophone = new Tone.MonoSynth({
        oscillator: {
          type: "square"
        },
        envelope: {
          attack: 0.02,
          decay: 0.1,
          sustain: 0.8,
          release: 0.4
        },
        filter: {
          Q: 8,
          frequency: 1200,
          type: "bandpass"
        }
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.drums = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 10,
        oscillator: {
          type: "sine"
        },
        envelope: {
          attack: 0.001,
          decay: 0.4,
          sustain: 0.01,
          release: 1.4
        }
      }).chain(effects.compressor, Tone.Destination);
      
      instruments.guitar = new Tone.PluckSynth({
        attackNoise: 1,
        dampening: 4000,
        resonance: 0.7
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.harp = new Tone.MetalSynth({
        frequency: 200,
        envelope: {
          attack: 0.001,
          decay: 1.4,
          sustain: 0.0,
          release: 1.4
        },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).chain(effects.reverb, Tone.Destination);
      
      instruments.organ = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: "fat"
        },
        envelope: {
          attack: 0.01,
          decay: 0.1,
          sustain: 0.9,
          release: 0.2
        }
      }).chain(effects.chorus, effects.reverb, Tone.Destination);
      
      instruments.choir = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: "sine"
        },
        envelope: {
          attack: 0.2,
          decay: 0.1,
          sustain: 0.8,
          release: 0.5
        },
        filter: {
          Q: 10,
          frequency: 1000,
          type: "bandpass"
        }
      }).chain(effects.chorus, effects.reverb, Tone.Destination);
      
      instruments.orchestra = new Tone.PolySynth(Tone.Synth, {
        oscillator: {
          type: "fatsawtooth"
        },
        envelope: {
          attack: 0.1,
          decay: 0.2,
          sustain: 0.8,
          release: 1.0
        }
      }).chain(effects.chorus, effects.reverb, Tone.Destination);
      
      // Set realistic volumes
      instruments.piano.volume.value = -12;
      instruments.violin.volume.value = -15;
      instruments.cello.volume.value = -10;
      instruments.flute.volume.value = -18;
      instruments.trumpet.volume.value = -8;
      instruments.saxophone.volume.value = -12;
      instruments.drums.volume.value = -6;
      instruments.guitar.volume.value = -14;
      instruments.harp.volume.value = -16;
      instruments.organ.volume.value = -10;
      instruments.choir.volume.value = -16;
      instruments.orchestra.volume.value = -8;
      
      Tone.Transport.bpm.value = state.tempo;
      Tone.Transport.start();
      
      audioInitialized = true;
      startSequence();
    }
    
    function startSequence() {
      Tone.Transport.scheduleRepeat((time) => {
        state.beatCount++;
        
        if (state.beatCount % 4 === 0) playChord(time);
        if (state.beatCount % 2 === 0 && state.activeLayers.has('cello')) playBass(time);
        if (state.activeLayers.has('drums')) playDrums(time);
        if (state.activeLayers.has('violin') && state.beatCount % 6 === 0) playViolin(time);
        if (state.activeLayers.has('flute') && state.beatCount % 8 === 0) playFlute(time);
        if (state.activeLayers.has('trumpet') && state.beatCount % 12 === 0) playTrumpet(time);
        if (state.activeLayers.has('saxophone') && state.beatCount % 16 === 0) playSaxophone(time);
        if (state.activeLayers.has('guitar') && state.beatCount % 7 === 0) playGuitar(time);
        if (state.activeLayers.has('harp') && Math.random() < 0.3) playHarp(time);
        if (state.activeLayers.has('organ') && state.beatCount % 8 === 0) playOrgan(time);
        if (state.activeLayers.has('choir') && state.beatCount % 16 === 0) playChoir(time);
        if (state.activeLayers.has('orchestra') && state.beatCount % 12 === 0) playOrchestra(time);
        
        evolveMusic();
        updateUI();
        updateRhythmDisplay();
      }, '4n');
    }
    
    function playChord(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord && state.activeLayers.has('piano')) {
        instruments.piano.triggerAttackRelease(chord, '2n', time);
      }
      
      state.chordIndex++;
    }
    
    function playBass(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const bassNote = chord[0].replace('3', '2');
        instruments.cello.triggerAttackRelease(bassNote, '4n', time);
      }
    }
    
    function playDrums(time) {
      const patterns = {
        still: [1, 0, 0, 0],
        walking: [1, 0, 1, 0],
        running: [1, 1, 0, 1],
        dancing: [1, 1, 1, 1]
      };
      
      const pattern = patterns[state.activityState];
      const beat = state.beatCount % 4;
      
      if (pattern[beat]) {
        const pitch = ['C2', 'D2', 'E2'][Math.floor(Math.random() * 3)];
        instruments.drums.triggerAttackRelease(pitch, '16n', time);
      }
    }
    
    function playViolin(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const melody = chord.map(note => note.replace(/\d/, '5'));
        instruments.violin.triggerAttackRelease(melody, '4n', time);
      }
    }
    
    function playFlute(time) {
      const scale = ['A5', 'B5', 'C6', 'D6', 'E6', 'F6', 'G6'];
      const note = scale[Math.floor(Math.random() * scale.length)];
      instruments.flute.triggerAttackRelease(note, '8n', time);
    }
    
    function playTrumpet(time) {
      const fanfare = ['C5', 'E5', 'G5', 'C6'];
      const note = fanfare[Math.floor(Math.random() * fanfare.length)];
      instruments.trumpet.triggerAttackRelease(note, '4n', time);
    }
    
    function playSaxophone(time) {
      const jazzScale = ['A4', 'C5', 'D5', 'E5', 'G5', 'A5'];
      const note = jazzScale[Math.floor(Math.random() * jazzScale.length)];
      instruments.saxophone.triggerAttackRelease(note, '8n', time);
    }
    
    function playGuitar(time) {
      const openStrings = ['E3', 'A3', 'D4', 'G4', 'B4', 'E5'];
      const note = openStrings[Math.floor(Math.random() * openStrings.length)];
      instruments.guitar.triggerAttackRelease(note, '8n', time);
    }
    
    function playHarp(time) {
      const glissando = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
      const note = glissando[Math.floor(Math.random() * glissando.length)];
      instruments.harp.triggerAttackRelease(note, '16n', time);
    }
    
    function playOrgan(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const organChord = chord.map(note => note.replace(/\d/, '4'));
        instruments.organ.triggerAttackRelease(organChord, '1n', time);
      }
    }
    
    function playChoir(time) {
      const vowels = ['A4', 'E4', 'I4', 'O4', 'U4'];
      const note = vowels[Math.floor(Math.random() * vowels.length)];
      instruments.choir.triggerAttackRelease(note, '2n', time);
    }
    
    function playOrchestra(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const orchestralChord = [
          ...chord,
          ...chord.map(note => note.replace(/\d/, '5'))
        ];
        instruments.orchestra.triggerAttackRelease(orchestralChord, '1n', time);
      }
    }
    
    function evolveMusic() {
      if (state.forceEvolution) {
        state.evolutionLevel = Math.min(100, state.evolutionLevel + 2);
      } else {
        state.evolutionLevel = Math.min(100, state.evolutionLevel + state.motionIntensity * 0.1);
      }
      
      updateEvolutionStage();
      updateActiveLayers();
      updateTempo();
      updateComplexity();
    }
    
    function updateEvolutionStage() {
      const stages = [
        { name: 'dormant', threshold: 0 },
        { name: 'awakening', threshold: 10 },
        { name: 'building', threshold: 25 },
        { name: 'active', threshold: 40 },
        { name: 'evolved', threshold: 65 },
        { name: 'transcendent', threshold: 80 }
      ];
      
      for (let i = stages.length - 1; i >= 0; i--) {
        if (state.evolutionLevel >= stages[i].threshold) {
          state.evolutionStage = stages[i].name;
          break;
        }
      }
    }
    
    function updateActiveLayers() {
      Object.entries(LAYERS).forEach(([key, layer]) => {
        if (state.evolutionLevel >= layer.threshold) {
          state.activeLayers.add(key);
        }
      });
    }
    
    function updateTempo() {
      const baseTempo = 72;
      const tempoBoost = Math.floor(state.evolutionLevel * 0.8);
      state.tempo = baseTempo + tempoBoost;
      
      if (state.chaosMode) {
        state.tempo += Math.floor(Math.random() * 20) - 10;
      }
      
      Tone.Transport.bpm.rampTo(state.tempo, 0.5);
    }
    
    function updateComplexity() {
      state.complexity = Math.floor(state.evolutionLevel / 10);
      
      if (state.chaosMode) {
        state.chaosLevel = Math.min(100, state.chaosLevel + 1);
      } else {
        state.chaosLevel = Math.max(0, state.chaosLevel - 0.5);
      }
    }
    
    function updateUI() {
      document.getElementById('motionLevel').textContent = state.motionIntensity.toFixed(1);
      document.getElementById('currentState').textContent = state.activityState;
      document.getElementById('evolutionLevel').textContent = state.evolutionLevel.toFixed(0);
      document.getElementById('currentTempo').textContent = state.tempo;
      document.getElementById('currentKey').textContent = state.currentKey.name;
      document.getElementById('evolutionStage').textContent = state.evolutionStage;
      document.getElementById('layerCount').textContent = state.activeLayers.size;
      document.getElementById('complexity').textContent = ['Minimal', 'Simple', 'Basic', 'Growing', 'Moderate', 'Complex', 'Rich', 'Dense', 'Intense', 'Overwhelming', 'Transcendent'][state.complexity] || 'Transcendent';
      document.getElementById('chaosLevel').textContent = state.chaosLevel.toFixed(0);
      
      // Update evolution bar
      document.getElementById('evolutionProgress').style.width = state.evolutionLevel + '%';
      
      // Update complexity bars
      document.querySelectorAll('.complexity-bar').forEach((bar, index) => {
        bar.classList.toggle('active', index < state.complexity);
      });
      
      // Update layer grid
      updateLayerGrid();
    }
    
    function updateLayerGrid() {
      const layerGrid = document.getElementById('layerGrid');
      layerGrid.innerHTML = '';
      
      Object.entries(LAYERS).forEach(([key, layer]) => {
        const layerDiv = document.createElement('div');
        layerDiv.className = 'layer-indicator';
        layerDiv.innerHTML = `
          <div class="instrument-name">${layer.name}</div>
          <div class="instrument-info">${layer.info}</div>
        `;
        
        if (state.activeLayers.has(key)) {
          layerDiv.classList.add('active');
        }
        
        layerGrid.appendChild(layerDiv);
      });
    }
    
    function updateRhythmDisplay() {
      const rhythmPattern = document.getElementById('rhythmPattern');
      rhythmPattern.innerHTML = '';
      
      const patternLength = 8;
      const currentBeat = state.beatCount % patternLength;
      
      for (let i = 0; i < patternLength; i++) {
        const beatDot = document.createElement('div');
        beatDot.className = 'beat-dot';
        
        if (i === currentBeat) {
          beatDot.classList.add('active');
        }
        
        rhythmPattern.appendChild(beatDot);
      }
    }
    
    function requestMotionPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              startMotionDetection();
            }
          })
          .catch(console.error);
      } else {
        startMotionDetection();
      }
    }
    
    function startMotionDetection() {
      state.motionPermissionGranted = true;
      document.getElementById('motionStatus').textContent = 'Motion detection active';
      document.getElementById('btnMotionPermission').classList.add('active');
      
      window.addEventListener('devicemotion', (event) => {
        if (!state.active) return;
        
        const acceleration = event.acceleration;
        if (acceleration) {
          const totalAcceleration = Math.sqrt(
            acceleration.x * acceleration.x +
            acceleration.y * acceleration.y +
            acceleration.z * acceleration.z
          );
          
          state.motionIntensity = Math.min(totalAcceleration * 2, 20);
          state.lastMotionTime = Date.now();
          
          // Update activity state
          if (state.motionIntensity > 15) {
            state.activityState = 'dancing';
          } else if (state.motionIntensity > 8) {
            state.activityState = 'running';
          } else if (state.motionIntensity > 3) {
            state.activityState = 'walking';
          } else {
            state.activityState = 'still';
          }
          
          // Decay motion over time
          setTimeout(() => {
            if (Date.now() - state.lastMotionTime > 1000) {
              state.motionIntensity *= 0.9;
            }
          }, 1000);
        }
      });
    }
    
    // Event listeners
    document.getElementById('startBtn').addEventListener('click', async () => {
      if (!state.active) {
        await initAudio();
        state.active = true;
        document.getElementById('startBtn').textContent = 'Orchestra Active';
        document.getElementById('controls').classList.remove('hidden');
        document.getElementById('status').classList.remove('hidden');
        document.getElementById('layers').classList.remove('hidden');
      }
    });
    
    document.getElementById('btnMotionPermission').addEventListener('click', requestMotionPermission);
    
    document.getElementById('btnComplexity').addEventListener('click', () => {
      state.forceEvolution = !state.forceEvolution;
      document.getElementById('btnComplexity').classList.toggle('active', state.forceEvolution);
    });
    
    document.getElementById('btnChaos').addEventListener('click', () => {
      state.chaosMode = !state.chaosMode;
      document.getElementById('btnChaos').classList.toggle('active', state.chaosMode);
    });
    
    // Initialize UI
    updateUI();
    updateRhythmDisplay();
  </script>
</body>
</html>
