<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Soundtrack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle, #001122 0%, #000 100%);
      color: #00ffaa;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      text-align: center;
    }
    
    .title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px #00ffaa;
      animation: pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { text-shadow: 0 0 20px #00ffaa; }
      to { text-shadow: 0 0 30px #00ffaa, 0 0 40px #00aa88; }
    }
    
    .btn {
      padding: 15px 30px;
      background: linear-gradient(45deg, #00ffaa, #00aa88);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 10px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,255,170,0.3);
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0,255,170,0.5);
    }
    
    .status {
      background: rgba(0,255,170,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 400px;
      backdrop-filter: blur(10px);
    }
    
    .motion-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,255,170,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .motion-progress {
      height: 100%;
      background: linear-gradient(90deg, #00ffaa, #00aa88);
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(0,255,170,0.5);
    }
    
    .rhythm-viz {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
    }
    
    .beat {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,255,170,0.3);
      transition: all 0.2s;
    }
    
    .beat.active {
      background: #00ffaa;
      box-shadow: 0 0 15px #00ffaa;
      transform: scale(1.4);
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="title">MOTION SOUNDTRACK</h1>
  <button class="btn" id="startBtn">START LISTENING</button>
  
  <div class="status hidden" id="status">
    <div>Motion: <span id="motionLevel">0</span>%</div>
    <div>State: <span id="currentState">Still</span></div>
    <div>Layers: <span id="layerCount">0</span>/4</div>
    <div class="motion-bar">
      <div class="motion-progress" id="progress"></div>
    </div>
    <div class="rhythm-viz" id="rhythm"></div>
  </div>

  <script>
    let motion = 0;
    let motionHistory = [];
    let step = 0;
    let synths = {};
    let lastMouseX = 0, lastMouseY = 0;
    
    document.getElementById('startBtn').onclick = async () => {
      await Tone.start();
      initAudio();
      startMotionTracking();
      
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
      
      updateUI();
    };
    
    function initAudio() {
      // Create synths
      synths.kick = new Tone.MembraneSynth().toDestination();
      synths.hihat = new Tone.NoiseSynth({ envelope: { decay: 0.05 } }).toDestination();
      synths.bass = new Tone.MonoSynth().toDestination();
      synths.pad = new Tone.PolySynth().toDestination();
      
      // Set volumes
      synths.kick.volume.value = -10;
      synths.hihat.volume.value = -20;
      synths.bass.volume.value = -12;
      synths.pad.volume.value = -18;
      
      Tone.Transport.bpm.value = 85;
      Tone.Transport.start();
      
      // Main sequencer - simple and direct
      Tone.Transport.scheduleRepeat((time) => {
        const currentStep = step % 16;
        const intensity = motion / 100;
        
        // Only play if there's motion
        if (intensity > 0.1) {
          playMotionMusic(currentStep, time, intensity);
        }
        
        updateRhythm(currentStep);
        step++;
      }, '16n');
    }
    
    function playMotionMusic(currentStep, time, intensity) {
      // Kick - motion creates rhythm
      if (intensity > 0.2 && (currentStep % 4 === 0 || (intensity > 0.6 && currentStep % 2 === 0))) {
        synths.kick.triggerAttackRelease('C1', '8n', time, intensity);
      }
      
      // Hi-hat - active motion creates texture
      if (intensity > 0.3 && currentStep % 2 === 1) {
        synths.hihat.triggerAttackRelease('16n', time, intensity * 0.8);
      }
      
      // Bass - sustained motion
      if (intensity > 0.4 && currentStep % 8 === 0) {
        const note = intensity > 0.7 ? 'A1' : 'E1';
        synths.bass.triggerAttackRelease(note, '4n', time, intensity);
      }
      
      // Pad - high energy moments
      if (intensity > 0.6 && currentStep % 16 === 0) {
        const chord = intensity > 0.8 ? ['A2', 'C3', 'E3', 'G3'] : ['A2', 'C3', 'E3'];
        synths.pad.triggerAttackRelease(chord, '1n', time, intensity * 0.6);
      }
    }
    
    function startMotionTracking() {
      // Try device motion first
      if (typeof DeviceMotionEvent !== 'undefined') {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().then(response => {
            if (response === 'granted') {
              window.addEventListener('devicemotion', handleMotion);
            } else {
              fallbackToMouse();
            }
          }).catch(() => fallbackToMouse());
        } else {
          window.addEventListener('devicemotion', handleMotion);
        }
      } else {
        fallbackToMouse();
      }
    }
    
    function fallbackToMouse() {
      // Desktop fallback - mouse movement
      document.addEventListener('mousemove', handleMouseMotion);
    }
    
    function handleMotion(event) {
      const acc = event.accelerationIncludingGravity;
      if (acc && acc.x !== null && acc.y !== null && acc.z !== null) {
        const total = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
        motion = Math.min(100, Math.max(0, (total - 9) * 10)); // Subtract gravity, scale
        smoothMotion();
      }
    }
    
    function handleMouseMotion(event) {
      const speed = Math.sqrt(
        Math.pow(event.clientX - lastMouseX, 2) + 
        Math.pow(event.clientY - lastMouseY, 2)
      );
      motion = Math.min(100, speed * 3);
      lastMouseX = event.clientX;
      lastMouseY = event.clientY;
      smoothMotion();
    }
    
    function smoothMotion() {
      motionHistory.push(motion);
      if (motionHistory.length > 5) {
        motionHistory.shift();
      }
      motion = motionHistory.reduce((a, b) => a + b) / motionHistory.length;
    }
    
    function updateUI() {
      document.getElementById('motionLevel').textContent = Math.round(motion);
      
      const state = 
        motion < 5 ? 'Still' :
        motion < 20 ? 'Gentle' :
        motion < 50 ? 'Active' :
        motion < 80 ? 'Energetic' : 'Intense';
      document.getElementById('currentState').textContent = state;
      
      const layers = Math.min(4, Math.floor(motion / 15));
      document.getElementById('layerCount').textContent = layers;
      document.getElementById('progress').style.width = motion + '%';
      
      requestAnimationFrame(updateUI);
    }
    
    function updateRhythm(currentStep) {
      const rhythm = document.getElementById('rhythm');
      rhythm.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const beat = document.createElement('div');
        beat.className = 'beat' + (i === currentStep ? ' active' : '');
        rhythm.appendChild(beat);
      }
    }
  </script>
</body>
</html>
