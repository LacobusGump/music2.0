<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GUMP: Grand Unified Music Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height:100%; margin:0; padding:0; background:#090d15; overflow:hidden;}
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif;}
    .intro {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:radial-gradient(ellipse at 60% 50%,#181e2f 0%,#090b12 80%);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:20; transition:opacity 1.1s;
    }
    .intro-title {
      font-size:2.6rem; font-weight:900; letter-spacing:2px;
      color:#e5f8ff; text-shadow:0 0 60px #7fdaff,0 4px 16px #000b;
      margin-bottom:2.2rem; opacity:.95;
      animation:introFade 2.7s cubic-bezier(.9,0,.1,1) alternate infinite;
    }
    .intro-author {
      font-size:1.18rem; color:#b3e3f9; opacity:.84; margin-bottom:2.6rem; letter-spacing:.7px;
    }
    .intro-btn {
      background:linear-gradient(85deg,#00cfff 25%,#ed9fe7 90%);
      color:#111; font-weight:700; font-size:1.21rem; padding:19px 52px;
      border-radius:40px; border:none; cursor:pointer; box-shadow:0 0 36px #59d4fd22;
      letter-spacing:1px; transition:transform 0.16s;
    }
    .intro-btn:active { transform:scale(0.98);}
    @keyframes introFade {
      from { text-shadow:0 0 16px #b2fff7; }
      to { text-shadow:0 0 68px #fff9,0 4px 20px #b4d7ff88;}
    }
    .app {position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1;opacity:0;transition:opacity 1.3s;}
    .orb-viz {
      width:80vw; max-width:360px; height:80vw; max-height:360px;
      margin:0 auto; position:relative; top:5vh;
      border-radius:50%; background:radial-gradient(circle at 44% 50%,#222a44 12%,#090c16 90%);
      box-shadow:0 0 90px 12px #334f9655,0 0 130px #02122e88 inset;
      border:2.5px solid #3e579c60;
      display:flex; align-items:center; justify-content:center;
      transition:all 2.5s cubic-bezier(0.4,0,0.2,1);
    }
    .orb-viz.void {
      background:radial-gradient(circle at 44% 50%,#4a3244 12%,#1a0f16 90%);
      box-shadow:0 0 140px 20px #9f5f8855,0 0 180px #2e1222aa inset;
      border:2.5px solid #8c5f9c80;
    }
    .music-orb {
      position:absolute; width:108px; height:108px; left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:radial-gradient(circle at 58% 41%,#17234a 0%,#b4cfff35 69%,#171d27 100%);
      border-radius:50%;
      box-shadow:0 0 100px #a8c8fa48,0 0 32px #b9fff888;
      z-index:2; 
      transition:all 2.8s cubic-bezier(0.25,0.8,0.25,1);
      animation:orbPulse 4.8s cubic-bezier(.65,0,.35,1) infinite alternate;
    }
    .music-orb.void {
      background:radial-gradient(circle at 52% 46%,#fff2ee 4%,#ecc4e7 30%,#c1c4fd 90%);
      box-shadow:0 0 200px #edbcff88,0 0 120px #fff8,0 0 300px #ff9fdd33;
      animation:voidPulse 6.2s cubic-bezier(.4,0,.6,1) infinite alternate;
      transform:translate(-50%,-50%) scale(1.08);
    }
    .orb-glow {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:320px; height:320px; border-radius:50%; z-index:1;
      background:radial-gradient(circle at 52% 48%,#6eacf933 1%,#bdf2ffa0 30%,#0b0f1800 98%);
      pointer-events:none; mix-blend-mode:lighten; opacity:.81;
      filter:blur(6px); 
      transition:all 2.5s cubic-bezier(0.4,0,0.2,1);
      animation:orbPulse 4.8s cubic-bezier(.65,0,.35,1) infinite alternate;
    }
    .orb-glow.void {
      background:radial-gradient(circle at 52% 48%,#f99aff55 1%,#ecc4e7aa 30%,#1a0f1600 98%);
      width:420px; height:420px; filter:blur(12px);
      animation:voidGlow 7.1s cubic-bezier(.3,0,.7,1) infinite alternate;
    }
    @keyframes orbPulse {from{opacity:.79;}to{opacity:.96;}}
    @keyframes voidPulse {from{opacity:.85;transform:translate(-50%,-50%) scale(1.08);}to{opacity:1;transform:translate(-50%,-50%) scale(1.12);}}
    @keyframes voidGlow {from{opacity:.6;}to{opacity:.95;}}
    .world-label {
      position:absolute; left:50%; top:93%; transform:translate(-50%,-50%);
      background:rgba(17,24,31,0.85); color:#e5f8ff; padding:12px 30px;
      border-radius:30px; font-size:1.18rem; letter-spacing:.6px;
      font-weight:600; opacity:0; pointer-events:none;
      box-shadow:0 8px 30px #0b0f1b36;
      transition:all 0.8s cubic-bezier(0.4,0,0.2,1);
      z-index:10; text-align:center;
    }
    .world-label.show { opacity:1; transform:translate(-50%,-50%) scale(1.02);}
    .world-label.void {
      background:rgba(42,24,41,0.9); color:#f9e5ff;
      box-shadow:0 8px 40px #3d1b3b66;
    }
    @media (max-width:500px) {
      .intro-title{font-size:1.4rem;}
      .world-label{font-size:1rem;}
      .orb-viz{top:2vh;}
    }
  </style>
</head>
<body>
  <div class="intro" id="intro">
    <div class="intro-title">GUMP: Grand Unified Music Project</div>
    <div class="intro-author">By James McCandless</div>
    <button class="intro-btn" id="begin">Begin</button>
  </div>
  <div class="app" id="app">
    <div class="orb-viz" id="orbViz">
      <div class="orb-glow" id="orbGlow"></div>
      <div class="music-orb" id="orb"></div>
      <div class="world-label" id="worldLabel"></div>
    </div>
  </div>
  <script>
  function lerp(a, b, t) { return a + (b - a) * t; }
  function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
  function rand(a,b){return a+Math.random()*(b-a);}
  function now(){return performance.now();}
  function fadeIn(el, ms=1000){el.style.transition=`opacity ${ms}ms`;el.style.opacity=1;}
  function fadeOut(el, ms=1000){el.style.transition=`opacity ${ms}ms`;el.style.opacity=0;}
  function capitalize(s){return s[0].toUpperCase()+s.slice(1);}
  function mod(n, m) { return ((n % m) + m) % m; }

  let ctx = null, started = false, allowMotion = false;
  let weather = {desc:"", temp:0, main:"Clear", day:true};
  let city = "Nowhere", region = "", country = "";
  let timeInfo = {hour:12, min:0, weekday:"Monday", month:"January", season:"Winter"};
  let motion = {moving:false, level:0, lastStep:0, steps:0};
  let geo = {lat:40.7, lon:-74, accuracy:300, lastCornerTime:0};
  let worldLabel = "", worldLabelEl, orbEl, orbVizEl, orbGlowEl;
  let voidMode = false, crossfader = 0, lastVoidSwitch = 0;
  let lastMovementTime = 0, intensity = 0;
  let gumpDNA = {}, mainGain, voidGain, oscs = [];
  let beat = 0, slowTick = 0, fastTick = 0;

  window.onload = ()=>{
    orbEl = document.getElementById('orb');
    orbVizEl = document.getElementById('orbViz');
    orbGlowEl = document.getElementById('orbGlow');
    worldLabelEl = document.getElementById('worldLabel');
    document.getElementById('begin').onclick = startGUMP;
  };

  function startGUMP(){
    fadeOut(document.getElementById('intro'),900);
    setTimeout(()=>{
      document.getElementById('intro').style.display='none';
      document.getElementById('app').style.opacity=1;
      setupWorld();
    },900);
  }

  async function setupWorld(){
    const dt = new Date();
    timeInfo.hour = dt.getHours(); timeInfo.min = dt.getMinutes();
    timeInfo.weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dt.getDay()];
    timeInfo.month = ["January","February","March","April","May","June","July","August","September","October","November","December"][dt.getMonth()];
    const m = dt.getMonth(); timeInfo.season = (m<2||m===11)?"Winter":(m<5)?"Spring":(m<8)?"Summer":"Fall";
    
    getLocationAndWeather();
    if(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission==="function"){
      DeviceMotionEvent.requestPermission().then(r=>{
        if(r==="granted") allowMotion=true;
      }).catch(()=>{});
    } else { allowMotion=true; }
    setupMotion();
    setTimeout(()=>initMusicEngine(),900);
  }

  function getLocationAndWeather(){
    if(!navigator.geolocation) { useDefaultLocation(); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      geo.lat = pos.coords.latitude; geo.lon = pos.coords.longitude;
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${geo.lat}&lon=${geo.lon}&zoom=10`)
        .then(r=>r.json()).then(data=>{
          city = data.address.city||data.address.town||data.address.village||"";
          region = data.address.state||data.address.county||"";
          country = data.address.country||"";
        }).catch(()=>{});
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current_weather=true`)
        .then(r=>r.json()).then(data=>{
          if(data.current_weather){
            weather.temp = data.current_weather.temperature;
            weather.main = decodeWeather(data.current_weather.weathercode);
            weather.desc = `${capitalize(weather.main)}`;
            weather.day = (data.current_weather.is_day===1);
          }
        }).catch(()=>{});
    }, useDefaultLocation, {enableHighAccuracy:true,timeout:6000});
  }

  function useDefaultLocation(){
    city="Jersey"; region="NJ"; country="USA";
    weather.temp=27; weather.main="Clear"; weather.day=true; weather.desc="Clear";
  }

  function decodeWeather(code){
    if(code<3) return "Clear";
    if(code<5) return "Cloudy";
    if(code<7) return "Fog";
    if(code<20) return "Drizzle";
    if(code<30) return "Rain";
    if(code<40) return "Snow";
    return "Clear";
  }

  function setupMotion(){
    window.addEventListener('devicemotion',e=>{
      if(!allowMotion) return;
      let acc = e.accelerationIncludingGravity;
      if(!acc) return;
      let lv = Math.sqrt(acc.x*acc.x+acc.y*acc.y+acc.z*acc.z);
      let t = now();
      if(lv>13 && t-motion.lastStep>350){
        motion.steps++; motion.lastStep=t; lastMovementTime=t; motion.moving=true;
        if(motion.steps>0 && motion.steps%16===0 && (t-geo.lastCornerTime>12000)){
          geo.lastCornerTime = t; triggerMoment("Journey");
        }
      }
      motion.level = lerp(motion.level, clamp(lv-9,0,20), 0.06);
      if(t-lastMovementTime>2000) motion.moving=false;
    });
  }

  function initMusicEngine(){
    if(ctx) return;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    
    mainGain = ctx.createGain();
    voidGain = ctx.createGain();
    mainGain.connect(ctx.destination);
    voidGain.connect(ctx.destination);
    mainGain.gain.value = 0.7;
    voidGain.gain.value = 0;
    
    gumpDNA = buildDNA();
    
    // Start ambient loops
    setTimeout(()=>{
      slowLoop(); // Every 3 seconds
      fastLoop(); // Every 800ms
    }, 600);
  }

  function buildDNA(){
    let dna = {};
    let roots = [220, 247, 262, 294, 330, 349, 392, 440];
    let hr = timeInfo.hour;
    let seasonOffset = {Winter:0,Spring:2,Summer:4,Fall:5}[timeInfo.season];
    dna.root = roots[mod(hr+seasonOffset,roots.length)];
    dna.scale = weather.day ? [0,2,4,7,9,11] : [0,2,3,5,7,8,10];
    dna.tempo = weather.main==="Rain"? 0.7 : weather.main==="Snow"? 0.5 : 
                weather.temp>25? 1.2 : weather.temp<10? 0.8 : 1.0;
    dna.warmth = weather.temp>20? 0.8 : weather.temp<5? 0.3 : 0.5;
    dna.clarity = weather.main==="Clear"? 0.9 : weather.main==="Fog"? 0.3 : 0.6;
    dna.label = [
      weather.day? (hr<12?"Morning":"Afternoon") : (hr<21?"Evening":"Night"),
      weather.main, `${Math.round(weather.temp*10)/10}°`, city
    ].filter(Boolean).join(" · ");
    return dna;
  }

  function updateVoidMode(){
    let t = now();
    let isMoving = motion.moving||motion.level>2;
    let targetVoid = !isMoving;
    
    if(targetVoid !== voidMode && t-lastVoidSwitch>1200){
      voidMode = targetVoid;
      lastVoidSwitch = t;
      
      orbVizEl.classList.toggle('void', voidMode);
      orbEl.classList.toggle('void', voidMode);
      orbGlowEl.classList.toggle('void', voidMode);
      worldLabelEl.classList.toggle('void', voidMode);
      
      let label = voidMode ? gumpDNA.label.replace(/Morning|Afternoon|Evening|Night/,"Stillness") : gumpDNA.label;
      showWorldLabel(label);
    }
    
    let target = voidMode ? 1 : 0;
    crossfader = lerp(crossfader, target, 0.02);
    
    if(mainGain && voidGain){
      mainGain.gain.value = (1-crossfader) * 0.6;
      voidGain.gain.value = crossfader * 0.4;
    }
  }

  function slowLoop(){
    updateVoidMode();
    let movement = motion.moving||motion.level>2;
    intensity = lerp(intensity, movement? 1 : 0, 0.03);
    
    if(!voidMode && slowTick%2===0){
      createAmbientPad();
    }
    
    if(voidMode && slowTick%3===0){
      createVoidTone();
    }
    
    slowTick++;
    setTimeout(slowLoop, 3000 * (1/gumpDNA.tempo));
  }

  function fastLoop(){
    cleanupOscs();
    
    if(!voidMode && intensity>0.1){
      if(fastTick%4===0) createRhythmPulse();
      if(fastTick%6===0) createMelodyNote();
    }
    
    if(voidMode && fastTick%8===0){
      createVoidEcho();
    }
    
    fastTick++;
    setTimeout(fastLoop, 800 * (1/gumpDNA.tempo));
  }

  function createAmbientPad(){
    let freq = gumpDNA.root * 0.5;
    let detune = rand(-8, 8);
    
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    let filter = ctx.createBiquadFilter();
    
    osc.type = 'sawtooth';
    osc.frequency.value = freq;
    osc.detune.value = detune;
    
    filter.type = 'lowpass';
    filter.frequency.value = 800 + gumpDNA.clarity * 400;
    filter.Q.value = 2;
    
    gain.gain.setValueAtTime(0, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.08 * gumpDNA.warmth, ctx.currentTime + 1.5);
    gain.gain.linearRampToValueAtTime(0.04 * gumpDNA.warmth, ctx.currentTime + 4);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 8);
    
    osc.connect(filter).connect(gain).connect(mainGain);
    osc.start();
    osc.stop(ctx.currentTime + 8);
    
    oscs.push({osc, gain, filter, stopTime: ctx.currentTime + 8});
  }

  function createRhythmPulse(){
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    
    osc.type = 'triangle';
    osc.frequency.value = gumpDNA.root * 0.25;
    
    gain.gain.setValueAtTime(0.15 * intensity, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    
    osc.connect(gain).connect(mainGain);
    osc.start();
    osc.stop(ctx.currentTime + 0.4);
    
    oscs.push({osc, gain, stopTime: ctx.currentTime + 0.4});
  }

  function createMelodyNote(){
    let note = gumpDNA.scale[mod(fastTick, gumpDNA.scale.length)];
    let freq = gumpDNA.root * Math.pow(2, note/12);
    
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    let filter = ctx.createBiquadFilter();
    
    osc.type = 'sine';
    osc.frequency.value = freq + rand(-2, 2);
    
    filter.type = 'bandpass';
    filter.frequency.value = freq * 2;
    filter.Q.value = 4;
    
    gain.gain.setValueAtTime(0.06 * intensity, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);
    
    osc.connect(filter).connect(gain).connect(mainGain);
    osc.start();
    osc.stop(ctx.currentTime + 1.2);
    
    oscs.push({osc, gain, filter, stopTime: ctx.currentTime + 1.2});
  }

  function createVoidTone(){
    let freq = gumpDNA.root * 0.33;
    
    for(let i=0; i<3; i++){
      let osc = ctx.createOscillator();
      let gain = ctx.createGain();
      let filter = ctx.createBiquadFilter();
      
      osc.type = 'triangle';
      osc.frequency.value = freq * (1 + i * 0.005);
      
      filter.type = 'lowpass';
      filter.frequency.value = 400 + Math.sin(now()*0.0008) * 100;
      filter.Q.value = 6;
      
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.04, ctx.currentTime + 2);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 12);
      
      osc.connect(filter).connect(gain).connect(voidGain);
      osc.start();
      osc.stop(ctx.currentTime + 12);
      
      oscs.push({osc, gain, filter, stopTime: ctx.currentTime + 12});
    }
  }

  function createVoidEcho(){
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    let delay = ctx.createDelay(0.5);
    let delayGain = ctx.createGain();
    
    osc.type = 'sine';
    osc.frequency.value = gumpDNA.root * 2.5 + rand(-8, 8);
    
    delay.delayTime.value = 0.3;
    delayGain.gain.value = 0.3;
    
    gain.gain.setValueAtTime(0.08, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
    
    osc.connect(gain);
    gain.connect(voidGain);
    gain.connect(delay);
    delay.connect(delayGain);
    delayGain.connect(voidGain);
    
    osc.start();
    osc.stop(ctx.currentTime + 2.5);
    
    oscs.push({osc, gain, delay, delayGain, stopTime: ctx.currentTime + 2.5});
  }

  function cleanupOscs(){
    let t = ctx.currentTime;
    oscs = oscs.filter(item => item.stopTime > t);
  }

  function triggerMoment(label){
    let osc = ctx.createOscillator();
    let gain = ctx.createGain();
    let filter = ctx.createBiquadFilter();
    
    osc.type = 'sine';
    osc.frequency.setValueAtTime(gumpDNA.root * 3, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(gumpDNA.root * 1.5, ctx.currentTime + 0.8);
    
    filter.type = 'bandpass';
    filter.frequency.value = gumpDNA.root * 4;
    filter.Q.value = 8;
    
    gain.gain.setValueAtTime(0.12, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);
    
    osc.connect(filter).connect(gain).connect(mainGain);
    osc.start();
    osc.stop(ctx.currentTime + 1.2);
    
    showWorldLabel(label+" · "+gumpDNA.label, 3000);
  }

  function showWorldLabel(str, dur=2500){
    if(worldLabel===str) return;
    worldLabel = str; worldLabelEl.textContent = str;
    worldLabelEl.classList.add('show');
    setTimeout(()=>{worldLabelEl.classList.remove('show');}, dur);
  }
  </script>
</body>
</html>
