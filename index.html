<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>LIVE ENVIRONMENTAL AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', monospace;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  position: fixed;
  touch-action: none;
}
#spatialGrid {
  position: fixed; inset: 0; pointer-events: none;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(0,255,255,0.06) 49px, rgba(0,255,255,0.06) 50px),
    repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(0,255,255,0.06) 49px, rgba(0,255,255,0.06) 50px);
  opacity: 0.3;
}
.audio-zone {
  position: absolute;
  border: 2px solid rgba(0,255,255,0.35);
  border-radius: 50%;
  pointer-events: none;
  transition: all 0.6s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  text-shadow: 0 0 10px #000;
  opacity: 0.5;
}
.audio-zone.active {
  border-color: #0ff;
  box-shadow: 0 0 50px rgba(0,255,255,0.8);
  opacity: 1;
  animation: pulse-zone 3s ease-in-out infinite;
}
.audio-zone.pulsing {
  animation: input-pulse 0.2s ease-out;
}
@keyframes pulse-zone { 0%,100% { transform: scale(1); } 50% { transform: scale(1.12); } }
@keyframes input-pulse { 0% { transform: scale(1); } 100% { transform: scale(1.25); } }
#userPosition {
  position: absolute;
  width: 36px; height: 36px;
  background: radial-gradient(circle, #f0f, #f0f 36%, transparent 70%);
  border: 2px solid #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 35px #f0f;
  z-index: 100; pointer-events: none;
}
#userPosition::before {
  content: ''; position: absolute; inset: -16px;
  border: 1px solid rgba(255,0,255,0.6);
  border-radius: 50%;
  animation: ripple 3.5s ease-out infinite;
}
@keyframes ripple { 0% { transform: scale(0.6); opacity: 1; } 100% { transform: scale(2.8); opacity: 0; } }
#startScreen {
  position: fixed; inset: 0;
  background: radial-gradient(circle at center, #001111 0%, #000 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  transition: opacity 1s ease;
}
#startScreen.hidden { opacity: 0; pointer-events: none; }
.start-title {
  font-size: 38px; font-weight: bold; margin-bottom: 16px;
  background: linear-gradient(90deg, #0ff, #f0f, #0ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: gradient-shift 6s ease infinite;
}
@keyframes gradient-shift { 0%,100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(50deg); } }
.start-subtitle { font-size: 16px; opacity: 0.85; text-align: center; margin-bottom: 60px; max-width: 360px; }
#startButton {
  padding: 24px 60px; font-size: 21px; font-weight: bold;
  background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 50px;
  color: #000; cursor: pointer; box-shadow: 0 0 50px rgba(0,255,255,0.8);
  transition: all 0.3s ease;
}
#startButton:active { transform: scale(0.93); }
.permission-status { margin-top: 50px; font-size: 14px; opacity: 0.7; text-align: center; }
.permission-item { margin: 8px 0; }
.permission-item.granted { color: #0f0; }
.permission-item.denied { color: #f88; }
#statusBar {
  position: fixed; top: 0; left: 0; right: 0; padding: 15px;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
  display: flex; justify-content: space-between; font-size: 12px; z-index: 50;
}
.status-group { display: flex; flex-direction: column; gap: 4px; }
.status-label { opacity: 0.6; font-size: 10px; }
.status-value { font-weight: bold; color: #0ff; }
#aiStatus {
  position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
  padding: 16px 32px; border-radius: 30px; border: 1px solid rgba(255,0,255,0.5);
  font-size: 15px; display: flex; align-items: center; gap: 16px;
  opacity: 0; transition: opacity 0.6s;
}
#aiStatus.visible { opacity: 1; }
.ai-indicator {
  width: 12px; height: 12px; background: #f0f; border-radius: 50%;
  animation: blink 1.5s ease-in-out infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
#musicInfo {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 22px; border-radius: 20px; border: 1px solid rgba(0,255,255,0.3);
  text-align: center; opacity: 0; transition: opacity 0.6s; max-width: 90%;
}
#musicInfo.visible { opacity: 1; }
.track-name { font-size: 20px; font-weight: bold; color: #0ff; margin-bottom: 8px; }
.track-details { font-size: 14px; opacity: 0.8; }
#controlPanel {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 20px; border-radius: 30px; border: 1px solid rgba(0,255,255,0.3);
  display: flex; gap: 24px;
}
.control-button {
  width: 60px; height: 60px; border-radius: 50%;
  border: 2px solid #0ff; background: rgba(0,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; cursor: pointer; transition: all 0.2s;
}
.control-button:active { transform: scale(0.87); background: rgba(0,255,255,0.3); }
.control-button.active { background: rgba(0,255,255,0.5); box-shadow: 0 0 35px rgba(0,255,255,0.9); }
.error-message {
  background: rgba(255,0,0,0.2); border: 1px solid #f88; padding: 18px;
  border-radius: 12px; margin-top: 30px; font-size: 14px; max-width: 300px;
}
</style>
</head>
<body>
<div id="spatialGrid"></div>
<div id="userPosition"></div>
<div id="audioZonesContainer"></div>

<div id="startScreen">
  <div class="start-title">LIVE ENVIRONMENTAL AI</div>
  <div class="start-subtitle">The world speaks live through your microphone. Move through invisible zones to transform ambient sounds into layered, evolving electronic alchemy—instantly.</div>
  <button id="startButton">TAP TO ENTER</button>
  <div class="permission-status">
    <div class="permission-item" id="motionStatus">◯ Motion</div>
    <div class="permission-item" id="orientationStatus">◯ Orientation</div>
    <div class="permission-item" id="micStatus">◯ Microphone</div>
  </div>
  <div class="error-message" id="errorMessage" style="display:none;"></div>
</div>

<div id="statusBar">
  <div class="status-group"><div class="status-label">POSITION</div><div class="status-value" id="positionDisplay">0, 0</div></div>
  <div class="status-group"><div class="status-label">LAYERS</div><div class="status-value" id="zonesDisplay">0/5</div></div>
  <div class="status-group"><div class="status-label">INPUT</div><div class="status-value" id="inputDisplay">0%</div></div>
</div>

<div id="aiStatus">
  <div class="ai-indicator"></div>
  <span id="aiStatusText">AI Breathing with the world...</span>
</div>

<div id="musicInfo">
  <div class="track-name" id="trackName">Silent Breath</div>
  <div class="track-details" id="trackDetails">Make sound near phone & move to transform</div>
</div>

<div id="controlPanel">
  <div class="control-button" id="calibrateBtn" title="Calibrate">⊙</div>
  <div class="control-button" id="toggleAudioBtn" class="active" title="Mute">♫</div>
  <div class="control-button" id="resetBtn" title="Reset">↻</div>
</div>

<script>
'use strict';

class LiveEnvironmentalAI {
  constructor() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.accel = { x: 0, y: 0 };
    this.calibration = { x: 0, y: 0 };

    this.zones = [];
    this.activeZones = new Set();

    this.permissions = { motion: false, orientation: false, mic: false };

    this.ui = {
      startScreen: document.getElementById('startScreen'),
      startButton: document.getElementById('startButton'),
      userPosition: document.getElementById('userPosition'),
      zonesContainer: document.getElementById('audioZonesContainer'),
      positionDisplay: document.getElementById('positionDisplay'),
      zonesDisplay: document.getElementById('zonesDisplay'),
      inputDisplay: document.getElementById('inputDisplay'),
      aiStatus: document.getElementById('aiStatus'),
      aiStatusText: document.getElementById('aiStatusText'),
      trackName: document.getElementById('trackName'),
      trackDetails: document.getElementById('trackDetails'),
      motionStatus: document.getElementById('motionStatus'),
      orientationStatus: document.getElementById('orientationStatus'),
      micStatus: document.getElementById('micStatus'),
      errorMessage: document.getElementById('errorMessage'),
      calibrateBtn: document.getElementById('calibrateBtn'),
      toggleAudioBtn: document.getElementById('toggleAudioBtn'),
      resetBtn: document.getElementById('resetBtn')
    };

    this.setupEvents();
  }

  setupEvents() {
    this.ui.startButton.addEventListener('click', () => this.initialize());
    this.ui.calibrateBtn.addEventListener('click', () => this.calibrate());
    this.ui.toggleAudioBtn.addEventListener('click', () => this.toggleMute());
    this.ui.resetBtn.addEventListener('click', () => this.resetPosition());
  }

  async initialize() {
    this.ui.startButton.disabled = true;
    this.ui.startButton.textContent = 'BREATHING IN...';

    try {
      await this.requestDevicePermissions();
      await Tone.start();
      await this.openMic();
      this.setupAudioChains();
      this.setupMotion();
      this.createZones();
      this.startExperience();
      this.ui.startScreen.classList.add('hidden');
    } catch (err) {
      console.error(err);
      this.showError(err.message || 'Failed. Use Safari & grant permissions.');
      this.ui.startButton.disabled = false;
      this.ui.startButton.textContent = 'TAP TO ENTER';
    }
  }

  async requestDevicePermissions() {
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
      const res = await DeviceMotionEvent.requestPermission();
      this.permissions.motion = res === 'granted';
    } else this.permissions.motion = true;
    this.updatePermUI('motion', this.permissions.motion);

    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      const res = await DeviceOrientationEvent.requestPermission();
      this.permissions.orientation = res === 'granted';
    } else this.permissions.orientation = true;
    this.updatePermUI('orientation', this.permissions.orientation);

    if (!this.permissions.motion) throw new Error('Motion required');
  }

  async openMic() {
    this.mic = new Tone.UserMedia();
    await this.mic.open();
    this.permissions.mic = true;
    this.updatePermUI('mic', true);

    this.meter = new Tone.Meter({ normalization: true });
    this.mic.connect(this.meter);
  }

  updatePermUI(type, granted) {
    const el = this.ui[`${type}Status`];
    el.textContent = granted ? '✓ ' : '✗ ';
    el.textContent += type.charAt(0).toUpperCase() + type.slice(1);
    el.className = 'permission-item ' + (granted ? 'granted' : 'denied');
  }

  setupAudioChains() {
    this.master = new Tone.Gain(0.7).toDestination();
    this.globalReverb = new Tone.Reverb({ decay: 8, wet: 0.4 }).connect(this.master);
    this.globalReverb.generate();
  }

  setupMotion() {
    window.addEventListener('devicemotion', e => {
      if (e.accelerationIncludingGravity) {
        this.accel.x = e.accelerationIncludingGravity.x || 0;
        this.accel.y = e.accelerationIncludingGravity.y || 0;
      }
    });
  }

  createZones() {
    const w = window.innerWidth, h = window.innerHeight;
    const names = ['Deep Abyss', 'Crystal Shards', 'Glitch Storm', 'Echo Void', 'Rhythmic Pulse'];

    const configs = [
      { x: w*0.25, y: h*0.3, size: 160, name: names[0] },
      { x: w*0.75, y: h*0.35, size: 150, name: names[1] },
      { x: w*0.5, y: h*0.65, size: 180, name: names[2] },
      { x: w*0.3, y: h*0.7, size: 130, name: names[3] },
      { x: w*0.7, y: h*0.75, size: 140, name: names[4] }
    ];

    configs.forEach((cfg, i) => {
      const zone = {
        id: i, x: cfg.x, y: cfg.y, size: cfg.size, name: cfg.name,
        element: null,
        gain: new Tone.Gain(0),
        panner: new Tone.Panner(0).connect(this.globalReverb),
        effects: null
      };

      // Unique effect chain per zone
      switch(i) {
        case 0: // Deep
          zone.effects = new Tone.Chain(
            new Tone.PitchShift(-12),
            new Tone.Filter(400, 'lowpass'),
            zone.gain, zone.panner
          );
          break;
        case 1: // Crystal
          zone.effects = new Tone.Chain(
            new Tone.PitchShift(12),
            new Tone.Chorus(4, 0.5, 0.5),
            zone.gain, zone.panner
          );
          break;
        case 2: // Glitch
          zone.effects = new Tone.Chain(
            new Tone.BitCrusher(4),
            new Tone.Distortion(0.4),
            new Tone.Tremolo(8, 0.6).start(),
            zone.gain, zone.panner
          );
          break;
        case 3: // Echo
          zone.effects = new Tone.Chain(
            new Tone.FeedbackDelay(0.4, 0.6),
            new Tone.Phaser({ frequency: 0.5, depth: 0.8 }),
            zone.gain, zone.panner
          );
          break;
        case 4: // Rhythmic
          zone.effects = new Tone.Chain(
            new Tone.AutoPanner(0.2).start(),
            new Tone.AutoFilter({ frequency: 0.1, depth: 0.8 }).start(),
            zone.gain, zone.panner
          );
          break;
      }

      // Visual
      zone.element = document.createElement('div');
      zone.element.className = 'audio-zone';
      zone.element.style.left = (cfg.x - cfg.size/2) + 'px';
      zone.element.style.top = (cfg.y - cfg.size/2) + 'px';
      zone.element.style.width = zone.element.style.height = cfg.size + 'px';
      zone.element.textContent = cfg.name;
      this.ui.zonesContainer.appendChild(zone.element);

      this.zones.push(zone);
    });

    // Fan mic to all chains
    this.mic.fan(...this.zones.map(z => z.effects));
  }

  startExperience() {
    this.ui.aiStatus.classList.add('visible');
    this.ui.musicInfo.classList.add('visible');
    requestAnimationFrame(() => this.updateLoop());
  }

  updateLoop() {
    this.updateMovement();
    this.updateZones();
    this.updateUI();
    requestAnimationFrame(() => this.updateLoop());
  }

  updateMovement() {
    const sens = 8, damp = 0.93;
    const ax = (this.accel.x - this.calibration.x) * sens;
    const ay = (this.accel.y - this.calibration.y) * sens;

    this.velocity.x += ax;
    this.velocity.y += ay;
    this.velocity.x *= damp;
    this.velocity.y *= damp;

    this.position.x += this.velocity.x;
    this.position.y += this.velocity.y;

    const margin = 80;
    if (this.position.x < margin) { this.position.x = margin; this.velocity.x *= -0.5; }
    if (this.position.x > window.innerWidth - margin) { this.position.x = window.innerWidth - margin; this.velocity.x *= -0.5; }
    if (this.position.y < margin) { this.position.y = margin; this.velocity.y *= -0.5; }
    if (this.position.y > window.innerHeight - margin) { this.position.y = window.innerHeight - margin; this.velocity.y *= -0.5; }

    this.ui.userPosition.style.left = this.position.x + 'px';
    this.ui.userPosition.style.top = this.position.y + 'px';
  }

  updateZones() {
    let activeCount = 0;
    const inputLevel = Math.max(0, this.meter.getValue() + 40) / 40; // 0-1
    const speed = Math.hypot(this.velocity.x, this.velocity.y);
    const energy = Math.min(speed * 6, 100) / 100;

    // Global modulation
    this.globalReverb.wet.rampTo(0.2 + energy * 0.6, 2);

    this.zones.forEach(zone => {
      const dx = this.position.x - zone.x;
      const dy = this.position.y - zone.y;
      const dist = Math.hypot(dx, dy);
      const proximity = Math.max(0, 1 - dist / (zone.size / 2));

      zone.panner.pan.rampTo((dx / window.innerWidth) * 2 - 1, 0.3);

      if (proximity > 0.05) {
        if (!this.activeZones.has(zone.id)) {
          this.activeZones.add(zone.id);
          zone.element.classList.add('active');
        }
        activeCount++;

        const targetGain = proximity * (0.3 + inputLevel * 0.8 + energy * 0.4);
        zone.gain.gain.rampTo(targetGain, 0.3);

        if (inputLevel > 0.2) zone.element.classList.add('pulsing');
        setTimeout(() => zone.element.classList.remove('pulsing'), 200);
      } else {
        if (this.activeZones.has(zone.id)) {
          this.activeZones.delete(zone.id);
          zone.element.classList.remove('active');
          zone.gain.gain.rampTo(0, 1);
        }
      }
    });

    this.ui.zonesDisplay.textContent = `${activeCount}/5`;
    this.ui.inputDisplay.textContent = `${Math.round(inputLevel * 100)}%`;
  }

  updateUI() {
    this.ui.positionDisplay.textContent = `${Math.round(this.position.x)}, ${Math.round(this.position.y)}`;

    const active = this.activeZones.size;
    const inputLevel = Math.max(0, this.meter.getValue() + 40) / 40;

    if (inputLevel < 0.05 && active === 0) {
      this.ui.aiStatusText.textContent = 'AI waiting for breath...';
      this.ui.trackName.textContent = 'Silent Void';
      this.ui.trackDetails.textContent = 'Make sound & move into zones';
    } else if (active < 2) {
      this.ui.aiStatusText.textContent = 'AI transforming first layer...';
      this.ui.trackName.textContent = 'Awakening Echo';
    } else if (active < 4) {
      this.ui.aiStatusText.textContent = 'AI layering realities...';
      this.ui.trackName.textContent = 'Fractured Harmony';
    } else {
      this.ui.aiStatusText.textContent = 'AI full immersion...';
      this.ui.trackName.textContent = 'Living Soundscape';
      this.ui.trackDetails.textContent = 'You are the composer';
    }
  }

  calibrate() {
    this.calibration.x = this.accel.x;
    this.calibration.y = this.accel.y;
    this.velocity = { x: 0, y: 0 };
    this.ui.calibrateBtn.classList.add('active');
    setTimeout(() => this.ui.calibrateBtn.classList.remove('active'), 300);
  }

  toggleMute() {
    if (this.master.gain.value > 0) {
      this.master.gain.rampTo(0, 0.6);
      this.ui.toggleAudioBtn.classList.remove('active');
    } else {
      this.master.gain.rampTo(0.7, 0.6);
      this.ui.toggleAudioBtn.classList.add('active');
    }
  }

  resetPosition() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.calibrate();
    this.ui.resetBtn.classList.add('active');
    setTimeout(() => this.ui.resetBtn.classList.remove('active'), 300);
  }

  showError(msg) {
    this.ui.errorMessage.textContent = '⚠️ ' + msg;
    this.ui.errorMessage.style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  window.app = new LiveEnvironmentalAI();
});
</script>
</body>
</html>
