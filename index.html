<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Soundtrack: Adaptive Music Evolution</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      height: 100vh;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    
    body.active {
      background: linear-gradient(135deg, #000 0%, #0f0f23 100%);
    }
    
    .container {
      text-align: center;
      z-index: 10;
      position: relative;
    }
    
    .title {
      font-size: 2.5rem;
      color: #00ff88;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(0,255,136,0.3);
      opacity: 1;
      transition: opacity 1s ease;
      font-weight: bold;
    }
    
    .title.hidden {
      opacity: 0;
    }
    
    .subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 2rem;
      opacity: 1;
      transition: opacity 1s ease;
    }
    
    .subtitle.hidden {
      opacity: 0;
    }
    
    .start-btn {
      padding: 15px 30px;
      font-size: 1.1rem;
      background: linear-gradient(45deg, #00ff88, #00cc6a);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,255,136,0.3);
    }
    
    .start-btn.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0);
    }
    
    .hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border-radius: 8px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      min-width: 280px;
    }
    
    .hud.visible {
      opacity: 1;
    }
    
    .hud-item {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .hud-label {
      color: rgba(255,255,255,0.8);
    }
    
    .hud-value {
      color: #00ff88;
      font-weight: bold;
    }
    
    .motion-grid {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border: 1px solid rgba(0,255,136,0.3);
      background: rgba(0,0,0,0.8);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .motion-grid.visible {
      opacity: 1;
    }
    
    .motion-dot {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #00ff88;
      border-radius: 50%;
      transition: all 0.1s ease;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
    }
    
    .waveform {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 300px;
      height: 80px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(0,255,136,0.3);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .waveform.visible {
      opacity: 1;
    }
    
    .evolution-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      text-align: center;
      min-width: 200px;
    }
    
    .evolution-display.visible {
      opacity: 1;
    }
    
    .layer-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin: 0 3px;
      background: rgba(0,255,136,0.3);
      transition: all 0.3s ease;
    }
    
    .layer-indicator.active {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.6);
    }
    
    .simulate-controls {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .simulate-controls.visible {
      opacity: 1;
    }
    
    .sim-btn {
      display: block;
      margin: 10px 0;
      padding: 8px 16px;
      background: rgba(0,255,136,0.1);
      color: #00ff88;
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    
    .sim-btn:hover {
      background: rgba(0,255,136,0.2);
    }
    
    .picardy-surge {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 1s ease;
    }
    
    .picardy-surge.active {
      opacity: 1;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">LIFE SOUNDTRACK</h1>
    <p class="subtitle">Adaptive Music Evolution Engine</p>
    <button class="start-btn" id="startBtn">Initialize</button>
  </div>
  
  <div class="hud" id="hud">
    <div class="hud-item">
      <span class="hud-label">Motion Intensity:</span>
      <span class="hud-value" id="motionIntensity">0.0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Activity State:</span>
      <span class="hud-value" id="activityState">Still</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Musical Layers:</span>
      <span class="hud-value" id="layerCount">1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Complexity:</span>
      <span class="hud-value" id="complexity">Basic</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Tempo:</span>
      <span class="hud-value" id="tempo">72 BPM</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Key:</span>
      <span class="hud-value" id="currentKey">A Minor</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Evolution:</span>
      <span class="hud-value" id="evolutionStage">Dormant</span>
    </div>
  </div>
  
  <div class="motion-grid" id="motionGrid">
    <div class="motion-dot" id="motionDot"></div>
  </div>
  
  <canvas class="waveform" id="waveform"></canvas>
  
  <div class="evolution-display" id="evolutionDisplay">
    <div style="margin-bottom: 10px; font-size: 0.9rem;">Active Layers</div>
    <div id="layerIndicators">
      <span class="layer-indicator" id="layer-drums"></span>
      <span class="layer-indicator" id="layer-ambient"></span>
      <span class="layer-indicator" id="layer-arpeggio"></span>
      <span class="layer-indicator" id="layer-strings"></span>
    </div>
  </div>
  
  <div class="simulate-controls" id="simulateControls">
    <button class="sim-btn" id="simWalk">Walk</button>
    <button class="sim-btn" id="simRun">Run</button>
    <button class="sim-btn" id="simDance">Dance</button>
    <button class="sim-btn" id="simStill">Still</button>
    <button class="sim-btn" id="triggerPicardy">Picardy</button>
  </div>
  
  <div class="picardy-surge" id="picardySurge"></div>

  <script>
    // Musical system
    const MUSICAL_SYSTEM = {
      keys: {
        'G_MAJOR': {
          name: 'G Major',
          scale: ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
          chords: {
            I: ['G3', 'B3', 'D4'],
            IV: ['C4', 'E4', 'G4'],
            vi: ['E4', 'G4', 'B4'],
            V: ['D4', 'F#4', 'A4'],
            picardy: ['E4', 'G#4', 'B4']
          }
        }
      },
      progressions: {
        dormant: ['I'],
        building: ['I', 'IV'],
        active: ['I', 'IV', 'vi', 'V'],
        dynamic: ['I', 'vi', 'IV', 'V'],
        resolution: ['I', 'IV', 'V', 'picardy']
      },
      rhythms: {
        still: [1, 0, 0, 0, 0, 0, 0, 0],
        walking: [1, 0, 1, 0, 1, 0, 1, 0],
        running: [1, 1, 0, 1, 1, 0, 1, 1],
        dancing: [1, 1, 1, 0, 1, 1, 0, 1]
      }
    };

    // Global state
    const state = {
      active: false,
      currentKey: MUSICAL_SYSTEM.keys.G_MAJOR,
      motionIntensity: 0,
      activityState: 'still',
      tempo: 80,
      stepCount: 0,
      accelerationBuffer: [],
      motionHistory: [],
      lastSignificantMotion: 0,
      lastStepTime: 0,
      lastShakeTime: 0,
      evolutionStage: 'dormant',
      activeLayers: new Set(['drums']),
      complexity: 0,
      progression: 'dormant',
      chordIndex: 0,
      audioInitialized: false,
      scheduledEvents: new Map(),
      beatCount: 0,
      measureCount: 0,
      location: null,
      weather: { temp: 20, wind: 10, clouds: 0, condition: 0 },
      weatherTime: 0
    };

    // Audio components
    let instruments = {};
    let effects = {};
    let drumPart, ambientPart, arpPart, stringPart;
    let analyser, canvas, ctx;

    // Initialize audio
    async function initAudio() {
      if (state.audioInitialized) return;
      try {
        await Tone.start();
        await Tone.context.resume();

        // Realistic drum samples
        instruments.drums = new Tone.Sampler({
          urls: {
            C2: 'https://freesound.org/data/previews/171/171104_71257-lq.mp3', // Kick
            D2: 'https://freesound.org/data/previews/171/171105_71257-lq.mp3', // Snare
            E2: 'https://freesound.org/data/previews/171/171102_71257-lq.mp3', // Hi-hat
            F2: 'https://freesound.org/data/previews/171/171103_71257-lq.mp3', // Tom
            G2: 'https://freesound.org/data/previews/171/171106_71257-lq.mp3'  // Crash
          },
          onload: () => console.log('Drum samples loaded')
        });

        // Warm orchestral sounds
        instruments.ambient = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sawtooth' },
          envelope: { attack: 1, decay: 2, sustain: 0.7, release: 3 },
          filter: { frequency: 600, type: 'lowpass', Q: 1 }
        });
        instruments.arpeggio = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'triangle', detune: 5 },
          envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.5 }
        });
        instruments.strings = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sawtooth' },
          envelope: { attack: 1.5, decay: 2, sustain: 0.8, release: 3 },
          filter: { frequency: 800, type: 'lowpass', Q: 1 }
        });

        // Effects
        effects.reverb = new Tone.Reverb({ decay: 4, wet: 0.3 });
        effects.filter = new Tone.Filter({ frequency: 1000, type: 'lowpass' });
        effects.compressor = new Tone.Compressor(-20, 3);
        analyser = new Tone.Analyser('waveform', 128);

        // Route audio
        instruments.drums.chain(effects.compressor, analyser, Tone.Destination);
        instruments.ambient.chain(effects.reverb, effects.filter, effects.compressor, analyser, Tone.Destination);
        instruments.arpeggio.chain(effects.reverb, effects.compressor, analyser, Tone.Destination);
        instruments.strings.chain(effects.reverb, effects.filter, effects.compressor, analyser, Tone.Destination);

        // Set volumes
        instruments.drums.volume.value = -4;
        instruments.ambient.volume.value = -Infinity;
        instruments.arpeggio.volume.value = -Infinity;
        instruments.strings.volume.value = -Infinity;

        // Define parts
        drumPart = new Tone.Part((time, value) => {
          if (value.kick) instruments.drums.triggerAttackRelease(value.kick, '8n', time, 1);
          if (value.snare) instruments.drums.triggerAttackRelease(value.snare, '8n', time, 0.8);
          if (value.hiHat) instruments.drums.triggerAttackRelease(value.hiHat, '16n', time, 0.6);
          if (value.tom) instruments.drums.triggerAttackRelease(value.tom, '8n', time, 0.7);
          if (value.crash) instruments.drums.triggerAttackRelease(value.crash, '4n', time, 0.9);
          if (value.kick || value.crash) addParticle(canvas.width / window.devicePixelRatio / 2, canvas.height / window.devicePixelRatio);
        }, [
          ['0:0:0', { kick: 'C2', snare: null, hiHat: null, tom: null, crash: null }],
          ['0:0:2', { kick: null, snare: 'D2', hiHat: null, tom: null, crash: null }],
          ['0:1:0', { kick: 'C2', snare: null, hiHat: null, tom: null, crash: null }],
          ['0:1:2', { kick: null, snare: null, hiHat: null, tom: 'F2', crash: null }]
        ]);
        drumPart.loop = true;
        drumPart.loopEnd = '1m';

        ambientPart = new Tone.Part((time, chord) => {
          instruments.ambient.triggerAttackRelease(chord, '2m', time);
        }, [[0, state.currentKey.chords[state.progression][state.chordIndex]]]);
        ambientPart.loop = true;
        ambientPart.loopEnd = '2m';

        arpPart = new Tone.Part((time, note) => {
          instruments.arpeggio.triggerAttackRelease(note, state.evolutionStage === 'dynamic' ? '16n' : '8n', time, 0.5);
          instruments.arpeggio.set({ pan: Math.random() * 0.4 - 0.2 });
        }, [
          ['0:0:0', state.currentKey.chords[state.progression][state.chordIndex][0]],
          ['0:0:1', state.currentKey.chords[state.progression][state.chordIndex][1]],
          ['0:0:2', state.currentKey.chords[state.progression][state.chordIndex][2]],
          ['0:0:3', state.currentKey.chords[state.progression][state.chordIndex][0]]
        ]);
        arpPart.loop = true;
        arpPart.loopEnd = '1n';

        stringPart = new Tone.Part((time, notes) => {
          instruments.strings.triggerAttackRelease(notes, '1m', time);
          instruments.strings.set({ pan: Math.random() * 0.4 - 0.2 });
        }, [[0, state.currentKey.chords[state.progression][state.chordIndex]]]);
        stringPart.loop = true;
        stringPart.loopEnd = '1m';

        state.audioInitialized = true;
        console.log('Audio system initialized, context state:', Tone.context.state);
      } catch (error) {
        console.error('Audio initialization failed:', error);
        alert('Failed to initialize audio. Please try again.');
      }
    }

    // Visualizer
    canvas = document.getElementById('waveform');
    ctx = canvas.getContext('2d');
    let particles = [];

    function drawVisualizer() {
      if (!state.active) return;
      canvas.width = canvas.clientWidth * window.devicePixelRatio;
      canvas.height = canvas.clientHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      const values = analyser.getValue();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'rgba(0,0,0,0.8)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.strokeStyle = '#00ff88';
      ctx.lineWidth = 2;
      for (let i = 0; i < values.length; i++) {
        const x = (i / values.length) * canvas.width / window.devicePixelRatio;
        const y = (1 - values[i]) * canvas.height / window.devicePixelRatio / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      particles = particles.filter(p => p.opacity > 0);
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(0,255,136,${p.opacity})`;
        ctx.fill();
        p.y -= p.speed;
        p.opacity -= 0.02;
      });
      requestAnimationFrame(drawVisualizer);
    }

    function addParticle(x, y) {
      particles.push({
        x, y, radius: 5 + Math.random() * 5,
        speed: 1 + Math.random(),
        opacity: 1
      });
    }

    // Get location
    async function getLocation() {
      if (state.location) return state.location;
      try {
        const pos = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) reject('Geolocation not supported');
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        state.location = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        return state.location;
      } catch (err) {
        console.error('Location error:', err);
        document.getElementById('motionIntensity').textContent = `Location error: ${err.message}`;
        return state.location;
      }
    }

    // Fetch weather
    async function getWeather(lat, lon) {
      if (state.weatherTime > Date.now() - 60000) return state.weather;
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,cloud_cover,weather_code`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Weather fetch failed');
        const data = await response.json();
        state.weather = {
          temp: data.current.temperature_2m,
          wind: data.current.wind_speed_10m,
          clouds: data.current.cloud_cover,
          condition: data.current.weather_code
        };
        state.weatherTime = Date.now();
        return state.weather;
      } catch (err) {
        console.error('Weather fetch failed:', err);
        document.getElementById('motionIntensity').textContent = `Weather error: ${err.message}`;
        return state.weather;
      }
    }

    // Apply environmental effects
    function applyEnvironmentalEffects() {
      const isRainy = [45, 48, 51, 53, 55, 56, 57, 61, 63, 65, 66, 67].includes(state.weather.condition);
      if (state.weather.clouds > 50 || isRainy) {
        state.progression = 'resolution';
        state.chordIndex = 3; // Picardy third
      }
      const tempShift = Math.round((state.weather.temp + 20) / 5);
      state.currentKey.chords = Object.fromEntries(
        Object.entries(MUSICAL_SYSTEM.keys.G_MAJOR.chords).map(([k, v]) => [
          k, v.map(note => Tone.Frequency(note).transpose(tempShift).toNote())
        ])
      );
      state.tempo = Math.max(80, Math.min(160, 80 + state.weather.wind / 5));
      Tone.Transport.bpm.rampTo(state.tempo, 1);
      effects.reverb.wet.value = isRainy ? 0.6 : 0.3;
    }

    // Motion processing
    function processMotion(event) {
      if (!state.active) return;
      const now = Date.now();
      if (now - state.lastSignificantMotion < 100) return;
      state.lastSignificantMotion = now;

      const accel = event.accelerationIncludingGravity || {};
      const x = Math.abs(accel.x || 0);
      const magnitude = Math.sqrt(
        Math.pow(accel.x || 0, 2) + 
        Math.pow(accel.y || 0, 2) + 
        Math.pow(accel.z || 0, 2)
      );

      state.accelerationBuffer.push(magnitude);
      if (state.accelerationBuffer.length > 20) state.accelerationBuffer.shift();
      state.motionIntensity = Math.min(5, state.accelerationBuffer.reduce((a, b) => a + b, 0) / state.accelerationBuffer.length / 3);

      state.motionHistory.push({ time: now, intensity: state.motionIntensity, raw: magnitude });
      if (state.motionHistory.length > 100) state.motionHistory.shift();

      // Detect step
      if (magnitude > 10 && now - state.lastStepTime > 300) {
        state.stepCount++;
        state.lastStepTime = now;
        state.recentSteps = (state.recentSteps || []).slice(-5).concat(now);
        if (state.recentSteps.length > 1) {
          const intervals = state.recentSteps.slice(1).map((t, i) => (t - state.recentSteps[i]) / 1000);
          const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          state.tempo = Math.max(80, Math.min(160, Math.round(60 / avgInterval)));
          Tone.Transport.bpm.rampTo(state.tempo, 0.5);
        }
        instruments.drums.triggerAttackRelease('C2', '8n', Tone.now(), 1);
        addParticle(canvas.width / window.devicePixelRatio / 2, canvas.height / window.devicePixelRatio);
        updateEvolutionStage();
      }

      // Detect shake
      if (magnitude > 12 && now - state.lastShakeTime > 1000) {
        state.lastShakeTime = now;
        state.chordIndex = (state.chordIndex + 1) % MUSICAL_SYSTEM.progressions[state.progression].length;
        instruments.drums.triggerAttackRelease('G2', '4n', Tone.now(), 0.9);
        addParticle(canvas.width / window.devicePixelRatio * Math.random(), canvas.height / window.devicePixelRatio);
        updateMusicalSequence();
      }

      // Tilt for hi-hats
      const hiHatCount = Math.floor((x / 10) * 8);
      effects.reverb.wet.value = (x / 10) * (0.8 - 0.3) + 0.3;

      updateMotionVisualizer(accel);
      updateUI();
    }

    // Update evolution stage
    function updateEvolutionStage() {
      const now = Date.now();
      const stepsNeeded = state.evolutionStage === 'dormant' ? 4 : 8;
      const timeNeeded = state.evolutionStage === 'dormant' ? 8000 : 16000;
      if (now - state.lastSignificantMotion < timeNeeded || state.stepCount < stepsNeeded) return;

      const oldStage = state.evolutionStage;
      if (state.motionIntensity < 0.5 && now - state.lastSignificantMotion > 5000) {
        state.evolutionStage = 'dormant';
        state.activeLayers = new Set(['drums']);
        instruments.ambient.volume.rampTo(-Infinity, 1);
        instruments.arpeggio.volume.rampTo(-Infinity, 1);
        instruments.strings.volume.rampTo(-Infinity, 1);
      } else if (state.motionIntensity < 2) {
        state.evolutionStage = 'building';
        state.activeLayers = new Set(['drums', 'ambient']);
        instruments.ambient.volume.rampTo(-8, 1);
        instruments.arpeggio.volume.rampTo(-Infinity, 1);
        instruments.strings.volume.rampTo(-Infinity, 1);
      } else {
        state.evolutionStage = 'dynamic';
        state.activeLayers = new Set(['drums', 'ambient', 'arpeggio', 'strings']);
        instruments.ambient.volume.rampTo(-8, 1);
        instruments.arpeggio.volume.rampTo(-12, 1);
        instruments.strings.volume.rampTo(-10, 1);
      }
      state.progression = state.evolutionStage;
      state.lastSignificantMotion = now;
      if (oldStage !== state.evolutionStage) {
        console.log(`Evolution: ${oldStage} → ${state.evolutionStage}`);
        updateMusicalSequence();
      }
    }

    // Update musical sequence
    function updateMusicalSequence() {
      const progression = MUSICAL_SYSTEM.progressions[state.progression];
      const currentChord = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[currentChord] || ['G3', 'B3', 'D4'];
      const isRainy = [45, 48, 51, 53, 55, 56, 57, 61, 63, 65, 66, 67].includes(state.weather.condition);
      const hiHatPattern = isRainy || state.motionIntensity > 1 ? ['E2', 'E2', 'E2', 'E2'] : ['E2', null, 'E2', null];
      const kickPattern = state.evolutionStage === 'dynamic' ? ['C2', 'C2', 'C2', 'C2'] : ['C2', null, 'C2', null];
      const snarePattern = state.evolutionStage === 'dynamic' ? ['D2', null, 'D2', null] : [null, 'D2', null, 'D2'];
      const tomPattern = state.evolutionStage === 'building' ? [null, null, null, 'F2'] : [null, null, null, null];

      if (state.activeLayers.has('drums')) {
        drumPart.events = [
          ['0:0:0', { kick: kickPattern[0], snare: snarePattern[0], hiHat: hiHatPattern[0], tom: tomPattern[0], crash: null }],
          ['0:0:2', { kick: kickPattern[1], snare: snarePattern[1], hiHat: hiHatPattern[1], tom: tomPattern[1], crash: null }],
          ['0:1:0', { kick: kickPattern[2], snare: snarePattern[2], hiHat: hiHatPattern[2], tom: tomPattern[2], crash: null }],
          ['0:1:2', { kick: kickPattern[3], snare: snarePattern[3], hiHat: hiHatPattern[3], tom: tomPattern[3], crash: null }]
        ];
      }
      if (state.activeLayers.has('ambient')) {
        ambientPart.events = [[0, chord]];
      }
      if (state.activeLayers.has('arpeggio')) {
        arpPart.events = [
          ['0:0:0', chord[0]],
          ['0:0:1', chord[1]],
          ['0:0:2', chord[2]],
          ['0:0:3', chord[0]]
        ];
      }
      if (state.activeLayers.has('strings')) {
        stringPart.events = [[0, chord]];
      }

      if (state.beatCount % 4 === 0) {
        state.chordIndex = (state.chordIndex + 1) % progression.length;
      }
      if (currentChord === 'picardy') triggerPicardyMoment();

      console.log('Sequence updated:', { stage: state.evolutionStage, chord: chord });
    }

    // Trigger Picardy third
    function triggerPicardyMoment() {
      const surge = document.getElementById('picardySurge');
      surge.classList.add('active');
      setTimeout(() => {
        instruments.strings.triggerAttackRelease(state.currentKey.chords.picardy, '1n', Tone.now());
        surge.classList.remove('active');
      }, 1000);
    }

    // Update motion visualizer
    function updateMotionVisualizer(accel) {
      const dot = document.getElementById('motionDot');
      if (accel.x !== undefined && accel.y !== undefined) {
        const x = Math.max(0, Math.min(116, 60 + (accel.x * 10)));
        const y = Math.max(0, Math.min(116, 60 + (accel.y * 10)));
        dot.style.left = `${x}px`;
        dot.style.top = `${y}px`;
        dot.style.transform = `scale(${Math.max(1, Math.min(3, state.motionIntensity))})`;
      }
    }

    // Update UI
    function updateUI() {
      document.getElementById('motionIntensity').textContent = state.motionIntensity.toFixed(1);
      document.getElementById('activityState').textContent = state.activityState.charAt(0).toUpperCase() + state.activityState.slice(1);
      document.getElementById('layerCount').textContent = state.activeLayers.size;
      document.getElementById('complexity').textContent = 
        state.complexity === 1 ? 'Basic' :
        state.complexity === 2 ? 'Simple' :
        state.complexity === 3 ? 'Medium' : 'Complex';
      document.getElementById('tempo').textContent = `${Math.round(state.tempo)} BPM`;
      document.getElementById('currentKey').textContent = state.currentKey.name;
      document.getElementById('evolutionStage').textContent = state.evolutionStage.charAt(0).toUpperCase() + state.evolutionStage.slice(1);

      ['drums', 'ambient', 'arpeggio', 'strings'].forEach(layer => {
        const indicator = document.getElementById(`layer-${layer}`);
        if (state.activeLayers.has(layer)) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      });
    }

    // Motion permission
    async function requestMotionPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission === 'granted') {
            window.addEventListener('devicemotion', processMotion);
            return true;
          }
        } catch (error) {
          console.error('Motion permission error:', error);
        }
      } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', processMotion);
        return true;
      }
      document.getElementById('simulateControls').classList.add('visible');
      return false;
    }

    // Simulation functions
    function simulateMotion(type) {
      const patterns = {
        still: { intensity: 0.2, variation: 0.1 },
        walk: { intensity: 1.2, variation: 0.3 },
        run: { intensity: 2.8, variation: 0.5 },
        dance: { intensity: 4.2, variation: 0.8 }
      };
      const pattern = patterns[type];
      const fakeEvent = {
        accelerationIncludingGravity: {
          x: (Math.random() - 0.5) * pattern.variation * 10,
          y: (Math.random() - 0.5) * pattern.variation * 10,
          z: pattern.intensity + (Math.random() - 0.5) * pattern.variation
        }
      };
      processMotion(fakeEvent);
    }

    // Check for no motion
    function checkNoMotion() {
      if (state.active && Date.now() - state.lastSignificantMotion > 5000) {
        instruments.drums.volume.rampTo(-Infinity, 2);
        instruments.ambient.volume.rampTo(-Infinity, 2);
        instruments.arpeggio.volume.rampTo(-Infinity, 2);
        instruments.strings.volume.rampTo(-Infinity, 2);
        setTimeout(() => {
          Tone.Transport.stop();
          drumPart.stop();
          ambientPart.stop();
          arpPart.stop();
          stringPart.stop();
          state.active = false;
          state.evolutionStage = 'dormant';
          state.activeLayers = new Set(['drums']);
          state.stepCount = 0;
          state.chordIndex = 0;
          particles = [];
          document.getElementById('motionIntensity').textContent = 'No motion. Tap Initialize.';
          document.getElementById('evolutionStage').textContent = 'Dormant';
          document.body.classList.remove('active');
          document.querySelector('.title').classList.remove('hidden');
          document.querySelector('.subtitle').classList.remove('hidden');
          document.querySelector('.start-btn').classList.remove('hidden');
          document.getElementById('hud').classList.remove('visible');
          document.getElementById('motionGrid').classList.remove('visible');
          document.getElementById('waveform').classList.remove('visible');
          document.getElementById('evolutionDisplay').classList.remove('visible');
        }, 2000);
      } else {
        setTimeout(checkNoMotion, 1000);
      }
    }

    // Update environment
    async function updateEnvironment() {
      if (!state.active) return;
      try {
        const { lat, lon } = await getLocation();
        const weather = await getWeather(lat, lon);
        applyEnvironmentalEffects();
        document.getElementById('motionIntensity').textContent = `Temp: ${weather.temp}°C, Wind: ${weather.wind} km/h`;
      } catch (err) {
        console.error('Environment update failed:', err);
      }
      setTimeout(updateEnvironment, 60000);
    }

    // Start experience
    async function startExperience() {
      if (state.active) return;
      state.active = true;
      try {
        await initAudio();
        const motionGranted = await requestMotionPermission();
        if (!motionGranted) document.getElementById('simulateControls').classList.add('visible');
        state.lastSignificantMotion = Date.now();
        state.lastStepTime = Date.now();

        // UI transitions
        document.body.classList.add('active');
        document.querySelector('.title').classList.add('hidden');
        document.querySelector('.subtitle').classList.add('hidden');
        document.querySelector('.start-btn').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('hud').classList.add('visible');
          document.getElementById('motionGrid').classList.add('visible');
          document.getElementById('waveform').classList.add('visible');
          document.getElementById('evolutionDisplay').classList.add('visible');
        }, 1000);

        // Start music
        drumPart.start(0);
        Tone.Transport.start();
        drawVisualizer();
        checkNoMotion();
        updateEnvironment();
        updateMusicalSequence();
      } catch (error) {
        console.error('Failed to start experience:', error);
        document.getElementById('motionIntensity').textContent = `Error: ${error.message}`;
      }
    }

    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startExperience);
    document.getElementById('simWalk').addEventListener('click', () => simulateMotion('walk'));
    document.getElementById('simRun').addEventListener('click', () => simulateMotion('run'));
    document.getElementById('simDance').addEventListener('click', () => simulateMotion('dance'));
    document.getElementById('simStill').addEventListener('click', () => simulateMotion('still'));
    document.getElementById('triggerPicardy').addEventListener('click', () => {
      state.progression = 'resolution';
      state.chordIndex = 3;
      updateMusicalSequence();
    });

    console.log('Life Soundtrack: Adaptive Music Evolution Engine initialized');
  </script>
</body>
</html>
