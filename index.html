<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMNI | Music 2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #030305;
            --accent: #00ffa3;
            --accent2: #7b61ff;
            --text: #fff;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #start {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            z-index: 100;
            background: var(--bg);
        }

        #start.hidden { display: none; }

        .title {
            font-size: 11px;
            letter-spacing: 6px;
            font-weight: 300;
            opacity: 0.5;
        }

        .subtitle {
            font-size: 24px;
            font-weight: 200;
            letter-spacing: 2px;
        }

        .start-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-family: inherit;
            font-size: 11px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.5s ease;
        }

        .start-btn:hover, .start-btn:active {
            background: var(--accent);
            color: var(--bg);
            box-shadow: 0 0 80px rgba(0, 255, 163, 0.3);
        }

        .hint {
            font-size: 10px;
            opacity: 0.3;
            max-width: 260px;
            text-align: center;
            line-height: 1.6;
        }

        #app {
            display: none;
            height: 100vh;
            width: 100vw;
        }

        #app.active { display: block; }

        canvas { position: fixed; inset: 0; width: 100%; height: 100%; }

        .hud {
            position: fixed;
            font-size: 9px;
            letter-spacing: 1px;
            opacity: 0.4;
            z-index: 10;
        }

        .hud-tl { top: 20px; left: 20px; }
        .hud-tr { top: 20px; right: 20px; text-align: right; }
        .hud-bl { bottom: 20px; left: 20px; }
        .hud-br { bottom: 20px; right: 20px; text-align: right; }

        .hud-value { font-size: 13px; font-weight: 300; opacity: 0.9; margin-top: 4px; }

        .chord-display {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: 200;
            letter-spacing: 6px;
            opacity: 0.5;
            z-index: 10;
        }
    </style>
</head>
<body>

<div id="start">
    <div class="title">OMNI</div>
    <div class="subtitle">Music 2.0</div>
    <button class="start-btn" id="startBtn">PLAY</button>
    <div class="hint">Move your phone through space to compose.<br>Tilt. Sweep. Rotate.<br>You are the conductor.</div>
</div>

<div id="app">
    <canvas id="viz"></canvas>
    <div class="hud hud-tl">
        <div>POSITION</div>
        <div class="hud-value" id="posVal">0, 0</div>
    </div>
    <div class="hud hud-tr">
        <div>ENERGY</div>
        <div class="hud-value" id="energyVal">0%</div>
    </div>
    <div class="hud hud-bl">
        <div>TEMPO</div>
        <div class="hud-value" id="tempoVal">72</div>
    </div>
    <div class="hud hud-br">
        <div>MODE</div>
        <div class="hud-value" id="modeVal">Ethereal</div>
    </div>
    <div class="chord-display" id="chordVal">Em7</div>
</div>

<script>
// ============================================================================
// OMNI MUSIC 2.0 - MOVEMENT TO MUSIC
// Inspired by Radiohead's In Rainbows
// Anyone becomes a composer through movement
// ============================================================================

// Chord progressions - In Rainbows DNA
const PROGRESSIONS = {
    ethereal: [
        { root: 64, type: 'min7', name: 'Em7' },
        { root: 66, type: 'min7', name: 'Fâ™¯m7' },
        { root: 69, type: 'maj7', name: 'Amaj7' },
        { root: 67, type: 'maj7', name: 'Gmaj7' }
    ],
    warm: [
        { root: 60, type: 'maj7', name: 'Cmaj7' },
        { root: 64, type: 'min7', name: 'Em7' },
        { root: 67, type: 'maj', name: 'G' },
        { root: 62, type: 'min7', name: 'Dm7' }
    ],
    melancholy: [
        { root: 69, type: 'min7', name: 'Am7' },
        { root: 65, type: 'maj7', name: 'Fmaj7' },
        { root: 60, type: 'maj', name: 'C' },
        { root: 67, type: 'maj', name: 'G' }
    ]
};

const VOICINGS = {
    maj: [0, 4, 7],
    min: [0, 3, 7],
    maj7: [0, 4, 7, 11],
    min7: [0, 3, 7, 10]
};

const SCALES = {
    aeolian: [0, 2, 3, 5, 7, 8, 10],
    dorian: [0, 2, 3, 5, 7, 9, 10],
    pentatonic: [0, 3, 5, 7, 10]
};

// State
const S = {
    progression: 'ethereal',
    chordIdx: 0,
    tempo: 72,
    energy: 0,
    brightness: 0.5,
    tiltX: 0,
    tiltY: 0,
    speed: 0,
    lastBeat: 0,
    beatNum: 0,
    lastArp: 0,
    arpIdx: 0
};

let ctx, master, reverb, delay, filter;
let bassOsc, bassOsc2, bassGain;
let running = false;

// ============================================================================
// AUDIO
// ============================================================================

function mtof(m) { return 440 * Math.pow(2, (m - 69) / 12); }

function getChord() {
    const prog = PROGRESSIONS[S.progression];
    const ch = prog[S.chordIdx];
    return VOICINGS[ch.type].map(i => ch.root + i);
}

async function initAudio() {
    ctx = new (window.AudioContext || window.webkitAudioContext)();

    // Reverb
    const revTime = 4;
    const revBuf = ctx.createBuffer(2, ctx.sampleRate * revTime, ctx.sampleRate);
    for (let c = 0; c < 2; c++) {
        const d = revBuf.getChannelData(c);
        for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * Math.exp(-3 * i / d.length);
    }
    const conv = ctx.createConvolver();
    conv.buffer = revBuf;

    const revGain = ctx.createGain();
    revGain.gain.value = 0.35;

    // Delay
    delay = ctx.createDelay(2);
    delay.delayTime.value = 0.375;
    const dlyFb = ctx.createGain();
    dlyFb.gain.value = 0.35;
    const dlyGain = ctx.createGain();
    dlyGain.gain.value = 0.2;
    delay.connect(dlyFb);
    dlyFb.connect(delay);
    delay.connect(dlyGain);

    // Filter
    filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 2500;
    filter.Q.value = 0.7;

    // Master
    master = ctx.createGain();
    master.gain.value = 0.8;

    // Routing
    master.connect(filter);
    filter.connect(ctx.destination);
    filter.connect(conv);
    conv.connect(revGain);
    revGain.connect(ctx.destination);
    filter.connect(delay);
    dlyGain.connect(ctx.destination);

    // Start bass drone
    startBass();
}

function startBass() {
    const ch = getChord();
    const freq = mtof(ch[0] - 24);

    bassOsc = ctx.createOscillator();
    bassOsc.type = 'sine';
    bassOsc.frequency.value = freq;

    bassOsc2 = ctx.createOscillator();
    bassOsc2.type = 'triangle';
    bassOsc2.frequency.value = freq * 2;

    bassGain = ctx.createGain();
    bassGain.gain.value = 0.3;

    const bassFilter = ctx.createBiquadFilter();
    bassFilter.type = 'lowpass';
    bassFilter.frequency.value = 150;

    bassOsc.connect(bassFilter);
    bassOsc2.connect(bassFilter);
    bassFilter.connect(bassGain);
    bassGain.connect(master);

    bassOsc.start();
    bassOsc2.start();
}

function playPad(notes, dur = 4) {
    const now = ctx.currentTime;
    notes.forEach(note => {
        const osc = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        const g = ctx.createGain();
        const f = ctx.createBiquadFilter();

        osc.type = 'sine';
        osc.frequency.value = mtof(note);
        osc2.type = 'triangle';
        osc2.frequency.value = mtof(note) * 1.002;

        f.type = 'lowpass';
        f.frequency.value = 600 + S.brightness * 2000;

        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.12, now + 1.5);
        g.gain.setValueAtTime(0.12, now + dur - 1.5);
        g.gain.linearRampToValueAtTime(0, now + dur);

        osc.connect(f);
        osc2.connect(f);
        f.connect(g);
        g.connect(master);

        osc.start(now);
        osc2.start(now);
        osc.stop(now + dur);
        osc2.stop(now + dur);
    });
}

function playArp(note, vel = 0.4) {
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();

    osc.type = S.brightness > 0.5 ? 'sawtooth' : 'triangle';
    osc.frequency.value = mtof(note);

    f.type = 'lowpass';
    f.frequency.value = 1000 + S.brightness * 4000;
    f.Q.value = 2;

    const rel = 0.3 + (1 - S.energy) * 0.4;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(vel * 0.25, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + rel);

    osc.connect(f);
    f.connect(g);
    g.connect(master);

    osc.start(now);
    osc.stop(now + rel);
}

function playShimmer(notes) {
    const note = notes[Math.floor(Math.random() * notes.length)] + 12;
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();

    osc.type = 'sine';
    osc.frequency.value = mtof(note);

    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.06, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);

    osc.connect(g);
    g.connect(master);

    osc.start(now);
    osc.stop(now + 1.2);
}

function playMelody(note) {
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();

    osc.type = 'sine';
    osc.frequency.value = mtof(note + 12);

    // Vibrato
    const vib = ctx.createOscillator();
    const vibG = ctx.createGain();
    vib.frequency.value = 5;
    vibG.gain.value = 2;
    vib.connect(vibG);
    vibG.connect(osc.frequency);

    f.type = 'lowpass';
    f.frequency.value = 3000;

    const dur = 0.4 + S.energy * 0.3;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.12, now + 0.03);
    g.gain.setValueAtTime(0.12, now + dur * 0.7);
    g.gain.linearRampToValueAtTime(0, now + dur);

    osc.connect(f);
    f.connect(g);
    g.connect(master);

    osc.start(now);
    vib.start(now);
    osc.stop(now + dur);
    vib.stop(now + dur);
}

// ============================================================================
// MOTION
// ============================================================================

async function initMotion() {
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            await DeviceMotionEvent.requestPermission();
        } catch (e) {}
    }

    window.addEventListener('devicemotion', e => {
        const a = e.accelerationIncludingGravity;
        if (!a) return;
        S.speed = S.speed * 0.9 + Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z) * 0.1;
        S.energy = Math.min(1, S.speed / 12);
    });

    window.addEventListener('deviceorientation', e => {
        S.tiltX = (e.gamma || 0) / 45;
        S.tiltY = (e.beta || 0) / 90;
        S.brightness = Math.max(0, Math.min(1, 0.3 + S.tiltY * 0.7));
        if (filter) filter.frequency.value = 400 + S.brightness * 5000;
    });

    // Mouse fallback
    document.addEventListener('mousemove', e => {
        S.tiltX = (e.clientX / window.innerWidth) * 2 - 1;
        S.tiltY = 1 - (e.clientY / window.innerHeight) * 2;
        S.brightness = Math.max(0, Math.min(1, 0.3 + S.tiltY * 0.5));
        S.energy = 0.3 + Math.abs(S.tiltX) * 0.3 + Math.abs(S.tiltY) * 0.3;
        if (filter) filter.frequency.value = 400 + S.brightness * 5000;
    });

    document.addEventListener('touchmove', e => {
        e.preventDefault();
        const t = e.touches[0];
        S.tiltX = (t.clientX / window.innerWidth) * 2 - 1;
        S.tiltY = 1 - (t.clientY / window.innerHeight) * 2;
        S.brightness = Math.max(0, Math.min(1, 0.3 + S.tiltY * 0.5));
        S.energy = 0.4 + Math.abs(S.tiltX) * 0.3 + Math.abs(S.tiltY) * 0.3;
        if (filter) filter.frequency.value = 400 + S.brightness * 5000;
    }, { passive: false });
}

// ============================================================================
// CONDUCTOR
// ============================================================================

function update() {
    if (!running) return;

    const now = ctx.currentTime;
    const beat = 60 / S.tempo;

    // Adapt tempo to energy
    S.tempo = S.tempo * 0.995 + (65 + S.energy * 50) * 0.005;

    // Sync delay to tempo
    delay.delayTime.value = beat * 0.75;

    // Beat
    if (now > S.lastBeat + beat) {
        S.lastBeat = now;
        S.beatNum++;
        onBeat();
    }

    // Arp (16th notes)
    if (now > S.lastArp + beat / 4) {
        S.lastArp = now;
        S.arpIdx++;
        onArp();
    }
}

function onBeat() {
    const prog = PROGRESSIONS[S.progression];

    // Change chord every 4 beats based on tilt
    if (S.beatNum % 4 === 0) {
        const newIdx = Math.floor((S.tiltX + 1) * 2) % 4;
        if (newIdx !== S.chordIdx) {
            S.chordIdx = newIdx;

            // Update bass
            const ch = getChord();
            const freq = mtof(ch[0] - 24);
            bassOsc.frequency.linearRampToValueAtTime(freq, ctx.currentTime + 0.5);
            bassOsc2.frequency.linearRampToValueAtTime(freq * 2, ctx.currentTime + 0.5);

            // New pad
            playPad(ch, beat * 8);
        }
    }

    // Melody on beats when energy high
    if (S.energy > 0.5 && Math.random() < S.energy * 0.4) {
        const scale = SCALES.pentatonic;
        const idx = Math.floor((S.tiltY + 1) * scale.length / 2);
        const rootMidi = PROGRESSIONS[S.progression][S.chordIdx].root;
        const note = rootMidi + scale[idx % scale.length];
        playMelody(note);
    }
}

function onArp() {
    if (S.energy < 0.15) return;

    const ch = getChord();
    const len = ch.length * 2;
    let idx = S.arpIdx % len;
    if (idx >= ch.length) idx = len - idx - 1;

    if (Math.random() < S.energy * 0.8) {
        playArp(ch[idx] + 12, 0.3 + S.energy * 0.3);
    }

    // Shimmer
    if (S.brightness > 0.55 && Math.random() < 0.12) {
        playShimmer(ch);
    }
}

// ============================================================================
// VISUALS
// ============================================================================

let vizCtx, particles = [];

function initViz() {
    const c = document.getElementById('viz');
    vizCtx = c.getContext('2d');
    resize();
    window.addEventListener('resize', resize);
}

function resize() {
    const c = document.getElementById('viz');
    c.width = window.innerWidth * devicePixelRatio;
    c.height = window.innerHeight * devicePixelRatio;
    vizCtx.scale(devicePixelRatio, devicePixelRatio);
}

function drawViz() {
    const w = window.innerWidth, h = window.innerHeight;
    const cx = w/2 + S.tiltX * w * 0.15;
    const cy = h/2 - S.tiltY * h * 0.15;

    vizCtx.fillStyle = `rgba(3,3,5,${0.08 + (1-S.energy)*0.08})`;
    vizCtx.fillRect(0, 0, w, h);

    // Particles
    if (S.energy > 0.1 && Math.random() < S.energy * 0.4) {
        const a = Math.random() * Math.PI * 2;
        particles.push({
            x: cx, y: cy,
            vx: Math.cos(a) * (1 + S.energy * 2),
            vy: Math.sin(a) * (1 + S.energy * 2),
            size: 2 + Math.random() * 3,
            life: 1,
            hue: 150 + S.chordIdx * 25
        });
    }

    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.98;
        p.vy *= 0.98;
        p.life -= 0.01;
        if (p.life <= 0) { particles.splice(i, 1); continue; }

        vizCtx.beginPath();
        vizCtx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        vizCtx.fillStyle = `hsla(${p.hue},60%,55%,${p.life * 0.5})`;
        vizCtx.fill();
    }
    while (particles.length > 180) particles.shift();

    // Glow
    const r = 40 + S.energy * 80;
    const g = vizCtx.createRadialGradient(cx, cy, 0, cx, cy, r);
    g.addColorStop(0, `rgba(0,255,163,${0.25 + S.energy * 0.25})`);
    g.addColorStop(0.6, `rgba(123,97,255,${0.1})`);
    g.addColorStop(1, 'rgba(0,0,0,0)');
    vizCtx.beginPath();
    vizCtx.arc(cx, cy, r, 0, Math.PI * 2);
    vizCtx.fillStyle = g;
    vizCtx.fill();

    // Ring
    vizCtx.beginPath();
    for (let i = 0; i < 60; i++) {
        const a = (i / 60) * Math.PI * 2;
        const wobble = Math.sin(Date.now() * 0.003 + i * 0.4) * S.energy * 8;
        const rr = 25 + S.energy * 20 + wobble;
        const x = cx + Math.cos(a) * rr;
        const y = cy + Math.sin(a) * rr;
        i === 0 ? vizCtx.moveTo(x, y) : vizCtx.lineTo(x, y);
    }
    vizCtx.closePath();
    vizCtx.strokeStyle = `rgba(255,255,255,${0.15 + S.energy * 0.15})`;
    vizCtx.stroke();
}

function updateUI() {
    const ch = PROGRESSIONS[S.progression][S.chordIdx];
    document.getElementById('chordVal').textContent = ch.name;
    document.getElementById('posVal').textContent = `${S.tiltX.toFixed(1)}, ${S.tiltY.toFixed(1)}`;
    document.getElementById('energyVal').textContent = Math.round(S.energy * 100) + '%';
    document.getElementById('tempoVal').textContent = Math.round(S.tempo);
    document.getElementById('modeVal').textContent = S.progression.charAt(0).toUpperCase() + S.progression.slice(1);
}

// ============================================================================
// LOOP
// ============================================================================

function loop() {
    if (!running) return;
    update();
    drawViz();
    updateUI();
    requestAnimationFrame(loop);
}

// ============================================================================
// START
// ============================================================================

async function start() {
    document.getElementById('start').classList.add('hidden');
    document.getElementById('app').classList.add('active');

    await initAudio();
    await initMotion();
    initViz();

    running = true;

    // Initial pad
    playPad(getChord(), 8);

    loop();
}

document.getElementById('startBtn').addEventListener('click', start);
</script>
</body>
</html>
