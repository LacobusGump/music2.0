<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Soundtrack: Adaptive Music Evolution</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      height: 100vh;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    
    body.active {
      background: linear-gradient(135deg, #000 0%, #0f0f23 100%);
    }
    
    .container {
      text-align: center;
      z-index: 10;
      position: relative;
    }
    
    .title {
      font-size: 2.5rem;
      color: #00ff88;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(0,255,136,0.3);
      opacity: 1;
      transition: opacity 1s ease;
      font-weight: bold;
    }
    
    .title.hidden {
      opacity: 0;
    }
    
    .subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 2rem;
      opacity: 1;
      transition: opacity 1s ease;
    }
    
    .subtitle.hidden {
      opacity: 0;
    }
    
    .start-btn {
      padding: 15px 30px;
      font-size: 1.1rem;
      background: linear-gradient(45deg, #00ff88, #00cc6a);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,255,136,0.3);
    }
    
    .start-btn.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0);
    }
    
    .hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border-radius: 8px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      min-width: 280px;
    }
    
    .hud.visible {
      opacity: 1;
    }
    
    .hud-item {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .hud-label {
      color: rgba(255,255,255,0.8);
    }
    
    .hud-value {
      color: #00ff88;
      font-weight: bold;
    }
    
    .motion-grid {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border: 1px solid rgba(0,255,136,0.3);
      background: rgba(0,0,0,0.8);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .motion-grid.visible {
      opacity: 1;
    }
    
    .motion-dot {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #00ff88;
      border-radius: 50%;
      transition: all 0.1s ease;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
    }
    
    .waveform {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 300px;
      height: 80px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(0,255,136,0.3);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .waveform.visible {
      opacity: 1;
    }
    
    .evolution-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      text-align: center;
      min-width: 200px;
    }
    
    .evolution-display.visible {
      opacity: 1;
    }
    
    .layer-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin: 0 3px;
      background: rgba(0,255,136,0.3);
      transition: all 0.3s ease;
    }
    
    .layer-indicator.active {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.6);
    }
    
    .simulate-controls {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .simulate-controls.visible {
      opacity: 1;
    }
    
    .sim-btn {
      display: block;
      margin: 10px 0;
      padding: 8px 16px;
      background: rgba(0,255,136,0.1);
      color: #00ff88;
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    
    .sim-btn:hover {
      background: rgba(0,255,136,0.2);
    }
    
    .picardy-surge {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 1s ease;
    }
    
    .picardy-surge.active {
      opacity: 1;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">LIFE SOUNDTRACK</h1>
    <p class="subtitle">Adaptive Music Evolution Engine</p>
    <button class="start-btn" id="startBtn">Initialize</button>
  </div>
  
  <div class="hud" id="hud">
    <div class="hud-item">
      <span class="hud-label">Motion Intensity:</span>
      <span class="hud-value" id="motionIntensity">0.0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Activity State:</span>
      <span class="hud-value" id="activityState">Still</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Musical Layers:</span>
      <span class="hud-value" id="layerCount">1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Complexity:</span>
      <span class="hud-value" id="complexity">Basic</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Tempo:</span>
      <span class="hud-value" id="tempo">72 BPM</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Key:</span>
      <span class="hud-value" id="currentKey">A Minor</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Evolution:</span>
      <span class="hud-value" id="evolutionStage">Dormant</span>
    </div>
  </div>
  
  <div class="motion-grid" id="motionGrid">
    <div class="motion-dot" id="motionDot"></div>
  </div>
  
  <canvas class="waveform" id="waveform"></canvas>
  
  <div class="evolution-display" id="evolutionDisplay">
    <div style="margin-bottom: 10px; font-size: 0.9rem;">Active Layers</div>
    <div id="layerIndicators">
      <span class="layer-indicator" id="layer-ambient"></span>
      <span class="layer-indicator" id="layer-bass"></span>
      <span class="layer-indicator" id="layer-drums"></span>
      <span class="layer-indicator" id="layer-harmony"></span>
      <span class="layer-indicator" id="layer-melody"></span>
      <span class="layer-indicator" id="layer-texture"></span>
    </div>
  </div>
  
  <div class="simulate-controls" id="simulateControls">
    <button class="sim-btn" id="simWalk">Walk</button>
    <button class="sim-btn" id="simRun">Run</button>
    <button class="sim-btn" id="simDance">Dance</button>
    <button class="sim-btn" id="simStill">Still</button>
    <button class="sim-btn" id="triggerPicardy">Picardy</button>
  </div>
  
  <div class="picardy-surge" id="picardySurge"></div>

  <script>
    // Advanced musical system
    const MUSICAL_SYSTEM = {
      keys: {
        'A_MINOR': {
          name: 'A Minor',
          scale: ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
          chords: {
            i: ['A3', 'C4', 'E4'],
            ii: ['B3', 'D4', 'F4'],
            III: ['C4', 'E4', 'G4'],
            iv: ['D4', 'F4', 'A4'],
            v: ['E4', 'G4', 'B4'],
            VI: ['F4', 'A4', 'C5'],
            VII: ['G4', 'B4', 'D5'],
            picardy: ['A3', 'C#4', 'E4']
          }
        }
      },
      progressions: {
        dormant: ['i'],
        contemplative: ['i', 'VI'],
        building: ['i', 'VI', 'III', 'VII'],
        active: ['i', 'iv', 'VI', 'v'],
        dynamic: ['i', 'VII', 'VI', 'III'],
        transcendent: ['i', 'iv', 'VII', 'VI'],
        resolution: ['i', 'iv', 'v', 'picardy']
      },
      rhythms: {
        ambient: [1, 0, 0, 0, 0, 0, 0, 0],
        slow: [1, 0, 0, 1, 0, 0, 1, 0],
        walking: [1, 0, 1, 0, 1, 0, 1, 0],
        active: [1, 0, 1, 1, 0, 1, 0, 1],
        running: [1, 1, 0, 1, 1, 0, 1, 1],
        dancing: [1, 1, 1, 0, 1, 1, 0, 1]
      }
    };
    
    // Global state
    const state = {
      active: false,
      currentKey: MUSICAL_SYSTEM.keys.A_MINOR,
      motionIntensity: 0,
      activityState: 'still',
      tempo: 72,
      
      // Motion tracking
      accelerationBuffer: [],
      motionHistory: [],
      lastSignificantMotion: 0,
      
      // Musical evolution
      evolutionStage: 'dormant',
      activeLayers: new Set(['ambient']),
      complexity: 0,
      progression: 'dormant',
      chordIndex: 0,
      
      // Audio components
      audioInitialized: false,
      scheduledEvents: new Map(),
      
      // Timing
      beatCount: 0,
      lastBeat: 0,
      measureCount: 0
    };
    
    // Audio instruments
    let instruments = {};
    let effects = {};
    let transport;
    
    // Initialize audio system
    async function initAudio() {
      if (state.audioInitialized) return;
      
      try {
        await Tone.start();
        
        // Create instruments
        instruments.ambient = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sine' },
          envelope: { attack: 3, decay: 2, sustain: 0.8, release: 4 }
        });
        
        instruments.bass = new Tone.MonoSynth({
          oscillator: { type: 'sawtooth' },
          envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 0.8 }
        });
        
        instruments.drums = new Tone.MembraneSynth({
          pitchDecay: 0.05,
          octaves: 10,
          oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        });
        
        instruments.harmony = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.5, decay: 0.8, sustain: 0.6, release: 2 }
        });
        
        instruments.melody = new Tone.Synth({
          oscillator: { type: 'square' },
          envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.8 }
        });
        
        instruments.texture = new Tone.NoiseSynth({
          noise: { type: 'pink' },
          envelope: { attack: 0.1, decay: 0.3, sustain: 0.1, release: 0.5 }
        });
        
        // Effects
        effects.reverb = new Tone.Reverb({ decay: 3, wet: 0.3 });
        effects.delay = new Tone.FeedbackDelay('8n', 0.2);
        effects.filter = new Tone.Filter({ frequency: 800, type: 'lowpass' });
        effects.compressor = new Tone.Compressor(-20, 3);
        
        // Route audio
        instruments.ambient.chain(effects.reverb, effects.compressor, Tone.Destination);
        instruments.bass.chain(effects.filter, effects.compressor, Tone.Destination);
        instruments.drums.chain(effects.compressor, Tone.Destination);
        instruments.harmony.chain(effects.reverb, effects.delay, effects.compressor, Tone.Destination);
        instruments.melody.chain(effects.delay, effects.compressor, Tone.Destination);
        instruments.texture.chain(effects.reverb, effects.compressor, Tone.Destination);
        
        // Set volumes
        instruments.ambient.volume.value = -20;
        instruments.bass.volume.value = -15;
        instruments.drums.volume.value = -18;
        instruments.harmony.volume.value = -22;
        instruments.melody.volume.value = -18;
        instruments.texture.volume.value = -25;
        
        // Start transport
        Tone.Transport.bpm.value = state.tempo;
        Tone.Transport.start();
        
        state.audioInitialized = true;
        console.log('Audio system initialized');
        
      } catch (error) {
        console.error('Audio initialization failed:', error);
      }
    }
    
    // Motion processing
    function processMotion(event) {
      if (!state.active) return;
      
      const accel = event.accelerationIncludingGravity || {};
      const magnitude = Math.sqrt(
        Math.pow(accel.x || 0, 2) + 
        Math.pow(accel.y || 0, 2) + 
        Math.pow(accel.z || 0, 2)
      );
      
      // Add to buffer
      state.accelerationBuffer.push(magnitude);
      if (state.accelerationBuffer.length > 20) {
        state.accelerationBuffer.shift();
      }
      
      // Calculate motion intensity
      const avgMotion = state.accelerationBuffer.reduce((a, b) => a + b, 0) / state.accelerationBuffer.length;
      state.motionIntensity = Math.min(5, avgMotion / 3);
      
      // Update motion history
      state.motionHistory.push({
        time: Date.now(),
        intensity: state.motionIntensity,
        raw: magnitude
      });
      
      if (state.motionHistory.length > 100) {
        state.motionHistory.shift();
      }
      
      // Determine activity state
      updateActivityState();
      
      // Update motion visualizer
      updateMotionVisualizer(accel);
      
      // Evolve music
      evolveMusic();
      
      // Update UI
      updateUI();
    }
    
    // Update activity state based on motion patterns
    function updateActivityState() {
      const recent = state.motionHistory.slice(-10);
      const avgIntensity = recent.reduce((sum, m) => sum + m.intensity, 0) / recent.length;
      
      if (avgIntensity < 0.5) {
        state.activityState = 'still';
      } else if (avgIntensity < 1.5) {
        state.activityState = 'walking';
      } else if (avgIntensity < 3) {
        state.activityState = 'active';
      } else if (avgIntensity < 4) {
        state.activityState = 'running';
      } else {
        state.activityState = 'dancing';
      }
    }
    
    // Evolve music based on motion and time
    function evolveMusic() {
      const now = Date.now();
      const timeSinceMotion = now - state.lastSignificantMotion;
      
      if (state.motionIntensity > 1) {
        state.lastSignificantMotion = now;
      }
      
      // Determine evolution stage
      const oldStage = state.evolutionStage;
      
      if (state.motionIntensity < 0.3 && timeSinceMotion > 5000) {
        state.evolutionStage = 'dormant';
        state.activeLayers = new Set(['ambient']);
      } else if (state.motionIntensity < 1) {
        state.evolutionStage = 'contemplative';
        state.activeLayers = new Set(['ambient', 'bass']);
      } else if (state.motionIntensity < 2) {
        state.evolutionStage = 'building';
        state.activeLayers = new Set(['ambient', 'bass', 'drums']);
      } else if (state.motionIntensity < 3) {
        state.evolutionStage = 'active';
        state.activeLayers = new Set(['ambient', 'bass', 'drums', 'harmony']);
      } else if (state.motionIntensity < 4) {
        state.evolutionStage = 'dynamic';
        state.activeLayers = new Set(['ambient', 'bass', 'drums', 'harmony', 'melody']);
      } else {
        state.evolutionStage = 'transcendent';
        state.activeLayers = new Set(['ambient', 'bass', 'drums', 'harmony', 'melody', 'texture']);
      }
      
      // Update progression
      state.progression = state.evolutionStage;
      
      // Update tempo based on activity
      const targetTempo = Math.max(60, Math.min(140, 72 + (state.motionIntensity * 15)));
      state.tempo = state.tempo + (targetTempo - state.tempo) * 0.1;
      
      if (state.audioInitialized) {
        Tone.Transport.bpm.rampTo(state.tempo, 2);
      }
      
      // Update complexity
      state.complexity = state.activeLayers.size;
      
      if (oldStage !== state.evolutionStage) {
        console.log(`Evolution: ${oldStage} â†’ ${state.evolutionStage}`);
      }
    }
    
    // Musical sequence player
    function playMusicalSequence() {
      if (!state.active || !state.audioInitialized) return;
      
      const progression = MUSICAL_SYSTEM.progressions[state.progression];
      const currentChord = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[currentChord];
      
      // Play active layers
      if (state.activeLayers.has('ambient')) {
        instruments.ambient.triggerAttackRelease(chord, '1n');
      }
      
      if (state.activeLayers.has('bass')) {
        const bassNote = Tone.Frequency(chord[0]).transpose(-12).toNote();
        instruments.bass.triggerAttackRelease(bassNote, '2n');
      }
      
      if (state.activeLayers.has('drums')) {
        const rhythm = MUSICAL_SYSTEM.rhythms[state.activityState] || MUSICAL_SYSTEM.rhythms.ambient;
        rhythm.forEach((hit, i) => {
          if (hit) {
            setTimeout(() => {
              instruments.drums.triggerAttackRelease('C2', '16n');
            }, i * (60000 / state.tempo / 8));
          }
        });
      }
      
      if (state.activeLayers.has('harmony')) {
        setTimeout(() => {
          instruments.harmony.triggerAttackRelease([chord[1], chord[2]], '4n');
        }, 200);
      }
      
      if (state.activeLayers.has('melody')) {
        const melodyNote = chord[Math.floor(Math.random() * chord.length)];
        setTimeout(() => {
          instruments.melody.triggerAttackRelease(melodyNote, '8n');
        }, 400);
      }
      
      if (state.activeLayers.has('texture')) {
        setTimeout(() => {
          instruments.texture.triggerAttackRelease('8n');
        }, 600);
      }
      
      // Special Picardy third handling
      if (currentChord === 'picardy') {
        triggerPicardyMoment();
      }
      
      // Advance progression
      state.chordIndex++;
      state.beatCount++;
      
      if (state.beatCount % 4 === 0) {
        state.measureCount++;
      }
      
      // Schedule next beat
      const nextBeat = (60 / state.tempo) * 1000;
      setTimeout(playMusicalSequence, nextBeat);
    }
    
    // Trigger Picardy third moment
    function triggerPicardyMoment() {
      const surge = document.getElementById('picardySurge');
      surge.classList.add('active');
      
      // Special harmony for Picardy
      setTimeout(() => {
        instruments.harmony.triggerAttackRelease(['C#4', 'E4', 'A4'], '1n');
      }, 100);
      
      setTimeout(() => {
        surge.classList.remove('active');
      }, 2000);
    }
    
    // Update motion visualizer
    function updateMotionVisualizer(accel) {
      const dot = document.getElementById('motionDot');
      const grid = document.getElementById('motionGrid');
      
      if (accel.x !== undefined && accel.y !== undefined) {
        const x = Math.max(0, Math.min(116, 60 + (accel.x * 10)));
        const y = Math.max(0, Math.min(116, 60 + (accel.y * 10)));
        
        dot.style.left = `${x}px`;
        dot.style.top = `${y}px`;
        
        // Scale dot based on intensity
        const scale = Math.max(1, Math.min(3, state.motionIntensity));
        dot.style.transform = `scale(${scale})`;
      }
    }
    
    // Update UI elements
    function updateUI() {
      document.getElementById('motionIntensity').textContent = state.motionIntensity.toFixed(1);
      document.getElementById('activityState').textContent = state.activityState.charAt(0).toUpperCase() + state.activityState.slice(1);
      document.getElementById('layerCount').textContent = state.activeLayers.size;
      document.getElementById('complexity').textContent = 
        state.complexity === 1 ? 'Basic' :
        state.complexity === 2 ? 'Simple' :
        state.complexity === 3 ? 'Medium' :
        state.complexity === 4 ? 'Complex' :
        state.complexity === 5 ? 'Rich' : 'Full';
      document.getElementById('tempo').textContent = `${Math.round(state.tempo)} BPM`;
      document.getElementById('currentKey').textContent = state.currentKey.name;
      document.getElementById('evolutionStage').textContent = state.evolutionStage.charAt(0).toUpperCase() + state.evolutionStage.slice(1);
      
      // Update layer indicators
      const layers = ['ambient', 'bass', 'drums', 'harmony', 'melody', 'texture'];
      layers.forEach(layer => {
        const indicator = document.getElementById(`layer-${layer}`);
        if (state.activeLayers.has(layer)) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      });
    }
    
    // Request device motion permission
    async function requestMotionPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission === 'granted') {
            window.addEventListener('devicemotion', processMotion);
            return true;
          }
        } catch (error) {
          console.error('Motion permission error:', error);
        }
      } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', processMotion);
        return true;
      }
      return false;
    }
    
    // Simulation functions
    function simulateMotion(type) {
      const patterns = {
        still: { intensity: 0.2, variation: 0.1 },
        walk: { intensity: 1.2, variation: 0.3 },
        run: { intensity: 2.8, variation: 0.5 },
        dance: { intensity: 4.2, variation: 0.8 }
      };
      
      const pattern = patterns[type];
      const fakeEvent = {
        accelerationIncludingGravity: {
          x: (Math.random() - 0.5) * pattern.variation * 10,
          y: (Math.random() - 0.5) * pattern.variation * 10,
          z: pattern.intensity + (Math.random() - 0.5) * pattern.variation
        }
      };
      
      processMotion(fakeEvent);
    }
    
    // Start the experience
    async function startExperience() {
      try {
        await initAudio();
        const motionGranted = await requestMotionPermission();
        
        if (!motionGranted) {
          document.getElementById('simulateControls').classList.add('visible');
        }
        
        state.active = true;
        state.lastSignificantMotion = Date.now();
        
        // UI transitions
        document.body.classList.add('active');
        document.querySelector('.title').classList.add('hidden');
        document.querySelector('.subtitle').classList.add('hidden');
        document.querySelector('.start-btn').classList.add('hidden');
        
        setTimeout(() => {
          document.getElementById('hud').classList.add('visible');
          document.getElementById('motionGrid').classList.add('visible');
          document.getElementById('waveform').classList.add('visible');
          document.getElementById('evolutionDisplay').classList.add('visible');
        }, 1000);
        
        // Start musical sequence
        setTimeout(() => {
          playMusicalSequence();
        }, 2000);
        
      } catch (error) {
        console.error('Failed to start experience:', error);
        alert('Failed to initialize. Please try again.');
      }
    }
    
    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startExperience);
    document.getElementById('simWalk').addEventListener('click', () => simulateMotion('walk'));
    document.getElementById('simRun').addEventListener('click', () => simulateMotion('run'));
    document.getElementById('simDance').addEventListener('click', () => simulateMotion('dance'));
    document.getElementById('simStill').addEventListener('click', () => simulateMotion('still'));
    document.getElementById('triggerPicardy').addEventListener('click', () => {
      state.progression = 'resolution';
      state.chordIndex = 3; // Jump to Picardy
    });
    
    console.log('Life Soundtrack: Adaptive Music Evolution Engine initialized');
