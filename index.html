<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Soundtrack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle, #001122 0%, #000 100%);
      color: #00ffaa;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      text-align: center;
    }
    
    .title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px #00ffaa;
      animation: pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { text-shadow: 0 0 20px #00ffaa; }
      to { text-shadow: 0 0 30px #00ffaa, 0 0 40px #00aa88; }
    }
    
    .btn {
      padding: 15px 30px;
      background: linear-gradient(45deg, #00ffaa, #00aa88);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 10px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,255,170,0.3);
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0,255,170,0.5);
    }
    
    .status {
      background: rgba(0,255,170,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 400px;
      backdrop-filter: blur(10px);
    }
    
    .motion-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,255,170,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .motion-progress {
      height: 100%;
      background: linear-gradient(90deg, #00ffaa, #00aa88);
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(0,255,170,0.5);
    }
    
    .rhythm-viz {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
    }
    
    .beat {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,255,170,0.3);
      transition: all 0.2s;
    }
    
    .beat.active {
      background: #00ffaa;
      box-shadow: 0 0 15px #00ffaa;
      transform: scale(1.4);
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="title">MOTION SOUNDTRACK</h1>
  <button class="btn" id="startBtn">START LISTENING</button>
  
  <div class="status hidden" id="status">
    <div>Motion: <span id="motionLevel">0</span>%</div>
    <div>State: <span id="currentState">Still</span></div>
    <div>Layers: <span id="layerCount">0</span>/4</div>
    <div class="motion-bar">
      <div class="motion-progress" id="progress"></div>
    </div>
    <div class="rhythm-viz" id="rhythm"></div>
  </div>

  <script>
    let state = {
      motion: 0,
      motionHistory: [],
      step: 0,
      barCount: 0,
      basePattern: null,
      isRecording: false,
      activeLayers: 0
    };
    
    let synths = {};
    let motionSamples = [];
    
    document.getElementById('startBtn').onclick = async () => {
      await Tone.start();
      initAudio();
      startMotionTracking();
      
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
      
      updateUI();
    };
    
    function initAudio() {
      // Simple synths
      synths.kick = new Tone.MembraneSynth().toDestination();
      synths.hihat = new Tone.NoiseSynth({ envelope: { decay: 0.05 } }).toDestination();
      synths.bass = new Tone.MonoSynth().toDestination();
      synths.pad = new Tone.PolySynth().toDestination();
      
      // Set volumes
      synths.kick.volume.value = -10;
      synths.hihat.volume.value = -20;
      synths.bass.volume.value = -12;
      synths.pad.volume.value = -18;
      
      Tone.Transport.bpm.value = 85;
      Tone.Transport.start();
      
      // Main sequencer
      Tone.Transport.scheduleRepeat((time) => {
        const step = state.step % 16;
        const bar = Math.floor(state.step / 16);
        
        // Record motion pattern for 4 bars when movement detected
        if (state.motion > 20 && !state.basePattern) {
          recordMotionPattern(step, time);
        }
        
        // Play based on current motion
        if (state.basePattern) {
          playMotionMusic(step, time);
        }
        
        if (step === 0) {
          state.barCount++;
          updateMotionLayers();
        }
        
        updateRhythm(step);
        state.step++;
      }, '16n');
    }
    
    function recordMotionPattern(step, time) {
      if (!state.isRecording) {
        state.isRecording = true;
        state.basePattern = [];
        motionSamples = [];
      }
      
      // Sample motion every step
      motionSamples.push(state.motion);
      
      // Create pattern from motion intensity
      const intensity = state.motion / 100;
      const events = [];
      
      // Motion creates kick pattern
      if (intensity > 0.3 && (step % 4 === 0 || (intensity > 0.7 && step % 2 === 0))) {
        events.push({ synth: 'kick', note: 'C1', duration: '8n' });
        synths.kick.triggerAttackRelease('C1', '8n', time);
      }
      
      // Motion creates hi-hat rhythm
      if (intensity > 0.5 && step % 2 === 1) {
        events.push({ synth: 'hihat', duration: '16n' });
        synths.hihat.triggerAttackRelease('16n', time);
      }
      
      state.basePattern[step] = { events, motion: intensity };
      
      // Stop recording after 4 bars (64 steps)
      if (state.step >= 64) {
        state.isRecording = false;
        normalizePattern();
      }
    }
    
    function normalizePattern() {
      // Normalize recorded pattern based on motion samples
      const maxMotion = Math.max(...motionSamples);
      state.basePattern.forEach(stepData => {
        if (stepData) {
          stepData.normalizedMotion = stepData.motion / maxMotion;
        }
      });
    }
    
    function playMotionMusic(step, time) {
      const stepData = state.basePattern[step];
      if (!stepData) return;
      
      const currentMotion = state.motion / 100;
      const patternMotion = stepData.normalizedMotion;
      
      // Only play if current motion matches or exceeds recorded motion
      if (currentMotion >= patternMotion * 0.7) {
        stepData.events.forEach(event => {
          const volume = Math.min(currentMotion, 1);
          if (event.synth === 'hihat') {
            synths[event.synth].triggerAttackRelease(event.duration, time, volume);
          } else {
            synths[event.synth].triggerAttackRelease(event.note, event.duration, time, volume);
          }
        });
        
        // Add layers based on motion intensity
        addMotionLayers(step, time, currentMotion);
      }
    }
    
    function addMotionLayers(step, time, intensity) {
      // Bass layer
      if (intensity > 0.4 && step % 8 === 0) {
        synths.bass.triggerAttackRelease('A1', '4n', time, intensity);
      }
      
      // Pad layer
      if (intensity > 0.6 && step % 16 === 0) {
        synths.pad.triggerAttackRelease(['A2', 'C3', 'E3'], '1n', time, intensity * 0.7);
      }
    }
    
    function updateMotionLayers() {
      const intensity = state.motion / 100;
      state.activeLayers = 0;
      
      if (intensity > 0.2) state.activeLayers++;
      if (intensity > 0.4) state.activeLayers++;
      if (intensity > 0.6) state.activeLayers++;
      if (intensity > 0.8) state.activeLayers++;
    }
    
    function startMotionTracking() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(response => {
          if (response === 'granted') {
            window.addEventListener('devicemotion', handleMotion);
          }
        });
      } else {
        window.addEventListener('devicemotion', handleMotion);
      }
      
      // Fallback: mouse movement for desktop
      window.addEventListener('mousemove', handleMouseMotion);
    }
    
    function handleMotion(event) {
      const acc = event.accelerationIncludingGravity;
      const total = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
      state.motion = Math.min(100, total * 8);
      
      // Add to history for smoothing
      state.motionHistory.push(state.motion);
      if (state.motionHistory.length > 10) {
        state.motionHistory.shift();
      }
      
      // Use smoothed motion
      state.motion = state.motionHistory.reduce((a, b) => a + b) / state.motionHistory.length;
    }
    
    function handleMouseMotion(event) {
      // Simulate motion with mouse for desktop testing
      const speed = Math.sqrt(event.movementX * event.movementX + event.movementY * event.movementY);
      state.motion = Math.min(100, speed * 2);
    }
    
    function updateUI() {
      document.getElementById('motionLevel').textContent = Math.round(state.motion);
      document.getElementById('currentState').textContent = 
        state.motion < 5 ? 'Still' :
        state.motion < 20 ? 'Gentle' :
        state.motion < 50 ? 'Active' :
        state.motion < 80 ? 'Energetic' : 'Intense';
      
      document.getElementById('layerCount').textContent = state.activeLayers;
      document.getElementById('progress').style.width = state.motion + '%';
      
      requestAnimationFrame(updateUI);
    }
    
    function updateRhythm(step) {
      const rhythm = document.getElementById('rhythm');
      rhythm.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const beat = document.createElement('div');
        beat.className = 'beat' + (i === step ? ' active' : '');
        rhythm.appendChild(beat);
      }
    }
  </script>
</body>
</html>
