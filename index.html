<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music 2.0: Cinematic Soundtrack</title>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: black; color: white; }
    #status { font-size: 0.9rem; opacity: 0.8; }
    canvas { margin-top: 1rem; width: 100%; max-width: 300px; height: 100px; }
    .retry-btn, .tempo-btn { display: none; }
    .particle { position: absolute; border-radius: 50%; pointer-events: none; box-shadow: 0 0 15px rgba(255, 255, 255, 0.7); }
  </style>
</head>
<body>
  <div id="ui" class="text-center p-4 max-w-md">
    <h1 class="text-3xl font-bold mb-4">Music 2.0: Your Soundtrack</h1>
    <p class="mb-4">Walk to drive the beat, tilt to shape the vibe, shake for drama. Allow motion!</p>
    <button id="startBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition">Start Music</button>
    <button id="testSoundBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition mt-2 retry-btn">Test Sound</button>
    <button id="retryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition mt-2 retry-btn">Retry Permissions</button>
    <button id="fasterBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition mt-2 tempo-btn">Faster</button>
    <button id="slowerBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition mt-2 tempo-btn">Slower</button>
    <div id="status" class="mt-4">Waiting to start...</div>
    <div id="tempoStatus" class="mt-2 text-sm">Tempo: 0 BPM</div>
    <div id="chordStatus" class="mt-2 text-sm">Chord: None</div>
    <div id="sectionStatus" class="mt-2 text-sm">Section: None</div>
    <canvas id="visualizer"></canvas>
  </div>

  <script>
    // State management
    const state = {
      isPlaying: false,
      stepBpm: 120,
      stepCount: 0,
      chordIndex: 0,
      lastStepTime: 0,
      lastShake: 0,
      lastMotionTime: 0,
      section: 'intro', // intro, build, climax
      lastSectionUpdate: 0,
      location: null,
      weather: { temp: 20, wind: 10, clouds: 0, condition: 0 },
      weatherTime: 0,
      vibe: 'upbeat',
      chords: [['G4', 'B4', 'D5'], ['C4', 'E4', 'G4'], ['A3', 'C4', 'E4'], ['G3', 'B3', 'D4']],
      shiftedChords: [['G4', 'B4', 'D5'], ['C4', 'E4', 'G4'], ['A3', 'C4', 'E4'], ['G3', 'B3', 'D4']],
      recentSteps: [] // For smoothing BPM
    };

    // DOM elements
    const startBtn = document.getElementById('startBtn');
    const testSoundBtn = document.getElementById('testSoundBtn');
    const retryBtn = document.getElementById('retryBtn');
    const fasterBtn = document.getElementById('fasterBtn');
    const slowerBtn = document.getElementById('slowerBtn');
    const statusDiv = document.getElementById('status');
    const tempoStatus = document.getElementById('tempoStatus');
    const chordStatus = document.getElementById('chordStatus');
    const sectionStatus = document.getElementById('sectionStatus');
    const ui = document.getElementById('ui');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    let particles = [];

    // Audio components
    let synth, arp, drums, strings, cymbal, gain, reverb, analyser, meter;
    let padPart, arpPart, drumPart, stringPart;

    // Initialize audio
    function initAudio() {
      synth = new Tone.PolySynth(Tone.Synth, { 
        oscillator: { type: 'sine' }, 
        envelope: { attack: 0.5, decay: 1, sustain: 0.7, release: 2 }
      });
      arp = new Tone.PolySynth(Tone.Synth, { 
        oscillator: { type: 'triangle' }, 
        envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.5 }
      });
      drums = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10 });
      strings = new Tone.PolySynth(Tone.Synth, { 
        oscillator: { type: 'sine' }, 
        envelope: { attack: 1, decay: 2, sustain: 0.8, release: 2 }
      });
      cymbal = new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 1, release: 2 } });
      gain = new Tone.Gain(1).toDestination();
      reverb = new Tone.Reverb({ decay: 4, wet: 0.3 });
      analyser = new Tone.Analyser('waveform', 128);
      meter = new Tone.Meter();
      synth.connect(gain);
      arp.connect(gain);
      drums.connect(gain);
      strings.connect(gain);
      cymbal.connect(gain);
      gain.connect(reverb).connect(meter).connect(analyser).toDestination();

      // Initial volumes
      synth.volume.value = -10;
      arp.volume.value = -15;
      drums.volume.value = -2;
      strings.volume.value = -12;
      cymbal.volume.value = -20;

      console.log('Audio initialized, context state:', Tone.context.state);

      // Define parts
      padPart = new Tone.Part((time, chord) => {
        synth.triggerAttackRelease(chord, '2m', time);
        console.log('Pad triggered:', chord, 'Level:', meter.getValue(), 'Transport:', Tone.Transport.position);
      }, [[0, state.shiftedChords[state.chordIndex]]]);
      padPart.loop = true;
      padPart.loopEnd = '2m';

      arpPart = new Tone.Part((time, note) => {
        arp.triggerAttackRelease(note, state.section === 'climax' ? '16n' : '8n', time, 0.5);
        arp.set({ pan: Math.random() * 0.4 - 0.2 });
        console.log('Arp note:', note, 'Level:', meter.getValue());
      }, [
        ['0:0:0', state.shiftedChords[state.chordIndex][0]],
        ['0:0:1', state.shiftedChords[state.chordIndex][1]],
        ['0:0:2', state.shiftedChords[state.chordIndex][2]],
        ['0:0:3', state.shiftedChords[state.chordIndex][0]]
      ]);
      arpPart.loop = true;
      arpPart.loopEnd = '1n';

      drumPart = new Tone.Part((time, value) => {
        if (value.kick) drums.triggerAttackRelease(value.kick, '8n', time, 1);
        if (value.snare) drums.triggerAttackRelease(value.snare, '8n', time, 0.8);
        if (value.hiHat) drums.triggerAttackRelease(value.hiHat, '16n', time, 0.6);
        console.log('Drum hit:', value, 'Level:', meter.getValue(), 'Transport:', Tone.Transport.position);
      }, [
        ['0:0:0', { kick: 'C2', snare: null, hiHat: null }],
        ['0:0:2', { kick: null, snare: 'C3', hiHat: null }],
        ['0:1:0', { kick: 'C2', snare: null, hiHat: null }],
        ['0:1:2', { kick: null, snare: 'C3', hiHat: null }]
      ]);
      drumPart.loop = true;
      drumPart.loopEnd = '1m';

      stringPart = new Tone.Part((time, notes) => {
        strings.triggerAttackRelease(notes, '1m', time);
        strings.set({ pan: Math.random() * 0.4 - 0.2 });
        console.log('String notes:', notes, 'Level:', meter.getValue());
      }, [[0, [state.shiftedChords[state.chordIndex][0].replace(/\d/, n => +n + 1)]]]);
      stringPart.loop = true;
      stringPart.loopEnd = '1m';
    }

    // Test sound
    function playTestSound() {
      const testSynth = new Tone.Synth().toDestination();
      testSynth.triggerAttackRelease('C4', '8n', Tone.now());
      console.log('Test sound triggered, context state:', Tone.context.state);
      statusDiv.textContent = 'Test sound played. If no sound, check device volume or retry.';
    }

    // Visualizer and particles
    function drawVisualizer() {
      if (!state.isPlaying) return;
      canvas.width = canvas.clientWidth * window.devicePixelRatio;
      canvas.height = canvas.clientHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      const values = analyser.getValue();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.strokeStyle = `hsl(${state.vibe === 'upbeat' ? 0 : 240}, 70%, 70%)`;
      ctx.lineWidth = 2;
      for (let i = 0; i < values.length; i++) {
        const x = (i / values.length) * canvas.width / window.devicePixelRatio;
        const y = (1 - values[i]) * canvas.height / window.devicePixelRatio / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      particles = particles.filter(p => p.opacity > 0);
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${p.color}, ${p.opacity})`;
        ctx.fill();
        p.y -= p.speed;
        p.opacity -= 0.02;
      });
      requestAnimationFrame(drawVisualizer);
    }

    function addParticle(x, y, vibe) {
      const colors = { dark: '0, 100, 255', bright: '255, 255, 100', upbeat: '255, 100, 100', mellow: '100, 255, 100' };
      particles.push({
        x, y, radius: 5 + Math.random() * 5,
        speed: 1 + Math.random(),
        opacity: 1,
        color: colors[vibe] || '255, 255, 255'
      });
    }

    // Get user location
    async function getLocation() {
      if (state.location) return state.location;
      try {
        const pos = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) reject('Geolocation not supported');
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        state.location = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        retryBtn.style.display = 'none';
        return state.location;
      } catch (err) {
        console.error('Location error:', err);
        statusDiv.textContent = `Location error: ${err.message}. Using fallback data.`;
        retryBtn.style.display = 'block';
        throw err;
      }
    }

    // Fetch weather
    async function getWeather(lat, lon) {
      if (state.weatherTime > Date.now() - 60000) return state.weather;
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,cloud_cover,weather_code`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Weather fetch failed');
        const data = await response.json();
        state.weather = {
          temp: data.current.temperature_2m,
          wind: data.current.wind_speed_10m,
          clouds: data.current.cloud_cover,
          condition: data.current.weather_code
        };
        state.weatherTime = Date.now();
        retryBtn.style.display = 'none';
        return state.weather;
      } catch (err) {
        console.error('Weather fetch failed:', err);
        statusDiv.textContent = `Weather error: ${err.message}. Using fallback data.`;
        retryBtn.style.display = 'block';
        return state.weather;
      }
    }

    // Get time-based vibe
    function getTimeParams() {
      const hour = new Date().getHours();
      if (hour < 6) return { 
        vibe: 'dark', 
        chords: [['C4', 'Eb4', 'G4'], ['F4', 'Ab4', 'C5'], ['Ab3', 'C4', 'Eb4'], ['G3', 'Bb3', 'D4']] // i-iv-bVI-v
      };
      if (hour < 12) return { 
        vibe: 'bright', 
        chords: [['C4', 'E4', 'G4'], ['F4', 'A4', 'C5'], ['A3', 'C4', 'E4'], ['G3', 'B3', 'D4']] // I-IV-vi-V
      };
      if (hour < 18) return { 
        vibe: 'upbeat', 
        chords: [['G4', 'B4', 'D5'], ['C4', 'E4', 'G4'], ['A3', 'C4', 'E4'], ['G3', 'B3', 'D4']] // I-IV-vi-V
      };
      return { 
        vibe: 'mellow', 
        chords: [['A4', 'C5', 'E5'], ['F4', 'A4', 'C5'], ['G4', 'B4', 'D5'], ['A4', 'C5', 'E5']] // i-bVI-bVII-i
      };
    }

    // Apply Picardy third
    function applyPicardyThird(chords, clouds, isRainy) {
      if (clouds > 50 || isRainy) {
        const lastChord = chords[chords.length - 1];
        if (lastChord[1].includes('b')) {
          lastChord[1] = lastChord[1].replace('b', '');
          console.log('Applied Picardy third');
        }
      }
      return chords;
    }

    // Fade out audio
    function fadeOutAudio() {
      synth.volume.rampTo(-Infinity, 2);
      arp.volume.rampTo(-Infinity, 2);
      drums.volume.rampTo(-Infinity, 2);
      strings.volume.rampTo(-Infinity, 2);
      cymbal.volume.rampTo(-Infinity, 2);
      setTimeout(() => {
        Tone.Transport.stop();
        padPart.stop();
        arpPart.stop();
        drumPart.stop();
        stringPart.stop();
        state.isPlaying = false;
        state.section = 'intro';
        state.stepCount = 0;
        state.chordIndex = 0;
        particles = [];
        statusDiv.textContent = 'No motion detected. Music stopped. Tap Start Music to begin again.';
        sectionStatus.textContent = 'Section: None';
        startBtn.textContent = 'Start Music';
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        ui.classList.remove('fade-to-black');
        console.log('Music faded out');
      }, 2000);
    }

    // Update section
    function updateSection() {
      const now = Date.now();
      if (now - state.lastSectionUpdate < 8000 && state.stepCount < 4) return;
      if (state.section === 'intro') {
        state.section = 'build';
        console.log('Section changed to build');
      } else if (state.section === 'build') {
        state.section = 'climax';
        console.log('Section changed to climax');
      }
      state.lastSectionUpdate = now;
      sectionStatus.textContent = `Section: ${state.section}`;
      updateParts();
    }

    // Handle device motion
    function handleMotion(event) {
      if (!state.isPlaying) return;
      const now = Date.now();
      if (now - state.lastMotionTime < 100) return;
      state.lastMotionTime = now;
      const gyro = event.rotationRate || {};
      const beta = Math.abs((gyro.beta || 0) / 180 * Math.PI);
      const gamma = Math.abs((gyro.gamma || 0) / 180 * Math.PI);
      const accel = event.accelerationIncludingGravity || {};
      const x = Math.abs(accel.x || 0);
      const totalAccel = Math.sqrt((accel.x || 0) ** 2 + (accel.y || 0) ** 2 + (accel.z || 0) ** 2);
      const sensitivity = 1;
      const { vibe } = getTimeParams();

      console.log('Motion detected:', { beta, gamma, totalAccel, x, permission: typeof DeviceMotionEvent.requestPermission === 'function' ? 'prompt' : 'granted' });

      // Tilt controls
      const drumVolume = (x / 10) * (0 - (-10)) - 10;
      const reverbWet = (x / 10) * (0.8 - 0.2) + 0.2;
      drums.volume.rampTo(drumVolume, 0.5);
      reverb.wet.rampTo(reverbWet, 0.5);
      synth.volume.value = -10;
      arp.volume.value = state.section === 'intro' ? -Infinity : -15;
      strings.volume.value = state.section !== 'climax' ? -Infinity : -12;
      cymbal.volume.value = -20;

      // Detect step
      if ((beta > 0.1 * sensitivity || gamma > 0.1 * sensitivity || totalAccel > 6 * sensitivity) && now - state.lastStepTime > 300) {
        state.recentSteps.push(now);
        state.recentSteps = state.recentSteps.slice(-5);
        if (state.recentSteps.length > 1) {
          const intervals = state.recentSteps.slice(1).map((t, i) => (t - state.recentSteps[i]) / 1000);
          const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          const newBpm = Math.round(60 / avgInterval);
          state.stepBpm = Math.max(80, Math.min(160, newBpm));
          Tone.Transport.bpm.rampTo(state.stepBpm, 0.5);
          tempoStatus.textContent = `Tempo: ${state.stepBpm} BPM`;
          console.log(`Step detected, BPM: ${state.stepBpm}, Step Count: ${state.stepCount + 1}`);
        }
        state.lastStepTime = now;
        state.stepCount++;
        addParticle(canvas.width / window.devicePixelRatio / 2, canvas.height / window.devicePixelRatio, vibe);
        drums.triggerAttackRelease('C2', '8n', Tone.now(), 1);
        updateSection();
      }

      // Detect shake
      if (totalAccel > 6 * sensitivity && now - state.lastShake > 1000) {
        state.lastShake = now;
        state.chordIndex = (state.chordIndex + 1) % 4;
        addParticle(canvas.width / window.devicePixelRatio * Math.random(), canvas.height / window.devicePixelRatio, vibe);
        cymbal.triggerAttackRelease('C6', '4n', Tone.now());
        console.log('Shake detected, chord changed to index:', state.chordIndex);
        updateParts();
      }
    }

    // Motion fallback
    function startMotionFallback() {
      setInterval(() => {
        if (!state.isPlaying || Date.now() - state.lastMotionTime < 5000) return;
        state.stepCount++;
        state.lastStepTime = Date.now();
        state.recentSteps.push(Date.now());
        state.recentSteps = state.recentSteps.slice(-5);
        state.stepBpm = 120; // Default BPM
        Tone.Transport.bpm.rampTo(state.stepBpm, 0.5);
        tempoStatus.textContent = `Tempo: ${state.stepBpm} BPM (Fallback)`;
        console.log(`Fallback step, Step Count: ${state.stepCount}`);
        addParticle(canvas.width / window.devicePixelRatio / 2, canvas.height / window.devicePixelRatio, state.vibe);
        drums.triggerAttackRelease('C2', '8n', Tone.now(), 1);
        updateSection();
      }, 1000);
    }

    // Check for no motion
    function checkNoMotion() {
      if (state.isPlaying && Date.now() - state.lastMotionTime > 5000) {
        fadeOutAudio();
      }
      setTimeout(checkNoMotion, 1000);
    }

    // Update parts
    function updateParts() {
      const { vibe } = getTimeParams();
      const chord = state.shiftedChords[state.chordIndex] || ['G4', 'B4', 'D5'];
      const arpSpeed = state.section === 'climax' ? '16n' : '8n';
      const kickPattern = state.section === 'climax' ? ['C2', 'C2', 'C2', 'C2'] : vibe === 'upbeat' ? ['C2', null, 'C2', null] : ['C2', null, null, null];
      const snarePattern = state.section === 'climax' ? ['C3', null, 'C3', null] : vibe === 'upbeat' ? [null, 'C3', null, 'C3'] : [null, null, 'C3', null];
      const hiHatPattern = state.weather.condition >= 45 ? ['C5', 'C5', 'C5', 'C5'] : [null, 'C5', null, 'C5'];

      padPart.events = [[0, chord]];
      arpPart.events = [
        ['0:0:0', chord[0] || 'G4'],
        ['0:0:1', chord[1] || 'B4'],
        ['0:0:2', chord[2] || 'D5'],
        ['0:0:3', chord[0] || 'G4']
      ];
      drumPart.events = [
        ['0:0:0', { kick: kickPattern[0], snare: snarePattern[0], hiHat: hiHatPattern[0] }],
        ['0:0:2', { kick: kickPattern[1], snare: snarePattern[1], hiHat: hiHatPattern[1] }],
        ['0:1:0', { kick: kickPattern[2], snare: snarePattern[2], hiHat: hiHatPattern[2] }],
        ['0:1:2', { kick: kickPattern[3], snare: snarePattern[3], hiHat: hiHatPattern[3] }]
      ];
      stringPart.events = state.section === 'climax' ? [[0, chord]] : [[0, [chord[0] || 'G4']]];
      
      // Auto-cycle chords
      if (Tone.Transport.getTicksAtTime(Tone.now()) / 192 - state.lastSectionUpdate / 1000 * state.stepBpm / 60 >= 16) {
        state.chordIndex = (state.chordIndex + 1) % 4;
        state.lastSectionUpdate = Date.now();
        console.log('Auto chord change to index:', state.chordIndex);
      }

      console.log('Parts updated, chord:', chord, 'section:', state.section);
    }

    // Main music loop
    async function generateMusic() {
      if (!state.isPlaying) return;
      try {
        const { lat, lon } = await getLocation();
        const weather = await getWeather(lat, lon);
        const { vibe, chords } = getTimeParams();
        state.vibe = vibe;
        state.chords = chords;
        const isRainy = [45, 48, 51, 53, 55, 56, 57, 61, 63, 65, 66, 67].includes(weather.condition);
        state.shiftedChords = applyPicardyThird(chords, weather.clouds, isRainy).map(chord => 
          chord.map(note => Tone.Frequency(note).transpose(Math.round((weather.temp + 20) / 5)).toNote())
        );
        chordStatus.textContent = `Chord: ${state.shiftedChords[state.chordIndex].join(', ')}`;
        Tone.Transport.bpm.rampTo(state.stepBpm + weather.wind / 5, 0.5);
        reverb.wet.value = isRainy ? 0.8 : weather.clouds / 200;
        updateParts();
        statusDiv.textContent = `Temp: ${weather.temp}°C, Wind: ${weather.wind} km/h, Clouds: ${weather.clouds}%, Vibe: ${vibe}`;
      } catch (err) {
        console.error('Error:', err);
        statusDiv.textContent = `Error: ${err.message}. Using fallback data.`;
        Tone.Transport.bpm.rampTo(state.stepBpm, 0.5);
        updateParts();
      }

      setTimeout(generateMusic, 4000);
    }

    // Start music
    startBtn.addEventListener('click', async () => {
      if (state.isPlaying) return;
      state.isPlaying = true;
      try {
        await Tone.context.resume();
        console.log('Audio context resumed, state:', Tone.context.state);
        await Tone.start();
        console.log('Tone.js started');
        initAudio();
        padPart.start(0);
        arpPart.start(0);
        drumPart.start(0);
        stringPart.start(0);
        Tone.Transport.start();
        ui.classList.add('fade-to-black');
        startBtn.textContent = 'Playing...';
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        testSoundBtn.style.display = 'block';
        fasterBtn.style.display = 'block';
        slowerBtn.style.display = 'block';
        drawVisualizer();
        state.stepCount = 0;
        state.section = 'intro';
        state.lastSectionUpdate = Date.now();
        state.lastMotionTime = Date.now();
        sectionStatus.textContent = `Section: ${state.section}`;
        checkNoMotion();
        startMotionFallback();

        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission === 'granted') {
              window.addEventListener('devicemotion', handleMotion);
              console.log('Motion permission granted');
            } else {
              statusDiv.textContent += ' Motion denied. Use Faster/Slower buttons or retry.';
              retryBtn.style.display = 'block';
              console.error('Motion permission denied');
            }
          } catch (err) {
            statusDiv.textContent += ' Motion permission error. Use Faster/Slower buttons or retry.';
            retryBtn.style.display = 'block';
            console.error('Motion permission error:', err);
          }
        } else {
          window.addEventListener('devicemotion', handleMotion);
          console.log('Motion listener added, sensor support:', !!window.DeviceMotionEvent);
        }

        generateMusic();
      } catch (err) {
        console.error('Audio startup error:', err);
        statusDiv.textContent = `Audio error: ${err.message}. Try Test Sound or Retry Permissions.`;
        testSoundBtn.style.display = 'block';
        retryBtn.style.display = 'block';
      }
    });

    testSoundBtn.addEventListener('click', async () => {
      try {
        await Tone.context.resume();
        console.log('Test sound: Audio context resumed, state:', Tone.context.state);
        playTestSound();
      } catch (err) {
        console.error('Test sound error:', err);
        statusDiv.textContent = `Test sound failed: ${err.message}. Check device volume or retry.`;
      }
    });

    retryBtn.addEventListener('click', async () => {
      state.location = null;
      state.weatherTime = 0;
      retryBtn.style.display = 'none';
      await generateMusic();
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const permission = await DeviceMotionEvent.requestPermission();
          if (permission === 'granted') {
            window.addEventListener('devicemotion', handleMotion);
            console.log('Motion permission granted on retry');
          } else {
            statusDiv.textContent += ' Motion denied. Use Faster/Slower buttons.';
            retryBtn.style.display = 'block';
          }
        } catch (err) {
          statusDiv.textContent += ' Motion permission error.';
          retryBtn.style.display = 'block';
          console.error('Motion permission error on retry:', err);
        }
      }
    });

    fasterBtn.addEventListener('click', () => {
      state.stepBpm = Math.min(160, state.stepBpm + 10);
      Tone.Transport.bpm.rampTo(state.stepBpm, 0.5);
      tempoStatus.textContent = `Tempo: ${state.stepBpm} BPM`;
      state.lastMotionTime = Date.now();
      console.log('Tempo increased:', state.stepBpm);
      state.stepCount++;
      updateSection();
    });

    slowerBtn.addEventListener('click', () => {
      state.stepBpm = Math.max(80, state.stepBpm - 10);
      Tone.Transport.bpm.rampTo(state.stepBpm, 0.5);
      tempoStatus.textContent = `Tempo: ${state.stepBpm} BPM`;
      state.lastMotionTime = Date.now();
      console.log('Tempo decreased:', state.stepBpm);
      state.stepCount++;
      updateSection();
    });
  </script>
</body>
</html>
