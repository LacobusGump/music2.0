<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Soundtrack: Adaptive Music Evolution</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      height: 100vh;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    
    body.active {
      background: linear-gradient(135deg, #000 0%, #0f0f23 100%);
    }
    
    .container {
      text-align: center;
      z-index: 10;
      position: relative;
    }
    
    .title {
      font-size: 2.5rem;
      color: #00ff88;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(0,255,136,0.3);
      opacity: 1;
      transition: opacity 1s ease;
      font-weight: bold;
    }
    
    .title.hidden {
      opacity: 0;
    }
    
    .subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 2rem;
      opacity: 1;
      transition: opacity 1s ease;
    }
    
    .subtitle.hidden {
      opacity: 0;
    }
    
    .start-btn {
      padding: 15px 30px;
      font-size: 1.1rem;
      background: linear-gradient(45deg, #00ff88, #00cc6a);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,255,136,0.3);
    }
    
    .start-btn.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0);
    }
    
    .hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      border-radius: 8px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      min-width: 280px;
    }
    
    .hud.visible {
      opacity: 1;
    }
    
    .hud-item {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .hud-label {
      color: rgba(255,255,255,0.8);
    }
    
    .hud-value {
      color: #00ff88;
      font-weight: bold;
    }
    
    .motion-grid {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border: 1px solid rgba(0,255,136,0.3);
      background: rgba(0,0,0,0.8);
      opacity: 0;
      transition: opacity 1s ease;
      border-radius: 4px;
    }
    
    .motion-grid.visible {
      opacity: 1;
    }
    
    .motion-dot {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #00ff88;
      border-radius: 50%;
      transition: all 0.1s ease;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
    }
    
    .waveform {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 300px;
      height: 80px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(0,255,136,0.3);
      opacity: 0;
      transition: opacity 1s ease;
      border-radius: 4px;
    }
    
    .waveform.visible {
      opacity: 1;
    }
    
    .evolution-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      text-align: center;
      min-width: 200px;
    }
    
    .evolution-display.visible {
      opacity: 1;
    }
    
    .layer-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin: 0 3px;
      background: rgba(0,255,136,0.3);
      transition: all 0.3s ease;
    }
    
    .layer-indicator.active {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.6);
    }
    
    .simulate-controls {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 1s ease;
    }
    
    .simulate-controls.visible {
      opacity: 1;
    }
    
    .sim-btn {
      display: block;
      margin: 10px 0;
      padding: 8px 16px;
      background: rgba(0,255,136,0.1);
      color: #00ff88;
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      font-family: 'Courier New', monospace;
    }
    
    .sim-btn:hover {
      background: rgba(0,255,136,0.2);
      transform: translateY(-1px);
    }
    
    .sim-btn.active {
      background: rgba(0,255,136,0.3);
      border-color: #00ff88;
    }
    
    .picardy-surge {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 1s ease;
    }
    
    .picardy-surge.active {
      opacity: 1;
    }
    
    .emotional-display {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      color: #00ff88;
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 1s ease;
      border: 1px solid rgba(0,255,136,0.2);
      min-width: 180px;
    }
    
    .emotional-display.visible {
      opacity: 1;
    }
    
    .mood-indicator {
      width: 100%;
      height: 20px;
      background: rgba(0,255,136,0.1);
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .mood-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00cc6a);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    .particle-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }
    
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(0,255,136,0.6);
      border-radius: 50%;
      animation: float 3s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse {
      animation: pulse 1s infinite;
    }
    
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: #00ff88;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,136,0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 200;
      text-align: center;
    }
    
    .notification.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">LIFE SOUNDTRACK</h1>
    <p class="subtitle">Adaptive Music Evolution Engine</p>
    <button class="start-btn" id="startBtn">Initialize</button>
  </div>
  
  <div class="hud" id="hud">
    <div class="hud-item">
      <span class="hud-label">Motion Intensity:</span>
      <span class="hud-value" id="motionIntensity">0.0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Activity State:</span>
      <span class="hud-value" id="activityState">Still</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Musical Layers:</span>
      <span class="hud-value" id="layerCount">1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Complexity:</span>
      <span class="hud-value" id="complexity">Basic</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Tempo:</span>
      <span class="hud-value" id="tempo">72 BPM</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Key:</span>
      <span class="hud-value" id="currentKey">A Minor</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Evolution:</span>
      <span class="hud-value" id="evolutionStage">Dormant</span>
    </div>
  </div>
  
  <div class="emotional-display" id="emotionalDisplay">
    <div style="margin-bottom: 10px; font-size: 0.9rem; text-align: center;">Emotional State</div>
    <div id="emotionLabel" style="text-align: center; margin-bottom: 5px;">Neutral</div>
    <div class="mood-indicator">
      <div class="mood-bar" id="moodBar" style="width: 50%;"></div>
    </div>
    <div style="font-size: 0.7rem; margin-top: 5px; text-align: center;">
      <span id="emotionDetails">Calm & Centered</span>
    </div>
  </div>
  
  <div class="motion-grid" id="motionGrid">
    <div class="motion-dot" id="motionDot"></div>
  </div>
  
  <canvas class="waveform" id="waveform"></canvas>
  
  <div class="evolution-display" id="evolutionDisplay">
    <div style="margin-bottom: 10px; font-size: 0.9rem;">Active Layers</div>
    <div id="layerIndicators">
      <span class="layer-indicator" id="layer-ambient"></span>
      <span class="layer-indicator" id="layer-bass"></span>
      <span class="layer-indicator" id="layer-drums"></span>
      <span class="layer-indicator" id="layer-harmony"></span>
      <span class="layer-indicator" id="layer-melody"></span>
      <span class="layer-indicator" id="layer-texture"></span>
    </div>
  </div>
  
  <div class="simulate-controls" id="simulateControls">
    <button class="sim-btn" id="simWalk">Walk</button>
    <button class="sim-btn" id="simRun">Run</button>
    <button class="sim-btn" id="simDance">Dance</button>
    <button class="sim-btn" id="simStill">Still</button>
    <button class="sim-btn" id="triggerPicardy">Picardy</button>
  </div>
  
  <div class="picardy-surge" id="picardySurge"></div>
  <div class="particle-container" id="particleContainer"></div>
  
  <div class="notification" id="notification">
    <div id="notificationText"></div>
  </div>

  <script>
    // Advanced musical system with extended progressions
    const MUSICAL_SYSTEM = {
      keys: {
        'A_MINOR': {
          name: 'A Minor',
          scale: ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
          chords: {
            i: ['A3', 'C4', 'E4'],
            ii: ['B3', 'D4', 'F4'],
            III: ['C4', 'E4', 'G4'],
            iv: ['D4', 'F4', 'A4'],
            v: ['E4', 'G4', 'B4'],
            VI: ['F4', 'A4', 'C5'],
            VII: ['G4', 'B4', 'D5'],
            picardy: ['A3', 'C#4', 'E4']
          }
        },
        'C_MAJOR': {
          name: 'C Major',
          scale: ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
          chords: {
            I: ['C4', 'E4', 'G4'],
            ii: ['D4', 'F4', 'A4'],
            iii: ['E4', 'G4', 'B4'],
            IV: ['F4', 'A4', 'C5'],
            V: ['G4', 'B4', 'D5'],
            vi: ['A4', 'C5', 'E5'],
            vii: ['B4', 'D5', 'F5']
          }
        }
      },
      progressions: {
        dormant: ['i'],
        contemplative: ['i', 'VI'],
        building: ['i', 'VI', 'III', 'VII'],
        active: ['i', 'iv', 'VI', 'v'],
        dynamic: ['i', 'VII', 'VI', 'III'],
        transcendent: ['i', 'iv', 'VII', 'VI'],
        resolution: ['i', 'iv', 'v', 'picardy']
      },
      rhythms: {
        still: [1, 0, 0, 0, 0, 0, 0, 0],
        walking: [1, 0, 1, 0, 1, 0, 1, 0],
        active: [1, 0, 1, 1, 0, 1, 0, 1],
        running: [1, 1, 0, 1, 1, 0, 1, 1],
        dancing: [1, 1, 1, 0, 1, 1, 0, 1]
      },
      emotions: {
        calm: { tempo: 65, key: 'A_MINOR', intensity: 0.3 },
        energetic: { tempo: 120, key: 'C_MAJOR', intensity: 0.8 },
        melancholic: { tempo: 58, key: 'A_MINOR', intensity: 0.2 },
        euphoric: { tempo: 140, key: 'C_MAJOR', intensity: 1.0 },
        contemplative: { tempo: 70, key: 'A_MINOR', intensity: 0.4 },
        triumphant: { tempo: 110, key: 'C_MAJOR', intensity: 0.9 }
      }
    };
    
    // Global state with enhanced tracking
    const state = {
      active: false,
      currentKey: MUSICAL_SYSTEM.keys.A_MINOR,
      motionIntensity: 0,
      activityState: 'still',
      tempo: 72,
      
      // Enhanced motion tracking
      accelerationBuffer: [],
      motionHistory: [],
      lastSignificantMotion: 0,
      motionPatterns: [],
      
      // Musical evolution
      evolutionStage: 'dormant',
      activeLayers: new Set(['ambient']),
      complexity: 0,
      progression: 'dormant',
      chordIndex: 0,
      
      // Emotional state
      emotionalState: 'neutral',
      emotionalIntensity: 0.5,
      moodHistory: [],
      
      // Audio components
      audioInitialized: false,
      scheduledEvents: new Map(),
      masterVolume: 0.7,
      
      // Timing and sequencing
      beatCount: 0,
      lastBeat: 0,
      measureCount: 0,
      sequenceRunning: false,
      
      // Visual effects
      particleCount: 0,
      activeSimulation: null
    };
    
    // Audio instruments and effects
    let instruments = {};
    let effects = {};
    let analyzer;
    let waveformData = [];
    
    // Initialize comprehensive audio system
    async function initAudio() {
      if (state.audioInitialized) return;
      
      try {
        await Tone.start();
        
        // Create sophisticated instruments
        instruments.ambient = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sine' },
          envelope: { attack: 3, decay: 2, sustain: 0.8, release: 4 },
          filter: { frequency: 800, rolloff: -24 }
        });
        
        instruments.bass = new Tone.MonoSynth({
          oscillator: { type: 'sawtooth' },
          envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 0.8 },
          filter: { frequency: 200, rolloff: -12 }
        });
        
        instruments.drums = new Tone.MembraneSynth({
          pitchDecay: 0.05,
          octaves: 10,
          oscillator: { type: 'sine' },
          envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        });
        
        instruments.harmony = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.5, decay: 0.8, sustain: 0.6, release: 2 }
        });
        
        instruments.melody = new Tone.Synth({
          oscillator: { type: 'square' },
          envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.8 }
        });
        
        instruments.texture = new Tone.NoiseSynth({
          noise: { type: 'pink' },
          envelope: { attack: 0.1, decay: 0.3, sustain: 0.1, release: 0.5 }
        });
        
        // Advanced effects chain
        effects.reverb = new Tone.Reverb({ decay: 3, wet: 0.3 });
        effects.delay = new Tone.FeedbackDelay('8n', 0.2);
        effects.filter = new Tone.Filter({ frequency: 800, type: 'lowpass' });
        effects.compressor = new Tone.Compressor(-20, 3);
        effects.chorus = new Tone.Chorus(4, 2.5, 0.5);
        effects.distortion = new Tone.Distortion(0.1);
        
        // Create analyzer for waveform
        analyzer = new Tone.Analyser('waveform', 256);
        
        // Route audio through effects
        instruments.ambient.chain(effects.chorus, effects.reverb, effects.compressor, analyzer, Tone.Destination);
        instruments.bass.chain(effects.filter, effects.compressor, Tone.Destination);
        instruments.drums.chain(effects.compressor, Tone.Destination);
        instruments.harmony.chain(effects.reverb, effects.delay, effects.compressor, Tone.Destination);
        instruments.melody.chain(effects.delay, effects.compressor, Tone.Destination);
        instruments.texture.chain(effects.reverb, effects.compressor, Tone.Destination);
        
        // Set balanced volumes
        instruments.ambient.volume.value = -20;
        instruments.bass.volume.value = -15;
        instruments.drums.volume.value = -18;
        instruments.harmony.volume.value = -22;
        instruments.melody.volume.value = -18;
        instruments.texture.volume.value = -25;
        
        // Initialize transport
        Tone.Transport.bpm.value = state.tempo;
        Tone.Transport.start();
        
        state.audioInitialized = true;
        showNotification('Audio System Initialized');
        
        // Start waveform visualization
        initWaveformVisualization();
        
      } catch (error) {
        console.error('Audio initialization failed:', error);
        showNotification('Audio initialization failed. Please refresh and try again.');
      }
    }
    
    // Enhanced motion processing with pattern recognition
    function processMotion(event) {
      if (!state.active) return;
      
      const accel = event.accelerationIncludingGravity || {};
      const magnitude = Math.sqrt(
        Math.pow(accel.x || 0, 2) + 
        Math.pow(accel.y || 0, 2) + 
        Math.pow(accel.z || 0, 2)
      );
      
      // Enhanced motion buffer
      state.accelerationBuffer.push({
        magnitude,
        x: accel.x || 0,
        y: accel.y || 0,
        z: accel.z || 0,
        timestamp: Date.now()
      });
      
      if (state.accelerationBuffer.length > 50) {
        state.accelerationBuffer.shift();
      }
      
      // Calculate sophisticated motion metrics
      const recentMotion = state.accelerationBuffer.slice(-10);
      const avgMotion = recentMotion.reduce((sum, m) => sum + m.magnitude, 0) / recentMotion.length;
      const motionVariance = recentMotion.reduce((sum, m) => sum + Math.pow(m.magnitude - avgMotion, 2), 0) / recentMotion.length;
      
      state.motionIntensity = Math.min(5, avgMotion / 3);
      
      // Detect motion patterns
      detectMotionPatterns();
      
      // Update motion history with enhanced data
      state.motionHistory.push({
        time: Date.now(),
        intensity: state.motionIntensity,
        variance: motionVariance,
        raw: magnitude,
        direction: { x: accel.x, y: accel.y, z: accel.z }
      });
      
      if (state.motionHistory.length > 200) {
        state.motionHistory.shift();
      }
      
      // Update activity state with pattern recognition
      updateActivityState();
      
      // Update emotional state based on motion
      updateEmotionalState();
      
      // Update motion visualizer
      updateMotionVisualizer(accel);
      
      // Evolve music
      evolveMusic();
      
      // Generate particles based on motion
      generateParticles();
      
      // Update all UI elements
      updateUI();
    }
    
    // Pattern detection for motion
    function detectMotionPatterns() {
      if (state.accelerationBuffer.length < 20) return;
      
      const recent = state.accelerationBuffer.slice(-20);
      const frequencies = analyzeMotionFrequency(recent);
      
      // Detect rhythmic patterns
      if (frequencies.dominant > 0.5 && frequencies.dominant < 3) {
        state.motionPatterns.push({
          type: 'rhythmic',
          frequency: frequencies.dominant,
          strength: frequencies.strength,
          timestamp: Date.now()
        });
      }
      
      // Keep pattern history limited
      if (state.motionPatterns.length > 10) {
        state.motionPatterns.shift();
      }
    }
    
    // Analyze motion frequency patterns
    function analyzeMotionFrequency(motionData) {
      // Simple frequency analysis
      const intervals = [];
      let lastPeak = 0;
      
      for (let i = 1; i < motionData.length - 1; i++) {
        const current = motionData[i].magnitude;
        const prev = motionData[i - 1].magnitude;
        const next = motionData[i + 1].magnitude;
        
        if (current > prev && current > next && current > 1) {
          if (lastPeak > 0) {
            intervals.push(motionData[i].timestamp - lastPeak);
          }
          lastPeak = motionData[i].timestamp;
        }
      }
      
      if (intervals.length === 0) return { dominant: 0, strength: 0 };
      
      const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      const frequency = 1000 / avgInterval; // Hz
      const strength = Math.min(1, intervals.length / 5);
      
      return { dominant: frequency, strength };
    }
    
    // Enhanced activity state detection
    function updateActivityState() {
      const recent = state.motionHistory.slice(-15);
      const avgIntensity = recent.reduce((sum, m) => sum + m.intensity, 0) / recent.length;
      const avgVariance = recent.reduce((sum, m) => sum + (m.variance || 0), 0) / recent.length;
      
      // More sophisticated activity classification
      if (avgIntensity < 0.3) {
        state.activityState = 'still';
      } else if (avgIntensity < 1.2) {
        state.activityState = avgVariance > 0.5 ? 'fidgeting' : 'walking';
      } else if (avgIntensity < 2.5) {
        state.activityState = avgVariance > 1.0 ? 'dancing' : 'active';
      } else if (avgIntensity < 4.0) {
        state.activityState = 'running';
      } else {
        state.activityState = 'dancing';
      }
    }
    
    // Update emotional state based on motion patterns
    function updateEmotionalState() {
      const recentMotion = state.motionHistory.slice(-20);
      if (recentMotion.length === 0) return;
      
      const avgIntensity = recentMotion.reduce((sum, m) => sum + m.intensity, 0) / recentMotion.length;
      const consistency = 1 - (recentMotion.reduce((sum, m) => sum + Math.abs(m.intensity - avgIntensity), 0) / recentMotion.length);
      
      let newEmotion = 'neutral';
      let intensity = 0.5;
      
      if (avgIntensity < 0.5 && consistency > 0.7) {
        newEmotion = 'calm';
        intensity = 0.3;
      } else if (avgIntensity > 3 && consistency < 0.3) {
        newEmotion = 'euphoric';
        intensity = 1.0;
      } else if (avgIntensity > 2 && consistency > 0.5) {
        newEmotion = 'energetic';
        intensity = 0.8;
      } else if (avgIntensity < 1 && consistency < 0.5) {
        newEmotion = 'contemplative';
        intensity = 0.4;
      }
      
      state.emotionalState = newEmotion;
      state.emotionalIntensity = intensity;
      
      // Update mood history
      state.moodHistory.push({
        emotion: newEmotion,
        intensity: intensity,
        timestamp: Date.now()
      });
      
      if (state.moodHistory.length > 50) {
        state.moodHistory.shift();
      }
    }
    
    // Enhanced music evolution with emotional influence
    function evolveMusic() {
      const now = Date.now();
      const timeSinceMotion = now - state.lastSignificantMotion;
      
      if (state.motionIntensity > 1)
