<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Spatial AI Music Layer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', monospace;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  position: fixed;
  touch-action: none;
}
#spatialGrid {
  position: fixed; inset: 0; pointer-events: none;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(0,255,255,0.08) 49px, rgba(0,255,255,0.08) 50px),
    repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(0,255,255,0.08) 49px, rgba(0,255,255,0.08) 50px);
  opacity: 0.4;
}
.audio-zone {
  position: absolute;
  border: 2px solid rgba(0,255,255,0.4);
  border-radius: 50%;
  pointer-events: none;
  transition: all 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  text-shadow: 0 0 8px #000;
  opacity: 0.7;
}
.audio-zone.active {
  border-color: #0ff;
  box-shadow: 0 0 40px rgba(0,255,255,0.6), inset 0 0 30px rgba(0,255,255,0.2);
  opacity: 1;
  animation: pulse-zone 2s ease-in-out infinite;
}
@keyframes pulse-zone { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
#userPosition {
  position: absolute;
  width: 32px; height: 32px;
  background: radial-gradient(circle, #f0f, #f0f 40%, transparent 70%);
  border: 2px solid #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 25px #f0f;
  z-index: 100; pointer-events: none;
  transition: all 0.1s ease;
}
#userPosition::before {
  content: ''; position: absolute; inset: -12px;
  border: 1px solid rgba(255,0,255,0.4);
  border-radius: 50%;
  animation: ripple 2.5s ease-out infinite;
}
@keyframes ripple { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(2.2); opacity: 0; } }
#startScreen {
  position: fixed; inset: 0;
  background: radial-gradient(circle at center, #001111 0%, #000 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  transition: opacity 0.8s ease;
}
#startScreen.hidden { opacity: 0; pointer-events: none; }
.start-title {
  font-size: 36px; font-weight: bold; margin-bottom: 12px;
  background: linear-gradient(90deg, #0ff, #f0f, #0ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: gradient-shift 4s ease infinite;
}
@keyframes gradient-shift { 0%,100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(40deg); } }
.start-subtitle { font-size: 15px; opacity: 0.8; text-align: center; margin-bottom: 50px; max-width: 320px; }
#startButton {
  padding: 20px 50px; font-size: 20px; font-weight: bold;
  background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 50px;
  color: #000; cursor: pointer; box-shadow: 0 0 40px rgba(0,255,255,0.6);
  transition: all 0.3s ease;
}
#startButton:active { transform: scale(0.95); }
.permission-status { margin-top: 40px; font-size: 13px; opacity: 0.7; text-align: center; }
.permission-item { margin: 6px 0; }
.permission-item.granted { color: #0f0; }
.permission-item.denied { color: #f88; }
#statusBar {
  position: fixed; top: 0; left: 0; right: 0; padding: 15px;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
  display: flex; justify-content: space-between; font-size: 12px; z-index: 50;
}
.status-group { display: flex; flex-direction: column; gap: 4px; }
.status-label { opacity: 0.6; font-size: 10px; }
.status-value { font-weight: bold; color: #0ff; }
#aiStatus {
  position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
  padding: 12px 24px; border-radius: 30px; border: 1px solid rgba(255,0,255,0.5);
  font-size: 13px; display: flex; align-items: center; gap: 12px;
  opacity: 0; transition: opacity 0.5s;
}
#aiStatus.visible { opacity: 1; }
.ai-indicator {
  width: 10px; height: 10px; background: #f0f; border-radius: 50%;
  animation: blink 1.2s ease-in-out infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
#musicInfo {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 18px; border-radius: 20px; border: 1px solid rgba(0,255,255,0.3);
  text-align: center; opacity: 0; transition: opacity 0.5s; max-width: 90%;
}
#musicInfo.visible { opacity: 1; }
.track-name { font-size: 18px; font-weight: bold; color: #0ff; margin-bottom: 6px; }
.track-details { font-size: 13px; opacity: 0.8; }
#controlPanel {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 16px; border-radius: 30px; border: 1px solid rgba(0,255,255,0.3);
  display: flex; gap: 20px;
}
.control-button {
  width: 56px; height: 56px; border-radius: 50%;
  border: 2px solid #0ff; background: rgba(0,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; cursor: pointer; transition: all 0.2s;
}
.control-button:active { transform: scale(0.9); background: rgba(0,255,255,0.3); }
.control-button.active { background: rgba(0,255,255,0.5); box-shadow: 0 0 25px rgba(0,255,255,0.7); }
.error-message {
  background: rgba(255,0,0,0.2); border: 1px solid #f88; padding: 15px;
  border-radius: 12px; margin-top: 30px; font-size: 13px; max-width: 300px;
}
</style>
</head>
<body>
<div id="spatialGrid"></div>
<div id="userPosition"></div>
<div id="audioZonesContainer"></div>

<div id="startScreen">
  <div class="start-title">SPATIAL AI MUSIC</div>
  <div class="start-subtitle">Move your phone to walk through invisible layers of living music. The world becomes the orchestra.</div>
  <button id="startButton">TAP TO ENTER</button>
  <div class="permission-status">
    <div class="permission-item" id="motionStatus">◯ Motion</div>
    <div class="permission-item" id="orientationStatus">◯ Orientation</div>
    <div class="permission-item" id="audioStatus">◯ Audio Engine</div>
  </div>
  <div class="error-message" id="errorMessage" style="display:none;"></div>
</div>

<div id="statusBar">
  <div class="status-group"><div class="status-label">POSITION</div><div class="status-value" id="positionDisplay">0, 0</div></div>
  <div class="status-group"><div class="status-label">LAYERS</div><div class="status-value" id="zonesDisplay">0/5</div></div>
  <div class="status-group"><div class="status-label">ENERGY</div><div class="status-value" id="energyDisplay">0%</div></div>
</div>

<div id="aiStatus">
  <div class="ai-indicator"></div>
  <span id="aiStatusText">AI Listening...</span>
</div>

<div id="musicInfo">
  <div class="track-name" id="trackName">Silent Space</div>
  <div class="track-details" id="trackDetails">Begin moving to awaken the soundscape</div>
</div>

<div id="controlPanel">
  <div class="control-button" id="calibrateBtn" title="Calibrate">⊙</div>
  <div class="control-button" id="toggleAudioBtn" class="active" title="Mute">♫</div>
  <div class="control-button" id="resetBtn" title="Reset">↻</div>
</div>

<script>
'use strict';

class SpatialAIMusicLayer {
  constructor() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.accel = { x: 0, y: 0, z: 0 };
    this.orientation = 0;
    this.calibration = { x: 0, y: 0 };

    this.zones = [];
    this.activeZones = new Set();

    this.permissions = { motion: false, orientation: false, audio: false };

    this.ui = {
      startScreen: document.getElementById('startScreen'),
      startButton: document.getElementById('startButton'),
      userPosition: document.getElementById('userPosition'),
      zonesContainer: document.getElementById('audioZonesContainer'),
      positionDisplay: document.getElementById('positionDisplay'),
      zonesDisplay: document.getElementById('zonesDisplay'),
      energyDisplay: document.getElementById('energyDisplay'),
      aiStatus: document.getElementById('aiStatus'),
      aiStatusText: document.getElementById('aiStatusText'),
      trackName: document.getElementById('trackName'),
      trackDetails: document.getElementById('trackDetails'),
      motionStatus: document.getElementById('motionStatus'),
      orientationStatus: document.getElementById('orientationStatus'),
      audioStatus: document.getElementById('audioStatus'),
      errorMessage: document.getElementById('errorMessage'),
      calibrateBtn: document.getElementById('calibrateBtn'),
      toggleAudioBtn: document.getElementById('toggleAudioBtn'),
      resetBtn: document.getElementById('resetBtn')
    };

    this.setupEvents();
  }

  setupEvents() {
    this.ui.startButton.addEventListener('click', () => this.initialize());
    this.ui.calibrateBtn.addEventListener('click', () => this.calibrate());
    this.ui.toggleAudioBtn.addEventListener('click', () => this.toggleMute());
    this.ui.resetBtn.addEventListener('click', () => this.resetPosition());
  }

  async initialize() {
    this.ui.startButton.disabled = true;
    this.ui.startButton.textContent = 'AWAKENING...';

    try {
      await this.requestPermissions();
      await Tone.start();
      this.setupAudioEngine();
      this.setupMotion();
      this.createZones();
      this.startExperience();
      this.ui.startScreen.classList.add('hidden');
    } catch (err) {
      console.error(err);
      this.showError(err.message || 'Initialization failed. Try again.');
      this.ui.startButton.disabled = false;
      this.ui.startButton.textContent = 'TAP TO ENTER';
    }
  }

  async requestPermissions() {
    // Motion
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
      const res = await DeviceMotionEvent.requestPermission();
      this.permissions.motion = res === 'granted';
    } else {
      this.permissions.motion = true;
    }
    this.updatePermUI('motion', this.permissions.motion);

    // Orientation
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      const res = await DeviceOrientationEvent.requestPermission();
      this.permissions.orientation = res === 'granted';
    } else {
      this.permissions.orientation = true;
    }
    this.updatePermUI('orientation', this.permissions.orientation);

    if (!this.permissions.motion) throw new Error('Motion access required for spatial navigation');
  }

  updatePermUI(type, granted) {
    const el = this.ui[`${type}Status`];
    el.textContent = granted ? '✓ ' : '✗ ';
    el.textContent += type.charAt(0).toUpperCase() + type.slice(1);
    el.className = 'permission-item ' + (granted ? 'granted' : 'denied');
  }

  setupAudioEngine() {
    // Shared effects
    this.reverb = new Tone.Reverb({ decay: 4, wet: 0.4 }).toDestination();
    this.delay = new Tone.FeedbackDelay({ delayTime: 0.35, feedback: 0.3, wet: 0.25 }).connect(this.reverb);
    this.master = new Tone.Gain(0.7).toDestination();

    this.reverb.generate(); // pre-generate impulse

    // Global transport
    Tone.Transport.bpm.value = 90;
    Tone.Transport.start();

    this.permissions.audio = true;
    this.updatePermUI('audio', true);
  }

  setupMotion() {
    window.addEventListener('devicemotion', e => {
      if (e.accelerationIncludingGravity) {
        this.accel.x = e.accelerationIncludingGravity.x || 0;
        this.accel.y = e.accelerationIncludingGravity.y || 0;
        this.accel.z = e.accelerationIncludingGravity.z || 0;
      }
    });

    window.addEventListener('deviceorientation', e => {
      this.orientation = e.alpha || 0;
    });
  }

  createZones() {
    const w = window.innerWidth, h = window.innerHeight;
    const keyRoot = 'C3';
    const scale = ['C', 'Eb', 'F', 'G', 'Ab', 'Bb']; // minor aesthetic

    const configs = [
      { x: w*0.25, y: h*0.3,  size: 140, role: 'bass',     color: '#0ff', name: 'Deep Pulse' },
      { x: w*0.75, y: h*0.35, size: 130, role: 'chords',   color: '#f0f', name: 'Crystal Chords' },
      { x: w*0.5,  y: h*0.65, size: 160, role: 'arpeggio', color: '#0f8', name: 'Stellar Arp' },
      { x: w*0.3,  y: h*0.7,  size: 110, role: 'pads',     color: '#ff8', name: 'Ethereal Pads' },
      { x: w*0.7,  y: h*0.75, size: 120, role: 'perc',     color: '#f80', name: 'Cosmic Rhythm' }
    ];

    configs.forEach((cfg, i) => {
      const zone = {
        id: i, x: cfg.x, y: cfg.y, size: cfg.size, name: cfg.name, color: cfg.color,
        element: null, panner: new Tone.Panner(0).connect(this.master),
        synth: null, sequence: null
      };

      // Visual
      zone.element = document.createElement('div');
      zone.element.className = 'audio-zone';
      zone.element.style.left = (cfg.x - cfg.size/2) + 'px';
      zone.element.style.top = (cfg.y - cfg.size/2) + 'px';
      zone.element.style.width = zone.element.style.height = cfg.size + 'px';
      zone.element.style.borderColor = cfg.color;
      zone.element.textContent = cfg.name;
      this.ui.zonesContainer.appendChild(zone.element);

      // Audio by role
      switch (cfg.role) {
        case 'bass':
          zone.synth = new Tone.MembraneSynth({ octaves: 3 }).connect(zone.panner);
          zone.sequence = new Tone.Sequence((time, note) => {
            zone.synth.triggerAttackRelease(note, '8n', time);
          }, [keyRoot, `${scale[2]}2`, `${scale[4]}2`, keyRoot], '4n');
          break;
        case 'chords':
          zone.synth = new Tone.PolySynth(Tone.AMSynth, { voiceCount: 6 }).connect(zone.panner).connect(this.delay);
          zone.sequence = new Tone.Sequence((time, chord) => {
            zone.synth.triggerAttackRelease(chord, '2m', time);
          }, [[`${scale[0]}4`, `${scale[2]}4`, `${scale[4]}4`],
              [`${scale[3]}4`, `${scale[5]}4`, `${scale[0]+'5'}`],
              [`${scale[1]}4`, `${scale[3]}4`, `${scale[5]}4`],
              [`${scale[2]}4`, `${scale[4]}4`, keyRoot+'5']], '1m');
          break;
        case 'arpeggio':
          zone.synth = new Tone.FMSynth({ modulationIndex: 12 }).connect(zone.panner).connect(this.reverb);
          zone.sequence = new Tone.Sequence((time, note) => {
            zone.synth.triggerAttackRelease(note, '16n', time);
          }, [...scale, ...scale.reverse()].map(n => n+'4'), '16n');
          break;
        case 'pads':
          zone.synth = new Tone.PolySynth(Tone.Synth, { voiceCount: 8, envelope: { attack: 3, release: 4 } })
                        .connect(zone.panner).connect(this.reverb);
          zone.sequence = new Tone.Sequence((time, chord) => {
            zone.synth.triggerAttackRelease(chord, '8m', time);
          }, [[`${scale[0]}3`, `${scale[2]}3`, `${scale[4]}3`],
              [`${scale[3]}3`, `${scale[5]}3`, `${scale[0]+'4'}`]], '2m');
          break;
        case 'perc':
          zone.synth = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.001, decay: 0.3, sustain: 0 }})
                        .connect(new Tone.Filter(800, 'lowpass')).connect(zone.panner);
          zone.sequence = new Tone.Sequence((time) => {
            zone.synth.triggerAttackRelease('16n', time);
          }, [null, null, null, 1], '16n');
          break;
      }

      zone.sequence.start(0);
      zone.sequence.volume.value = -Infinity; // muted until active

      this.zones.push(zone);
    });
  }

  startExperience() {
    this.ui.aiStatus.classList.add('visible');
    this.ui.musicInfo.classList.add('visible');
    requestAnimationFrame(() => this.updateLoop());
  }

  updateLoop() {
    this.updateMovement();
    this.updateZones();
    this.updateUI();
    requestAnimationFrame(() => this.updateLoop());
  }

  updateMovement() {
    const sens = 8, damp = 0.93;
    const ax = (this.accel.x - this.calibration.x) * sens;
    const ay = (this.accel.y - this.calibration.y) * sens;

    this.velocity.x += ax;
    this.velocity.y += ay;
    this.velocity.x *= damp;
    this.velocity.y *= damp;

    this.position.x += this.velocity.x;
    this.position.y += this.velocity.y;

    // Boundaries
    const margin = 60;
    if (this.position.x < margin) { this.position.x = margin; this.velocity.x *= -0.4; }
    if (this.position.x > window.innerWidth - margin) { this.position.x = window.innerWidth - margin; this.velocity.x *= -0.4; }
    if (this.position.y < margin) { this.position.y = margin; this.velocity.y *= -0.4; }
    if (this.position.y > window.innerHeight - margin) { this.position.y = window.innerHeight - margin; this.velocity.y *= -0.4; }

    this.ui.userPosition.style.left = this.position.x + 'px';
    this.ui.userPosition.style.top = this.position.y + 'px';
  }

  updateZones() {
    let activeCount = 0;
    const speed = Math.hypot(this.velocity.x, this.velocity.y);
    const energy = Math.min(Math.round(speed * 8), 100);

    Tone.Transport.bpm.rampTo(70 + energy * 0.8, 2);

    this.zones.forEach(zone => {
      const dx = this.position.x - zone.x;
      const dy = this.position.y - zone.y;
      const dist = Math.hypot(dx, dy);
      const proximity = Math.max(0, 1 - dist / (zone.size / 2));

      // Panning
      zone.panner.pan.value = (dx / window.innerWidth) * 2 - 1;

      if (proximity > 0.05) {
        if (!this.activeZones.has(zone.id)) {
          this.activeZones.add(zone.id);
          zone.element.classList.add('active');
        }
        activeCount++;

        // Volume & filter based on closeness
        const vol = -30 + proximity * 40;
        zone.sequence.volume.rampTo(vol, 0.5);
      } else {
        if (this.activeZones.has(zone.id)) {
          this.activeZones.delete(zone.id);
          zone.element.classList.remove('active');
          zone.sequence.volume.rampTo(-Infinity, 1);
        }
      }
    });

    this.ui.zonesDisplay.textContent = `${activeCount}/5`;
  }

  updateUI() {
    const x = Math.round(this.position.x), y = Math.round(this.position.y);
    this.ui.positionDisplay.textContent = `${x}, ${y}`;

    const speed = Math.hypot(this.velocity.x, this.velocity.y);
    const energy = Math.min(Math.round(speed * 8), 100);
    this.ui.energyDisplay.textContent = `${energy}%`;

    if (this.activeZones.size === 0) {
      this.ui.aiStatusText.textContent = 'AI Listening...';
      this.ui.trackName.textContent = 'Silent Space';
      this.ui.trackDetails.textContent = 'Move to awaken layers';
    } else if (this.activeZones.size === 1) {
      this.ui.aiStatusText.textContent = 'AI Composing melody...';
      this.ui.trackName.textContent = 'First Breath';
    } else if (this.activeZones.size <= 3) {
      this.ui.aiStatusText.textContent = 'AI Weaving harmony...';
      this.ui.trackName.textContent = 'Living Chord';
    } else {
      this.ui.aiStatusText.textContent = 'AI Orchestrating full ensemble...';
      this.ui.trackName.textContent = 'Cosmic Symphony';
      this.ui.trackDetails.textContent = 'You are inside the music';
    }
  }

  calibrate() {
    this.calibration.x = this.accel.x;
    this.calibration.y = this.accel.y;
    this.velocity = { x: 0, y: 0 };
    this.ui.calibrateBtn.classList.add('active');
    setTimeout(() => this.ui.calibrateBtn.classList.remove('active'), 300);
  }

  toggleMute() {
    if (this.master.gain.value > 0) {
      this.master.gain.rampTo(0, 0.5);
      this.ui.toggleAudioBtn.classList.remove('active');
    } else {
      this.master.gain.rampTo(0.7, 0.5);
      this.ui.toggleAudioBtn.classList.add('active');
    }
  }

  resetPosition() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.calibrate();
    this.ui.resetBtn.classList.add('active');
    setTimeout(() => this.ui.resetBtn.classList.remove('active'), 300);
  }

  showError(msg) {
    this.ui.errorMessage.textContent = '⚠️ ' + msg;
    this.ui.errorMessage.style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  window.app = new SpatialAIMusicLayer();
});

document.addEventListener('visibilitychange', () => {
  if (document.hidden) Tone.Transport.pause();
  else if (window.app?.activeZones?.size > 0) Tone.Transport.start();
});
</script>
</body>
</html>
