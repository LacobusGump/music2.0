<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Soundtrack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle, #001122 0%, #000 100%);
      color: #00ffaa;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      text-align: center;
    }
    
    .title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px #00ffaa;
      animation: pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { text-shadow: 0 0 20px #00ffaa; }
      to { text-shadow: 0 0 30px #00ffaa, 0 0 40px #00aa88; }
    }
    
    .btn {
      padding: 15px 30px;
      background: linear-gradient(45deg, #00ffaa, #00aa88);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 10px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,255,170,0.3);
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0,255,170,0.5);
    }
    
    .status {
      background: rgba(0,255,170,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 400px;
      backdrop-filter: blur(10px);
    }
    
    .motion-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,255,170,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .motion-progress {
      height: 100%;
      background: linear-gradient(90deg, #00ffaa, #00aa88);
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(0,255,170,0.5);
    }
    
    .rhythm-viz {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
    }
    
    .beat {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,255,170,0.3);
      transition: all 0.2s;
    }
    
    .beat.active {
      background: #00ffaa;
      box-shadow: 0 0 15px #00ffaa;
      transform: scale(1.4);
    }
    
    .beat.kick {
      background: #ff6b6b;
      box-shadow: 0 0 15px #ff6b6b;
    }
    
    .beat.snare {
      background: #4ecdc4;
      box-shadow: 0 0 15px #4ecdc4;
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="title">MOTION SOUNDTRACK</h1>
  <button class="btn" id="startBtn">START LISTENING</button>
  
  <div class="status hidden" id="status">
    <div>Motion: <span id="motionLevel">0</span>%</div>
    <div>State: <span id="currentState">Still</span></div>
    <div>Layers: <span id="layerCount">0</span>/4</div>
    <div class="motion-bar">
      <div class="motion-progress" id="progress"></div>
    </div>
    <div class="rhythm-viz" id="rhythm"></div>
  </div>

  <script>
    let motion = 0;
    let motionHistory = [];
    let step = 0;
    let synths = {};
    let lastMouseX = 0, lastMouseY = 0;
    
    // 90s hip-hop patterns
    const patterns = {
      kick: [1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      bass: [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]
    };
    
    document.getElementById('startBtn').onclick = async () => {
      await Tone.start();
      initAudio();
      startMotionTracking();
      
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
      
      updateUI();
    };
    
    function initAudio() {
      // Fat 90s drum kit
      synths.kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 10,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
      }).toDestination();
      
      synths.snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.13, sustain: 0.2, release: 0.03 }
      }).toDestination();
      
      synths.hihat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.02, sustain: 0.0, release: 0.01 }
      }).toDestination();
      
      synths.openhat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0.05, release: 0.05 }
      }).toDestination();
      
      // Deep 808-style bass
      synths.bass = new Tone.MonoSynth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.1, release: 1.0 },
        filter: { Q: 6, type: 'lowpass', rolloff: -24 },
        filterEnvelope: { attack: 0.001, decay: 0.5, sustain: 0.1, release: 1.0, baseFrequency: 200, octaves: 2.6 }
      }).toDestination();
      
      // Ambient pad for atmosphere
      synths.pad = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: { attack: 0.8, decay: 0.2, sustain: 0.6, release: 2.0 },
        filter: { Q: 1, type: 'lowpass', rolloff: -12 }
      }).toDestination();
      
      // Set volumes for that fat 90s mix
      synths.kick.volume.value = -8;
      synths.snare.volume.value = -12;
      synths.hihat.volume.value = -18;
      synths.openhat.volume.value = -16;
      synths.bass.volume.value = -10;
      synths.pad.volume.value = -20;
      
      Tone.Transport.bpm.value = 88; // Classic 90s tempo
      Tone.Transport.start();
      
      // Main sequencer - pattern-based
      Tone.Transport.scheduleRepeat((time) => {
        const pos = step % 16;
        const intensity = motion / 100;
        
        if (intensity > 0.2) {
          dropTheBeat(pos, time, intensity);
        }
        
        updateRhythm(pos);
        step++;
      }, '16n');
    }
    
    function dropTheBeat(pos, time, intensity) {
      // Kick - the foundation
      if (patterns.kick[pos] && intensity > 0.25) {
        synths.kick.triggerAttackRelease('C1', '8n', time, Math.min(1, intensity * 1.2));
      }
      
      // Snare - the crack
      if (patterns.snare[pos] && intensity > 0.3) {
        synths.snare.triggerAttackRelease('8n', time, Math.min(1, intensity * 0.9));
      }
      
      // Hi-hat - the groove
      if (patterns.hihat[pos] && intensity > 0.35) {
        synths.hihat.triggerAttackRelease('32n', time, intensity * 0.7);
      }
      
      // Open hat - the accent
      if (patterns.openhat[pos] && intensity > 0.5) {
        synths.openhat.triggerAttackRelease('16n', time, intensity * 0.8);
      }
      
      // 808 bass - the boom
      if (patterns.bass[pos] && intensity > 0.4) {
        const notes = ['E1', 'A1', 'D1', 'G1'];
        const note = notes[Math.floor(intensity * 4) % 4];
        synths.bass.triggerAttackRelease(note, '4n', time, Math.min(1, intensity * 1.1));
      }
      
      // Atmospheric pad - the vibe
      if (intensity > 0.7 && pos % 8 === 0) {
        const chords = [
          ['A2', 'C3', 'E3'],
          ['F2', 'A2', 'C3'],
          ['G2', 'B2', 'D3'],
          ['D2', 'F#2', 'A2']
        ];
        const chord = chords[Math.floor(step / 16) % 4];
        synths.pad.triggerAttackRelease(chord, '2n', time, intensity * 0.4);
      }
    }
    
    function startMotionTracking() {
      // Try device motion first - this is the primary goal
      if (typeof DeviceMotionEvent !== 'undefined') {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          // iOS - request permission
          DeviceMotionEvent.requestPermission().then(response => {
            if (response === 'granted') {
              window.addEventListener('devicemotion', handleMotion);
              console.log('Device motion enabled');
            } else {
              console.log('Motion permission denied, using mouse fallback');
              fallbackToMouse();
            }
          }).catch(() => {
            console.log('Motion permission error, using mouse fallback');
            fallbackToMouse();
          });
        } else {
          // Android and other devices
          window.addEventListener('devicemotion', handleMotion);
          console.log('Device motion enabled (no permission needed)');
        }
      } else {
        console.log('Device motion not supported, using mouse fallback');
        fallbackToMouse();
      }
    }
    
    function fallbackToMouse() {
      // Only use mouse on desktop as absolute fallback
      lastMouseX = window.innerWidth / 2;
      lastMouseY = window.innerHeight / 2;
      document.addEventListener('mousemove', handleMouseMotion);
      document.addEventListener('touchmove', handleTouchMotion);
      console.log('Using mouse/touch fallback - motion detection from environment disabled');
    }
    
    function handleTouchMotion(event) {
      if (event.touches.length > 0) {
        const touch = event.touches[0];
        const speed = Math.sqrt(
          Math.pow(touch.clientX - lastMouseX, 2) + 
          Math.pow(touch.clientY - lastMouseY, 2)
        );
        motion = Math.min(100, speed * 2);
        lastMouseX = touch.clientX;
        lastMouseY = touch.clientY;
        smoothMotion();
      }
    }
    
    function handleMotion(event) {
      const acc = event.accelerationIncludingGravity;
      if (acc && acc.x !== null && acc.y !== null && acc.z !== null) {
        // Calculate total acceleration magnitude
        const total = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
        // Remove gravity baseline (~9.8) and scale sensitivity
        motion = Math.min(100, Math.max(0, (total - 9.8) * 15));
        smoothMotion();
      }
    }
    
    function handleMouseMotion(event) {
      const speed = Math.sqrt(
        Math.pow(event.clientX - lastMouseX, 2) + 
        Math.pow(event.clientY - lastMouseY, 2)
      );
      motion = Math.min(100, speed * 2);
      lastMouseX = event.clientX;
      lastMouseY = event.clientY;
      smoothMotion();
    }
    
    function smoothMotion() {
      motionHistory.push(motion);
      if (motionHistory.length > 5) motionHistory.shift();
      motion = motionHistory.reduce((a, b) => a + b) / motionHistory.length;
    }
    
    function updateUI() {
      document.getElementById('motionLevel').textContent = Math.round(motion);
      
      const state = 
        motion < 5 ? 'Still' :
        motion < 20 ? 'Gentle' :
        motion < 50 ? 'Active' :
        motion < 80 ? 'Energetic' : 'Intense';
      document.getElementById('currentState').textContent = state;
      
      const layers = Math.min(4, Math.floor(motion / 15));
      document.getElementById('layerCount').textContent = layers;
      document.getElementById('progress').style.width = motion + '%';
      
      requestAnimationFrame(updateUI);
    }
    
    function updateRhythm(pos) {
      const rhythm = document.getElementById('rhythm');
      rhythm.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const beat = document.createElement('div');
        let className = 'beat';
        if (i === pos) className += ' active';
        if (patterns.kick[i]) className += ' kick';
        if (patterns.snare[i]) className += ' snare';
        beat.className = className;
        rhythm.appendChild(beat);
      }
    }
  </script>
</body>
</html>
