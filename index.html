<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GUMP</title>
    <style>
        :root { --phi: 1.618; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }
        canvas { position: fixed; inset: 0; }

        #enter {
            position: fixed; inset: 0;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; cursor: pointer; background: #0a0a0f;
        }
        #enter.off { display: none; }
        #enter i {
            width: 89px; height: 89px; border-radius: 50%;
            border: 1px solid rgba(200,180,255,0.15);
            display: flex; align-items: center; justify-content: center;
        }
        #enter i::after {
            content: ''; width: 34px; height: 34px; border-radius: 50%;
            border: 1px solid rgba(200,180,255,0.25);
        }

        #loading {
            position: fixed; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 13px; z-index: 99; background: #0a0a0f;
            color: rgba(200,180,255,0.4); font-size: 10px; letter-spacing: 2px;
        }
        #loading.off { display: none; }

        #ui {
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 50; padding: 21px 21px 34px;
            display: none;
        }

        .dial-row {
            display: flex; justify-content: center; gap: 34px; margin-bottom: 21px;
        }

        .dial-group {
            text-align: center;
        }

        .dial-label {
            font-size: 8px; letter-spacing: 3px;
            color: rgba(200,180,255,0.2); margin-bottom: 8px;
            text-transform: uppercase;
        }

        .dial-opts {
            display: flex; gap: 13px;
        }

        .dial-opt {
            font-size: 11px; color: rgba(200,180,255,0.15);
            cursor: pointer; padding: 8px 13px;
            transition: all 0.3s; letter-spacing: 1px;
            border-radius: 21px;
            -webkit-tap-highlight-color: transparent;
        }
        .dial-opt:hover { color: rgba(200,180,255,0.4); }
        .dial-opt.on {
            color: rgba(200,180,255,0.85);
            background: rgba(200,180,255,0.08);
        }
    </style>
</head>
<body>
<div id="enter"><i></i></div>
<div id="loading" class="off">loading...</div>

<div id="ui">
    <div class="dial-row">
        <div class="dial-group" data-dial="groove">
            <div class="dial-label">groove</div>
            <div class="dial-opts">
                <span class="dial-opt on" data-v="chill">chill</span>
                <span class="dial-opt" data-v="bounce">bounce</span>
                <span class="dial-opt" data-v="drive">drive</span>
                <span class="dial-opt" data-v="chaos">chaos</span>
            </div>
        </div>
    </div>
    <div class="dial-row">
        <div class="dial-group" data-dial="tone">
            <div class="dial-label">tone</div>
            <div class="dial-opts">
                <span class="dial-opt on" data-v="warm">warm</span>
                <span class="dial-opt" data-v="bright">bright</span>
                <span class="dial-opt" data-v="dark">dark</span>
                <span class="dial-opt" data-v="glass">glass</span>
            </div>
        </div>
    </div>
    <div class="dial-row">
        <div class="dial-group" data-dial="space">
            <div class="dial-label">space</div>
            <div class="dial-opts">
                <span class="dial-opt on" data-v="room">room</span>
                <span class="dial-opt" data-v="hall">hall</span>
                <span class="dial-opt" data-v="void">void</span>
                <span class="dial-opt" data-v="tight">tight</span>
            </div>
        </div>
    </div>
</div>

<canvas id="c"></canvas>

<script>
// GUMP - Clean Rebuild
// What works: real samples, lo-fi, motionâ†’energy, simple

const TAU = Math.PI * 2;

let ctx, master, canvas, vc;
let running = false;

// State
const dial = { groove: 'chill', tone: 'warm', space: 'room' };
const field = { x: 0.5, y: 0.5, energy: 0, time: 0, peak: 0, vx: 0, vy: 0 };
const music = { intensity: 0.3, bar: 0, beat: 0 };

// Samples
const SAMPLE_URLS = {
    // Kicks - different characters
    kick_soft: 'https://cdn.freesound.org/previews/171/171104_2394245-lq.mp3',
    kick_punch: 'https://cdn.freesound.org/previews/568/568573_12517458-lq.mp3',
    kick_sub: 'https://cdn.freesound.org/previews/725/725113_11861866-lq.mp3',
    // Snares
    snare_crack: 'https://cdn.freesound.org/previews/387/387186_7255534-lq.mp3',
    snare_fat: 'https://cdn.freesound.org/previews/398/398712_183766-lq.mp3',
    snare_rim: 'https://cdn.freesound.org/previews/209/209890_3797507-lq.mp3',
    // Hats
    hat_closed: 'https://cdn.freesound.org/previews/250/250540_4486188-lq.mp3',
    hat_open: 'https://cdn.freesound.org/previews/353/353774_5121236-lq.mp3',
    hat_shaker: 'https://cdn.freesound.org/previews/213/213590_3162965-lq.mp3',
    // Perc
    perc_click: 'https://cdn.freesound.org/previews/250/250537_4486188-lq.mp3',
    perc_tom: 'https://cdn.freesound.org/previews/110/110011_1537491-lq.mp3',
};

let samples = {};

// Audio nodes
let drumBus, synthBus, masterBus;
let lofi, verb, verbWet, dly, dlyWet, comp, lim;

// Groove presets - DRAMATICALLY different
const GROOVES = {
    chill: {
        bpm: 72,
        swing: 0.18,
        kickPattern: [1,0,0,0, 0,0,0.3,0, 1,0,0,0, 0,0,0,0.4],
        snarePattern: [0,0,0,0, 1,0,0,0, 0,0,0,0, 0.8,0,0.3,0],
        hatPattern: [0.3,0,0.5,0, 0.3,0,0.6,0, 0.3,0,0.5,0, 0.3,0,0.7,0],
        kickSample: 'kick_soft',
        snareSample: 'snare_fat',
        hatSample: 'hat_closed',
    },
    bounce: {
        bpm: 95,
        swing: 0.12,
        kickPattern: [1,0,0,0, 0,0,1,0, 0,0,0,0, 0,0.6,0,0],
        snarePattern: [0,0,0,0, 1,0,0,0.3, 0,0,0,0, 1,0,0,0],
        hatPattern: [0.6,0.3,0.5,0.3, 0.6,0.3,0.5,0.3, 0.6,0.3,0.5,0.3, 0.6,0.3,0.7,0.4],
        kickSample: 'kick_punch',
        snareSample: 'snare_crack',
        hatSample: 'hat_closed',
    },
    drive: {
        bpm: 128,
        swing: 0,
        kickPattern: [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        snarePattern: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
        hatPattern: [0.5,0.5,0.5,0.5, 0.5,0.5,0.5,0.5, 0.5,0.5,0.5,0.5, 0.5,0.5,0.5,0.5],
        kickSample: 'kick_punch',
        snareSample: 'snare_crack',
        hatSample: 'hat_open',
    },
    chaos: {
        bpm: 140,
        swing: 0.05,
        kickPattern: [1,0,0,0.7, 0,0,1,0, 0,0.5,0,0, 1,0,0,0.6],
        snarePattern: [0,0,0,0.4, 1,0,0,0, 0,0.3,0,0.5, 1,0,0.7,0],
        hatPattern: [0.7,0.4,0.6,0.5, 0.7,0.3,0.6,0.4, 0.7,0.5,0.6,0.4, 0.7,0.3,0.8,0.5],
        kickSample: 'kick_sub',
        snareSample: 'snare_rim',
        hatSample: 'hat_shaker',
    }
};

// Tone presets - different filter/character
const TONES = {
    warm: { filter: 2500, resonance: 0.8, saturation: 1.2 },
    bright: { filter: 8000, resonance: 1.2, saturation: 0.8 },
    dark: { filter: 800, resonance: 2.5, saturation: 1.5 },
    glass: { filter: 12000, resonance: 3, saturation: 0.5 },
};

// Space presets - reverb/delay
const SPACES = {
    room: { verbMix: 0.15, verbDecay: 0.8, dlyMix: 0.08, dlyTime: 0.25 },
    hall: { verbMix: 0.35, verbDecay: 2.5, dlyMix: 0.15, dlyTime: 0.5 },
    void: { verbMix: 0.55, verbDecay: 4.0, dlyMix: 0.3, dlyTime: 0.75 },
    tight: { verbMix: 0.05, verbDecay: 0.3, dlyMix: 0.02, dlyTime: 0.1 },
};

// Sequencer state
let step = 0;
let lastStepTime = 0;

// Synth
let bassOsc, bassFilter, bassGain;
let padOscs = [];
let padFilter, padGain;

// ============ SAMPLE LOADING ============

async function loadSamples() {
    const entries = Object.entries(SAMPLE_URLS);
    for (const [name, url] of entries) {
        try {
            const res = await fetch(url);
            const buf = await res.arrayBuffer();
            samples[name] = await ctx.decodeAudioData(buf);
        } catch (e) {
            console.warn('Failed to load:', name);
            samples[name] = createFallbackSample(name);
        }
    }
}

function createFallbackSample(name) {
    const len = ctx.sampleRate * 0.3;
    const buf = ctx.createBuffer(2, len, ctx.sampleRate);
    for (let ch = 0; ch < 2; ch++) {
        const d = buf.getChannelData(ch);
        if (name.includes('kick')) {
            for (let i = 0; i < len; i++) {
                const t = i / ctx.sampleRate;
                const pitch = 80 * Math.exp(-t * 30) + 40;
                d[i] = Math.sin(TAU * pitch * t) * Math.exp(-t * 12) * 0.8;
            }
        } else if (name.includes('snare')) {
            for (let i = 0; i < len; i++) {
                const t = i / ctx.sampleRate;
                const noise = (Math.random() * 2 - 1) * 0.6;
                const tone = Math.sin(TAU * 200 * t) * 0.3;
                d[i] = (noise + tone) * Math.exp(-t * 18);
            }
        } else {
            for (let i = 0; i < len * 0.1; i++) {
                const t = i / ctx.sampleRate;
                d[i] = (Math.random() * 2 - 1) * Math.exp(-t * 50) * 0.3;
            }
        }
    }
    return buf;
}

// ============ AUDIO SETUP ============

function initAudio() {
    drumBus = ctx.createGain();
    drumBus.gain.value = 0.75;

    synthBus = ctx.createGain();
    synthBus.gain.value = 0.5;

    masterBus = ctx.createGain();
    masterBus.gain.value = 1;

    // Lo-fi filter
    lofi = ctx.createBiquadFilter();
    lofi.type = 'lowpass';
    lofi.frequency.value = 4000;
    lofi.Q.value = 0.5;

    // Saturation
    const sat = ctx.createWaveShaper();
    const curve = new Float32Array(65536);
    for (let i = 0; i < 65536; i++) {
        const x = (i / 32768) - 1;
        curve[i] = Math.tanh(x * 1.5) * 0.9;
    }
    sat.curve = curve;
    sat.oversample = '2x';

    // Compressor
    comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -12;
    comp.ratio.value = 4;
    comp.attack.value = 0.003;
    comp.release.value = 0.15;

    // Limiter
    lim = ctx.createDynamicsCompressor();
    lim.threshold.value = -1;
    lim.ratio.value = 20;
    lim.attack.value = 0.001;
    lim.release.value = 0.05;

    // Reverb
    verb = ctx.createConvolver();
    const verbLen = ctx.sampleRate * 3;
    const verbBuf = ctx.createBuffer(2, verbLen, ctx.sampleRate);
    for (let ch = 0; ch < 2; ch++) {
        const d = verbBuf.getChannelData(ch);
        for (let i = 0; i < verbLen; i++) {
            d[i] = (Math.random() * 2 - 1) * Math.exp(-i / ctx.sampleRate / 1.5) * 0.4;
        }
    }
    verb.buffer = verbBuf;
    verbWet = ctx.createGain();
    verbWet.gain.value = 0.15;

    // Delay
    dly = ctx.createDelay(2);
    dly.delayTime.value = 0.25;
    const dlyFb = ctx.createGain();
    dlyFb.gain.value = 0.35;
    const dlyFilter = ctx.createBiquadFilter();
    dlyFilter.type = 'lowpass';
    dlyFilter.frequency.value = 2000;
    dly.connect(dlyFilter).connect(dlyFb).connect(dly);
    dlyWet = ctx.createGain();
    dlyWet.gain.value = 0.08;
    dlyFilter.connect(dlyWet);

    // Master
    master = ctx.createGain();
    master.gain.value = 0.85;

    // Routing
    drumBus.connect(masterBus);
    synthBus.connect(masterBus);
    masterBus.connect(sat).connect(lofi).connect(comp);
    masterBus.connect(verb);
    verb.connect(verbWet);
    masterBus.connect(dly);
    comp.connect(lim);
    verbWet.connect(lim);
    dlyWet.connect(lim);
    lim.connect(master).connect(ctx.destination);
}

function initSynths() {
    // Bass - simple sine sub
    bassOsc = ctx.createOscillator();
    bassOsc.type = 'sine';
    bassOsc.frequency.value = 55;
    bassFilter = ctx.createBiquadFilter();
    bassFilter.type = 'lowpass';
    bassFilter.frequency.value = 200;
    bassGain = ctx.createGain();
    bassGain.gain.value = 0;
    bassOsc.connect(bassFilter).connect(bassGain).connect(synthBus);
    bassOsc.start();

    // Pad - 4 detuned voices
    padFilter = ctx.createBiquadFilter();
    padFilter.type = 'lowpass';
    padFilter.frequency.value = 1200;
    padGain = ctx.createGain();
    padGain.gain.value = 0;
    padFilter.connect(padGain).connect(synthBus);

    for (let i = 0; i < 4; i++) {
        const osc = ctx.createOscillator();
        osc.type = i < 2 ? 'sine' : 'triangle';
        osc.frequency.value = 220;
        osc.detune.value = (i - 1.5) * 8;
        const g = ctx.createGain();
        g.gain.value = 0.12;
        osc.connect(g).connect(padFilter);
        osc.start();
        padOscs.push({ osc, gain: g });
    }
}

// ============ PLAYBACK ============

function playSample(name, opts = {}) {
    const buf = samples[name];
    if (!buf) return;

    const src = ctx.createBufferSource();
    src.buffer = buf;
    if (opts.rate) src.playbackRate.value = opts.rate;

    const g = ctx.createGain();
    g.gain.value = opts.vol || 0.8;

    if (opts.pan) {
        const pan = ctx.createStereoPanner();
        pan.pan.value = opts.pan;
        src.connect(pan).connect(g);
    } else {
        src.connect(g);
    }

    g.connect(opts.bus || drumBus);
    src.start(ctx.currentTime + (opts.delay || 0));
}

// ============ SEQUENCER ============

function updateSequencer() {
    const groove = GROOVES[dial.groove];
    if (!groove) return;

    const stepDur = 60 / groove.bpm / 4;
    const now = ctx.currentTime;

    if (now - lastStepTime >= stepDur) {
        lastStepTime = now;

        const s = step % 16;
        const swing = (s % 2 === 1) ? stepDur * groove.swing : 0;

        // Energy-responsive velocity scaling
        const energyBoost = 1 + music.intensity * 0.3;

        // Kick
        if (groove.kickPattern[s] > 0) {
            const vel = groove.kickPattern[s] * energyBoost * (0.85 + Math.random() * 0.15);
            playSample(groove.kickSample, { vol: vel * 0.9, delay: swing });
        }

        // Snare
        if (groove.snarePattern[s] > 0) {
            const vel = groove.snarePattern[s] * energyBoost * (0.85 + Math.random() * 0.15);
            playSample(groove.snareSample, {
                vol: vel * 0.75,
                delay: swing,
                pan: (Math.random() - 0.5) * 0.15
            });
        }

        // Hats
        if (groove.hatPattern[s] > 0) {
            const vel = groove.hatPattern[s] * (0.8 + music.intensity * 0.3);
            playSample(groove.hatSample, {
                vol: vel * 0.5,
                delay: swing,
                pan: (Math.random() - 0.5) * 0.4,
                rate: 0.95 + Math.random() * 0.1
            });
        }

        // Random perc based on intensity
        if (Math.random() < music.intensity * 0.15 && s % 4 === 2) {
            playSample('perc_click', {
                vol: 0.25,
                delay: swing,
                pan: (Math.random() - 0.5) * 0.6
            });
        }

        // Track bars
        if (s === 0) music.bar++;
        music.beat = s;

        step++;
    }
}

// ============ SYNTH UPDATES ============

const BASS_NOTES = [1, 1, 4/3, 3/2]; // I, I, IV, V pattern

function updateBass() {
    const baseFreq = 55;
    const noteIndex = music.bar % 4;
    const targetFreq = baseFreq * BASS_NOTES[noteIndex];

    // Pitch follows Y position slightly
    const yMod = 1 + (field.y - 0.5) * 0.15;
    bassOsc.frequency.linearRampToValueAtTime(targetFreq * yMod, ctx.currentTime + 0.05);

    // Volume follows energy
    const vol = 0.25 + music.intensity * 0.25;
    bassGain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.1);

    // Filter opens with energy
    const tone = TONES[dial.tone];
    const filterMod = 1 + field.energy * 3;
    bassFilter.frequency.linearRampToValueAtTime(200 * filterMod, ctx.currentTime + 0.05);
}

const CHORD_PROGRESSIONS = [
    [0, 4, 7],    // I (major)
    [0, 3, 7],    // i (minor)
    [5, 9, 12],   // IV
    [7, 11, 14],  // V
];

function updatePad() {
    const baseFreq = 220;
    const chordIndex = music.bar % 4;
    const chord = CHORD_PROGRESSIONS[chordIndex];

    // X position shifts chord voicing
    const xShift = (field.x - 0.5) * 0.2;

    padOscs.forEach((p, i) => {
        const note = chord[i % chord.length];
        const freq = baseFreq * Math.pow(2, (note + xShift * 12) / 12);
        p.osc.frequency.linearRampToValueAtTime(freq, ctx.currentTime + 0.15);
    });

    // Volume: louder when still, quieter when moving
    const stillness = Math.max(0, 1 - field.energy * 5);
    const vol = stillness * 0.15 * music.intensity;
    padGain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.2);

    // Filter follows tone setting
    const tone = TONES[dial.tone];
    padFilter.frequency.linearRampToValueAtTime(tone.filter * 0.5, ctx.currentTime + 0.1);
}

// ============ EFFECTS ============

function updateEffects() {
    const tone = TONES[dial.tone];
    const space = SPACES[dial.space];

    // Master filter from tone + energy
    const filterMod = 1 + field.energy * 2 + music.intensity * 0.5;
    lofi.frequency.linearRampToValueAtTime(
        Math.min(18000, tone.filter * filterMod),
        ctx.currentTime + 0.1
    );
    lofi.Q.value = tone.resonance;

    // Space settings
    verbWet.gain.linearRampToValueAtTime(space.verbMix, ctx.currentTime + 0.2);
    dlyWet.gain.linearRampToValueAtTime(space.dlyMix, ctx.currentTime + 0.2);
    dly.delayTime.linearRampToValueAtTime(space.dlyTime, ctx.currentTime + 0.3);
}

// ============ INPUT ============

function onMove(nx, ny) {
    const dx = nx - field.x;
    const dy = ny - field.y;
    field.vx = field.vx * 0.7 + dx * 0.3;
    field.vy = field.vy * 0.7 + dy * 0.3;
    field.x += dx * 0.15;
    field.y += dy * 0.15;
    field.energy = field.energy * 0.85 + Math.sqrt(dx * dx + dy * dy) * 3;
    field.peak = Math.max(field.peak * 0.97, field.energy);
}

function onMotion(e) {
    const a = e.accelerationIncludingGravity;
    if (!a) return;
    const ax = (a.x || 0) / 10;
    const ay = (a.y || 0) / 10;
    field.x = Math.max(0, Math.min(1, field.x + ax * 0.08));
    field.y = Math.max(0, Math.min(1, field.y - ay * 0.08));
    field.energy = field.energy * 0.85 + Math.sqrt(ax * ax + ay * ay) * 0.7;
    field.peak = Math.max(field.peak * 0.97, field.energy);
}

function onOrientation(e) {
    const gx = (e.gamma || 0) / 45;
    const gy = (e.beta || 0) / 45 - 0.5;
    onMove((gx + 1) / 2, (1 - gy) / 2);
}

// ============ DIALS ============

function initDials() {
    document.querySelectorAll('.dial-group').forEach(group => {
        const name = group.dataset.dial;
        group.querySelectorAll('.dial-opt').forEach(opt => {
            opt.addEventListener('click', e => {
                e.stopPropagation();
                group.querySelectorAll('.dial-opt').forEach(o => o.classList.remove('on'));
                opt.classList.add('on');
                dial[name] = opt.dataset.v;

                // Reset sequencer on groove change
                if (name === 'groove') {
                    step = 0;
                    lastStepTime = ctx.currentTime;
                }

                // Update effects immediately on tone/space change
                updateEffects();
            });
            opt.addEventListener('touchend', e => e.stopPropagation());
        });
    });
}

// ============ VISUALS ============

function resize() {
    const dpr = devicePixelRatio || 1;
    canvas.width = innerWidth * dpr;
    canvas.height = innerHeight * dpr;
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    vc.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function draw() {
    const w = innerWidth, h = innerHeight;

    // Fade with intensity
    vc.fillStyle = `rgba(10,10,15,${0.12 + music.intensity * 0.04})`;
    vc.fillRect(0, 0, w, h);

    // Center glow
    const gradient = vc.createRadialGradient(w/2, h/2, 0, w/2, h/2, 150);
    gradient.addColorStop(0, `rgba(180,160,220,${0.02 + music.intensity * 0.02})`);
    gradient.addColorStop(1, 'rgba(180,160,220,0)');
    vc.fillStyle = gradient;
    vc.beginPath();
    vc.arc(w/2, h/2, 150, 0, TAU);
    vc.fill();

    // Beat pulse ring
    const beatPhase = (music.beat % 4) / 4;
    const pulseR = 60 + (1 - beatPhase) * 40 * music.intensity;
    vc.strokeStyle = `rgba(200,180,255,${0.05 + (1 - beatPhase) * 0.1 * music.intensity})`;
    vc.lineWidth = 1;
    vc.beginPath();
    vc.arc(w/2, h/2, pulseR, 0, TAU);
    vc.stroke();

    // Cursor position
    const cx = field.x * w;
    const cy = field.y * h;

    // Energy ring around cursor
    const energyR = 8 + field.energy * 30;
    vc.strokeStyle = `rgba(200,180,255,${0.1 + field.energy * 0.4})`;
    vc.beginPath();
    vc.arc(cx, cy, energyR, 0, TAU);
    vc.stroke();

    // Cursor dot
    vc.fillStyle = `rgba(220,200,255,${0.4 + field.energy * 0.4})`;
    vc.beginPath();
    vc.arc(cx, cy, 4 + field.energy * 6, 0, TAU);
    vc.fill();

    // Info
    const groove = GROOVES[dial.groove];
    if (groove) {
        vc.fillStyle = 'rgba(200,180,255,0.15)';
        vc.font = '10px system-ui';
        vc.fillText(`${groove.bpm} bpm`, 15, 25);
    }
}

// ============ MAIN LOOP ============

function tick() {
    if (!running) return;

    field.time += 1/60;
    field.energy *= 0.96;

    // Intensity follows peak energy with lag
    music.intensity = music.intensity * 0.95 + field.peak * 0.05;
    music.intensity = Math.max(0.2, Math.min(1, music.intensity));

    updateSequencer();
    updateBass();
    updatePad();
    updateEffects();
    draw();

    requestAnimationFrame(tick);
}

// ============ INIT ============

async function init() {
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    initAudio();
    initSynths();
    initDials();

    canvas = document.getElementById('c');
    vc = canvas.getContext('2d');
    resize();
    addEventListener('resize', resize);

    await loadSamples();

    document.getElementById('loading').classList.add('off');
    document.getElementById('ui').style.display = 'block';
}

async function start() {
    document.getElementById('enter').classList.add('off');
    document.getElementById('loading').classList.remove('off');

    // Request permissions
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
        try { await DeviceMotionEvent.requestPermission(); } catch (e) {}
    }
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
    }

    await init();

    // Input handlers
    addEventListener('devicemotion', onMotion);
    addEventListener('deviceorientation', onOrientation);
    canvas.addEventListener('mousemove', e => onMove(e.clientX / innerWidth, e.clientY / innerHeight));
    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        onMove(e.touches[0].clientX / innerWidth, e.touches[0].clientY / innerHeight);
    }, { passive: false });
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        onMove(e.touches[0].clientX / innerWidth, e.touches[0].clientY / innerHeight);
    }, { passive: false });

    if (ctx.state === 'suspended') await ctx.resume();

    running = true;
    lastStepTime = ctx.currentTime;
    tick();
}

document.getElementById('enter').addEventListener('click', start);
</script>
</body>
</html>
