<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Soundtrack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle, #001122 0%, #000 100%);
      color: #00ffaa;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      text-align: center;
    }
    
    .title {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px #00ffaa;
      animation: pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { text-shadow: 0 0 20px #00ffaa; }
      to { text-shadow: 0 0 30px #00ffaa, 0 0 40px #00aa88; }
    }
    
    .btn {
      padding: 15px 30px;
      background: linear-gradient(45deg, #00ffaa, #00aa88);
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 10px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,255,170,0.3);
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(0,255,170,0.5);
    }
    
    .status {
      background: rgba(0,255,170,0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 400px;
      backdrop-filter: blur(10px);
    }
    
    .motion-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,255,170,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .motion-progress {
      height: 100%;
      background: linear-gradient(90deg, #00ffaa, #00aa88);
      transition: width 0.3s ease;
      box-shadow: 0 0 15px rgba(0,255,170,0.5);
    }
    
    .rhythm-viz {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
    }
    
    .beat {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0,255,170,0.3);
      transition: all 0.2s;
    }
    
    .beat.active {
      background: #00ffaa;
      box-shadow: 0 0 15px #00ffaa;
      transform: scale(1.4);
    }
    
    .beat.kick {
      background: #ff6b6b;
      box-shadow: 0 0 15px #ff6b6b;
    }
    
    .beat.snare {
      background: #4ecdc4;
      box-shadow: 0 0 15px #4ecdc4;
    }
    
    .beat.playing {
      animation: beatPulse 0.2s ease-out;
    }
    
    @keyframes beatPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.8); }
      100% { transform: scale(1); }
    }
    
    .debug {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 10px;
    }
    
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="title">MOTION SOUNDTRACK</h1>
  <button class="btn" id="startBtn">START LISTENING</button>
  
  <div class="status hidden" id="status">
    <div>Motion: <span id="motionLevel">0</span>%</div>
    <div>State: <span id="currentState">Still</span></div>
    <div>Tempo: <span id="tempoDisplay">0</span> BPM</div>
    <div class="motion-bar">
      <div class="motion-progress" id="progress"></div>
    </div>
    <div class="rhythm-viz" id="rhythm"></div>
    <div class="debug">
      Playing: <span id="playingState">No</span> | 
      Input: <span id="inputMode">-</span> |
      Steps: <span id="stepCount">0</span>
    </div>
  </div>

  <script>
    let motion = 0;
    let motionHistory = [];
    let isPlaying = false;
    let step = 0;
    let synths = {};
    let lastMouseX = 0, lastMouseY = 0;
    let inputMode = 'none';
    let motionThreshold = 5; // Lower threshold for starting music
    let stopThreshold = 2;   // Even lower for stopping
    let lastMotionTime = 0;
    let musicFadeTimeout = null;
    let baseTempo = 88;
    let currentTempo = baseTempo;
    
    const patterns = {
      kick: [1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],
      snare: [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      openhat: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      bass: [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]
    };
    
    document.getElementById('startBtn').onclick = async () => {
      await Tone.start();
      
      let permissionGranted = false;
      
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          permissionGranted = response === 'granted';
          inputMode = 'device';
        } catch (e) {
          console.log('Permission request failed:', e);
        }
      } else if (typeof DeviceMotionEvent !== 'undefined') {
        permissionGranted = true;
        inputMode = 'device';
      }
      
      initAudio();
      
      if (permissionGranted) {
        window.addEventListener('devicemotion', handleMotion, { passive: true });
      } else {
        inputMode = 'mouse/touch';
        document.addEventListener('mousemove', handleMouseMotion, { passive: true });
        document.addEventListener('touchmove', handleTouchMotion, { passive: true });
      }
      
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
      
      // Start the main update loop
      setInterval(updateMusicState, 100);
      updateUI();
    };
    
    function initAudio() {
      synths.kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 10,
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
      }).toDestination();
      
      synths.snare = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.13, sustain: 0.2, release: 0.03 }
      }).toDestination();
      
      synths.hihat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.02, sustain: 0.0, release: 0.01 }
      }).toDestination();
      
      synths.openhat = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0.05, release: 0.05 }
      }).toDestination();
      
      synths.bass = new Tone.MonoSynth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.1, release: 1.0 },
        filter: { Q: 6, type: 'lowpass', rolloff: -24 },
        filterEnvelope: { attack: 0.001, decay: 0.5, sustain: 0.1, release: 1.0, baseFrequency: 200, octaves: 2.6 }
      }).toDestination();
      
      synths.pad = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sawtooth' },
        envelope: { attack: 0.8, decay: 0.2, sustain: 0.6, release: 2.0 },
        filter: { Q: 1, type: 'lowpass', rolloff: -12 }
      }).toDestination();
      
      // Volume adjustments
      synths.kick.volume.value = -8;
      synths.snare.volume.value = -12;
      synths.hihat.volume.value = -18;
      synths.openhat.volume.value = -16;
      synths.bass.volume.value = -10;
      synths.pad.volume.value = -20;
      
      // Don't start transport yet - we'll control it based on motion
    }
    
    function startMusic() {
      if (!isPlaying) {
        isPlaying = true;
        
        // Set tempo based on motion
        currentTempo = Math.max(60, Math.min(140, baseTempo + (motion * 0.8)));
        Tone.Transport.bpm.value = currentTempo;
        
        // Clear any pending stop timeout
        if (musicFadeTimeout) {
          clearTimeout(musicFadeTimeout);
          musicFadeTimeout = null;
        }
        
        // Start or resume transport
        if (Tone.Transport.state === 'stopped') {
          Tone.Transport.start();
        }
        
        // Schedule the beat pattern
        Tone.Transport.scheduleRepeat((time) => {
          if (isPlaying) {
            const pos = step % 16;
            const intensity = Math.max(0.1, motion / 100);
            
            dropTheBeat(pos, time, intensity);
            updateRhythm(pos);
            step++;
          }
        }, '16n');
      }
    }
    
    function stopMusic() {
      if (isPlaying) {
        isPlaying = false;
        
        // Fade out gracefully after a short delay
        musicFadeTimeout = setTimeout(() => {
          if (!isPlaying) {
            Tone.Transport.stop();
            Tone.Transport.cancel(); // Clear scheduled events
            clearRhythm();
          }
        }, 500); // Give 500ms grace period
      }
    }
    
    function updateMusicState() {
      // Smooth motion decay
      if (motion > 0) {
        motion *= 0.92; // Gradual decay
        if (motion < 0.5) motion = 0;
      }
      
      // Check if we should start or stop music
      if (motion > motionThreshold && !isPlaying) {
        startMusic();
      } else if (motion < stopThreshold && isPlaying) {
        stopMusic();
      }
      
      // Update tempo in real-time if playing
      if (isPlaying && motion > 0) {
        const targetTempo = Math.max(60, Math.min(140, baseTempo + (motion * 0.8)));
        currentTempo = currentTempo * 0.9 + targetTempo * 0.1; // Smooth tempo changes
        Tone.Transport.bpm.value = currentTempo;
      }
    }
    
    function dropTheBeat(pos, time, intensity) {
      const elements = document.querySelectorAll('.beat');
      
      if (patterns.kick[pos]) {
        synths.kick.triggerAttackRelease('C1', '8n', time, Math.min(1, intensity * 1.2));
        if (elements[pos]) elements[pos].classList.add('playing');
      }
      
      if (patterns.snare[pos] && intensity > 0.3) {
        synths.snare.triggerAttackRelease('8n', time, Math.min(1, intensity * 0.9));
      }
      
      if (patterns.hihat[pos] && intensity > 0.2) {
        synths.hihat.triggerAttackRelease('32n', time, intensity * 0.7);
      }
      
      if (patterns.openhat[pos] && intensity > 0.6) {
        synths.openhat.triggerAttackRelease('16n', time, intensity * 0.8);
      }
      
      if (patterns.bass[pos] && intensity > 0.4) {
        const notes = ['E1', 'A1', 'D1', 'G1'];
        const note = notes[Math.floor(intensity * 4) % 4];
        synths.bass.triggerAttackRelease(note, '4n', time, Math.min(1, intensity * 1.1));
      }
      
      if (intensity > 0.7 && pos % 8 === 0) {
        const chords = [
          ['A2', 'C3', 'E3'],
          ['F2', 'A2', 'C3'],
          ['G2', 'B2', 'D3'],
          ['D2', 'F#2', 'A2']
        ];
        const chord = chords[Math.floor(step / 16) % 4];
        synths.pad.triggerAttackRelease(chord, '2n', time, intensity * 0.4);
      }
      
      // Clear playing animation after a delay
      setTimeout(() => {
        if (elements[pos]) elements[pos].classList.remove('playing');
      }, 200);
    }
    
    function handleMotion(event) {
      const acc = event.accelerationIncludingGravity;
      if (acc && acc.x !== null && acc.y !== null && acc.z !== null) {
        // Calculate motion magnitude
        const total = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
        const motionDelta = Math.abs(total - 9.8); // Remove gravity baseline
        
        // Boost the motion signal and make it more responsive
        motion = Math.min(100, motionDelta * 15);
        lastMotionTime = Date.now();
        
        smoothMotion();
      }
    }
    
    function handleMouseMotion(event) {
      const speed = Math.sqrt(
        Math.pow(event.clientX - lastMouseX, 2) + 
        Math.pow(event.clientY - lastMouseY, 2)
      );
      
      motion = Math.min(100, speed * 2);
      lastMouseX = event.clientX;
      lastMouseY = event.clientY;
      lastMotionTime = Date.now();
      
      smoothMotion();
    }
    
    function handleTouchMotion(event) {
      if (event.touches.length > 0) {
        const touch = event.touches[0];
        const speed = Math.sqrt(
          Math.pow(touch.clientX - lastMouseX, 2) + 
          Math.pow(touch.clientY - lastMouseY, 2)
        );
        
        motion = Math.min(100, speed * 1.5);
        lastMouseX = touch.clientX;
        lastMouseY = touch.clientY;
        lastMotionTime = Date.now();
        
        smoothMotion();
      }
    }
    
    function smoothMotion() {
      motionHistory.push(motion);
      if (motionHistory.length > 3) motionHistory.shift();
      motion = motionHistory.reduce((a, b) => a + b) / motionHistory.length;
    }
    
    function updateUI() {
      document.getElementById('motionLevel').textContent = Math.round(motion);
      document.getElementById('tempoDisplay').textContent = Math.round(currentTempo);
      document.getElementById('playingState').textContent = isPlaying ? 'Yes' : 'No';
      document.getElementById('inputMode').textContent = inputMode;
      document.getElementById('stepCount').textContent = step;
      
      const state = 
        motion < 5 ? 'Still' :
        motion < 20 ? 'Gentle' :
        motion < 50 ? 'Active' :
        motion < 80 ? 'Energetic' : 'Intense';
      document.getElementById('currentState').textContent = state;
      
      document.getElementById('progress').style.width = motion + '%';
      
      requestAnimationFrame(updateUI);
    }
    
    function updateRhythm(pos) {
      const rhythm = document.getElementById('rhythm');
      rhythm.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const beat = document.createElement('div');
        let className = 'beat';
        if (i === pos) className += ' active';
        if (patterns.kick[i]) className += ' kick';
        if (patterns.snare[i]) className += ' snare';
        beat.className = className;
        rhythm.appendChild(beat);
      }
    }
    
    function clearRhythm() {
      const rhythm = document.getElementById('rhythm');
      rhythm.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const beat = document.createElement('div');
        beat.className = 'beat';
        rhythm.appendChild(beat);
      }
    }
  </script>
</body>
</html>
