<!DOCTYPE html>
<html><head><title>Motion 2.0</title><script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>*{margin:0;padding:0;font-family:monospace}body{background:radial-gradient(circle,#001122,#000);color:#0fa;text-align:center;padding:20px;min-height:100vh;transition:all 2s}.btn{padding:15px 30px;background:#0fa;color:#000;border:none;border-radius:10px;cursor:pointer;font-size:1.1rem;margin:10px;font-weight:bold;box-shadow:0 0 20px rgba(0,255,170,.3)}.status{background:rgba(0,255,170,.1);padding:20px;border-radius:10px;margin:20px auto;max-width:400px}.bar{width:100%;height:20px;background:rgba(0,255,170,.1);border-radius:10px;overflow:hidden;margin:10px 0}.progress{height:100%;background:linear-gradient(90deg,#0fa,#0a8);transition:width .3s;box-shadow:0 0 15px rgba(0,255,170,.5)}.viz{display:flex;justify-content:center;gap:8px;margin:15px 0}.beat{width:20px;height:20px;border-radius:50%;background:rgba(0,255,170,.3);transition:all .2s}.beat.active{background:#0fa;box-shadow:0 0 15px #0fa;transform:scale(1.4)}.hidden{display:none}</style></head>
<body><h1>MOTION SOUNDTRACK 2.0</h1><button class="btn" id="start">START LISTENING</button>
<div class="status hidden" id="ui">
<div>Motion: <span id="motion">0</span>% | State: <span id="state">Still</span> | Weather: <span id="weather">...</span></div>
<div>Phase: <span id="phase">Opening</span> | Time: <span id="time">...</span></div>
<div class="bar"><div class="progress" id="bar"></div></div>
<div class="viz" id="viz"></div></div>

<script>
let m=0,step=0,phase=0,s={},w='clear',tod='day',patterns={k:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],s:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],h:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],b:[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]},lx=0,ly=0,mh=[];

document.getElementById('start').onclick=async()=>{
await Tone.start();
// Ultra-compact synth setup
s.k=new Tone.MembraneSynth({envelope:{attack:0,decay:.4,sustain:.01,release:1.4}}).toDestination();
s.s=new Tone.NoiseSynth({envelope:{attack:0,decay:.13,sustain:.2,release:.03}}).toDestination();
s.h=new Tone.NoiseSynth({envelope:{attack:0,decay:.02,sustain:0,release:.01}}).toDestination();
s.b=new Tone.MonoSynth({oscillator:{type:'sine'},envelope:{attack:0,decay:.4,sustain:.1,release:1}}).toDestination();
s.p=new Tone.PolySynth(Tone.Synth,{oscillator:{type:'sawtooth'},envelope:{attack:.8,decay:.2,sustain:.6,release:2}}).toDestination();
s.k.volume.value=-8;s.s.volume.value=-12;s.h.volume.value=-18;s.b.volume.value=-10;s.p.volume.value=-20;

Tone.Transport.bpm.value=88;Tone.Transport.start();

// Main sequencer with phase evolution
Tone.Transport.scheduleRepeat((time)=>{
let pos=step%16,i=m/100;
if(i>.2)beat(pos,time,i);
updatePhase();updateViz(pos);step++;
},'16n');

startMotion();getWeather();
document.getElementById('start').classList.add('hidden');
document.getElementById('ui').classList.remove('hidden');
updateUI();
};

function beat(pos,time,i){
// Weather modulation: rain=reverb, snow=delay, sun=brightness
let wm=w=='rain'?{vol:.8,decay:2}:w=='snow'?{vol:.9,attack:.1}:w=='sun'?{vol:1.2,bright:1}:{vol:1,bright:0};
// Time modulation: morning=bright, night=dark, evening=warm
let tm=tod=='morning'?{bpm:95,brightness:1.3}:tod=='night'?{bpm:75,darkness:.7}:tod=='evening'?{bpm:82,warmth:1.2}:{bpm:88};

// Adaptive patterns based on phase
if(patterns.k[pos]&&i>.25)s.k.triggerAttackRelease('C1','8n',time,Math.min(1,i*1.2*wm.vol));
if(patterns.s[pos]&&i>.3)s.s.triggerAttackRelease('8n',time,Math.min(1,i*.9*wm.vol));
if(patterns.h[pos]&&i>.35)s.h.triggerAttackRelease('32n',time,i*.7*wm.vol);
if(patterns.b[pos]&&i>.4){
let notes=tod=='morning'?['E1','A1','D1','G1']:tod=='night'?['C1','F1','Bb1','Eb1']:['A1','D1','G1','C1'];
s.b.triggerAttackRelease(notes[Math.floor(i*4)%4],'4n',time,Math.min(1,i*1.1*wm.vol));
}

// Evolving chord progressions
if(i>.7&&pos%8===0){
let chords=phase<32?[['A2','C3','E3'],['F2','A2','C3']]:phase<64?[['Em','G','B'],['Am','C','E']]:w=='rain'?[['Dm','F','A'],['Gm','Bb','D']]:tod=='night'?[['Cm','Eb','G'],['Fm','Ab','C']]:tod=='morning'?[['C','E','G'],['F','A','C']]:tod=='evening'?[['Am','C','E'],['Dm','F','A']]:[];
if(chords.length)s.p.triggerAttackRelease(chords[Math.floor(step/16)%chords.length],'2n',time,i*.4*wm.vol);
}

// BPM adaptation
if(step%32===0)Tone.Transport.bpm.rampTo(tm.bpm||88,2);
}

function updatePhase(){
phase=Math.floor(step/16);
let phases=['Opening','Building','Weather Sync','Time Adapt','Full Evolution'];
document.getElementById('phase').textContent=phases[Math.min(phase,4)];
// Evolve patterns based on phase
if(phase===2)patterns.h=[1,1,0,1,1,0,1,1,1,0,1,1,0,1,1,0]; // More complex hihats
if(phase===3)patterns.k=[1,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0]; // Syncopated kicks
if(phase===4)patterns.s=[0,0,1,0,1,0,0,1,0,0,1,0,1,0,0,1]; // Complex snares
}

function startMotion(){
if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
DeviceMotionEvent.requestPermission().then(r=>r==='granted'?window.addEventListener('devicemotion',handleMotion):fallback()).catch(fallback);
}else if(typeof DeviceMotionEvent!=='undefined'){
window.addEventListener('devicemotion',handleMotion);
}else fallback();
}

function fallback(){document.addEventListener('mousemove',e=>{m=Math.min(100,Math.sqrt((e.clientX-lx)**2+(e.clientY-ly)**2)*3);lx=e.clientX;ly=e.clientY;smooth();});}

function handleMotion(e){
let a=e.accelerationIncludingGravity;
if(a&&a.x!==null)m=Math.min(100,Math.max(0,(Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)-9)*10));
smooth();
}

function smooth(){mh.push(m);if(mh.length>5)mh.shift();m=mh.reduce((a,b)=>a+b)/mh.length;}

function getWeather(){
navigator.geolocation?navigator.geolocation.getCurrentPosition(pos=>{
fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&appid=demo&units=metric`)
.then(r=>r.json()).then(d=>{
w=d.weather?d.weather[0].main.toLowerCase():'clear';
document.getElementById('weather').textContent=w;
updateTheme();
}).catch(()=>w='clear');
},()=>w='clear'):w='clear';
}

function updateTheme(){
let bg=w=='rain'?'#002244':w=='snow'?'#224466':w=='sun'?'#332200':w=='clouds'?'#112233':'#001122';
document.body.style.background=`radial-gradient(circle,${bg},#000)`;
}

function updateUI(){
document.getElementById('motion').textContent=Math.round(m);
document.getElementById('state').textContent=m<5?'Still':m<20?'Gentle':m<50?'Active':m<80?'Energetic':'Intense';
document.getElementById('bar').style.width=m+'%';
let h=new Date().getHours();
tod=h<6?'night':h<12?'morning':h<18?'day':h<21?'evening':'night';
document.getElementById('time').textContent=tod;
requestAnimationFrame(updateUI);
}

function updateViz(pos){
let viz=document.getElementById('viz');
viz.innerHTML='';
for(let i=0;i<16;i++){
let beat=document.createElement('div');
beat.className='beat'+(i===pos?' active':'')+(patterns.k[i]?' kick':'')+(patterns.s[i]?' snare':'');
viz.appendChild(beat);
}}
</script></body></html>
