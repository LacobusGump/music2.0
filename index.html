<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Music 2.0 – Dynamic Soundtrack</title>
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      @apply m-0 min-h-screen flex flex-col justify-center items-center text-white bg-gradient-to-b from-blue-900 to-purple-600 transition-colors duration-1000;
    }
    #status{font-size:.9rem;opacity:.8}
    #controls{display:flex;flex-wrap:wrap;gap:.75rem}
    canvas{margin-top:1rem;width:100%;max-width:320px;height:96px}
    .fade-to-black{background:black !important;transition:background 2s ease-in;}
    .particle{position:absolute;border-radius:50%;pointer-events:none;box-shadow:0 0 15px rgba(255,255,255,.7)}
  </style>
</head>
<body>
  <div id="ui" class="text-center p-4 max-w-md relative">
    <h1 class="text-3xl font-bold mb-4">Music 2.0 – Your Soundtrack</h1>
    <p class="mb-4">Walk to build your beat, tilt to sculpt the mix.<br>Grant location & motion and then pocket your phone!</p>
    <button id="startBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Start</button>
    <button id="retryBtn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">Retry&nbsp;Permissions</button>
    <div id="status" class="mt-4">Idle …</div>
    <div id="tempoStatus" class="text-sm">Tempo 0&nbsp;BPM</div>
    <div id="chordStatus" class="text-sm">Chord –</div>
    <canvas id="viz"></canvas>
    <div id="controls" class="mt-4">
      <label class="flex items-center"><input type="checkbox" id="padToggle" checked class="mr-1">Pad</label>
      <label class="flex items-center"><input type="checkbox" id="arpToggle" checked class="mr-1">Arp</label>
      <label class="flex items-center"><input type="checkbox" id="drumToggle" checked class="mr-1">Drums</label>
      <label class="flex items-center"><input type="checkbox" id="stringToggle" checked class="mr-1">Strings</label>
      <label class="flex flex-col items-center ml-2 text-xs">Motion ↕
        <input type="range" id="motionRange" min="0.5" max="2" step="0.1" value="1" class="mt-1">
      </label>
    </div>
  </div>

  <script>
  const $ = sel=>document.querySelector(sel);
  const status=$('#status');
  const chordTxt=$('#chordStatus');
  const bpmTxt=$('#tempoStatus');
  const canvas=$('#viz');
  const ctx=canvas.getContext('2d');
  const startBtn=$('#startBtn');
  const retryBtn=$('#retryBtn');
  const padT=$('#padToggle');
  const arpT=$('#arpToggle');
  const drumT=$('#drumToggle');
  const strT=$('#stringToggle');
  const motionR=$('#motionRange');
  const S = {playing:false,bpm:90,chordIndex:0,stepCount:0,lastStep:0,lastShake:0,shifted:[],partsBuilt:false,vibe:'',motionLayer:0};

  const bus=new Tone.Gain(1);
  const rev=new Tone.Reverb({decay:4,wet:0.4});
  const del=new Tone.PingPongDelay({delayTime:'8n',feedback:0.2,wet:0.15});
  bus.chain(rev,del,Tone.Destination);

  const pad=new Tone.PolySynth(Tone.Synth).connect(bus);
  const arp=new Tone.PolySynth(Tone.Synth).connect(bus);
  const drums=new Tone.MembraneSynth().connect(bus);
  const strings=new Tone.PolySynth(Tone.Synth).connect(bus);

  let padLoop, arpLoop, drumLoop, stringLoop;

  function buildParts(){
    padLoop=new Tone.Loop(t=>{if(S.motionLayer>=0) pad.triggerAttackRelease(S.shifted[S.chordIndex],'2m',t);},'2m');
    arpLoop=new Tone.Loop(t=>{if(S.motionLayer>=1){const c=S.shifted[S.chordIndex];c.forEach((n,i)=>arp.triggerAttackRelease(n,'8n',t+i*Tone.Time('16n')));}},'2m');
    drumLoop=new Tone.Loop(t=>{if(S.motionLayer>=2){drums.triggerAttackRelease('C2','8n',t);drums.triggerAttackRelease('C3','8n',t+Tone.Time('4n'));}},'1m');
    stringLoop=new Tone.Loop(t=>{if(S.motionLayer>=3){const n=Tone.Frequency(S.shifted[S.chordIndex][0]).transpose(12).toNote();strings.triggerAttackRelease(n,'1m',t);}},'2m');
    padLoop.start(0);arpLoop.start(0);drumLoop.start(0);stringLoop.start(0);
  }

  async function detectTimeWeather(){
    status.textContent='Detecting time of day…';
    const hour=new Date().getHours();
    const mode=hour<6?'dark':hour<12?'bright':hour<18?'upbeat':'mellow';
    const chords={
      dark:[["C4","Eb4","G4"],["F4","Ab4","C5"],["Ab3","C4","Eb4"],["G3","Bb3","D4"]],
      bright:[["C4","E4","G4"],["F4","A4","C5"],["A3","C4","E4"],["G3","B3","D4"]],
      upbeat:[["G4","B4","D5"],["C4","E4","G4"],["A3","C4","E4"],["G3","B3","D4"]],
      mellow:[["A4","C5","E5"],["F4","A4","C5"],["G4","B4","D5"],["A4","C5","E5"]]
    }[mode];
    S.vibe=mode;S.shifted=chords.map(c=>c.map(n=>Tone.Frequency(n).transpose(3).toNote()));
    chordTxt.textContent=`${S.shifted[0].join(' ')}`;
    await Tone.start();
    pad.triggerAttackRelease(S.shifted[0],'2m');
    await Tone.start();
    await new Promise(r=>setTimeout(r,2000));

    status.textContent='Getting weather…';
    await new Promise(r=>setTimeout(r,1000));
    S.shifted=S.shifted.map(c=>c.map(n=>Tone.Frequency(n).transpose(2).toNote()));
    pad.triggerAttackRelease(S.shifted[1],'2m');
    await new Promise(r=>setTimeout(r,2000));

    document.body.classList.add('fade-to-black');
    status.textContent='Motion control loading…';
    await new Promise(r=>setTimeout(r,2000));
  }

  function startTransport(){
    if(S.playing) return;
    Tone.Transport.bpm.value=S.bpm;
    if(!S.partsBuilt){ buildParts(); S.partsBuilt=true; }
    Tone.Transport.start();
    S.playing=true;
  }

  function handleMotion(e){
    const now=Date.now();
    if(now-S.lastStep<300) return;
    const acc=e.accelerationIncludingGravity;
    const total=Math.sqrt(acc.x**2+acc.y**2+acc.z**2);
    if(total>12 && S.motionLayer<4){
      S.motionLayer++;
      status.textContent=`Layer ${S.motionLayer} activated.`;
    }
    S.lastStep=now;
  }

  startBtn.addEventListener('click',async()=>{
    try{
      await Tone.context.resume();
      if(typeof DeviceMotionEvent?.requestPermission==='function'){
        const p=await DeviceMotionEvent.requestPermission();
        if(p!=='granted') throw new Error('denied');
      }
      await detectTimeWeather();
      startTransport();
      window.addEventListener('devicemotion',handleMotion);
      status.textContent='Motion reactive. Begin walking or moving your phone.';
    }catch(e){
      status.textContent='Error: Motion or audio permission needed.';
      retryBtn.classList.remove('hidden');
    }
  });
  retryBtn.addEventListener('click',()=>startBtn.click());
  </script>
</body>
</html>

