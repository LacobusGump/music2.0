<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Soundtrack</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle, #001122 0%, #000 100%);
      color: #00ffaa;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      text-align: center;
    }
    .title { font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 0 0 20px #00ffaa; animation: pulse 2s ease-in-out infinite alternate; }
    @keyframes pulse { from { text-shadow: 0 0 20px #00ffaa; } to { text-shadow: 0 0 30px #00ffaa, 0 0 40px #00aa88; } }
    .btn { padding: 15px 30px; background: linear-gradient(45deg, #00ffaa, #00aa88); color: #000; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; margin: 10px; font-weight: bold; box-shadow: 0 0 20px rgba(0,255,170,0.3); transition: all 0.3s; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(0,255,170,0.5); }
    .status { background: rgba(0,255,170,0.1); padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; backdrop-filter: blur(10px); }
    .motion-bar { width: 100%; height: 20px; background: rgba(0,255,170,0.1); border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .motion-progress { height: 100%; background: linear-gradient(90deg, #00ffaa, #00aa88); transition: width 0.3s ease; box-shadow: 0 0 15px rgba(0,255,170,0.5); }
    .rhythm-viz { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
    .beat { width: 20px; height: 20px; border-radius: 50%; background: rgba(0,255,170,0.3); transition: all 0.2s; }
    .beat.active { background: #00ffaa; box-shadow: 0 0 15px #00ffaa; transform: scale(1.4); }
    .beat.kick { background: #ff6b6b; box-shadow: 0 0 15px #ff6b6b; }
    .beat.snare { background: #4ecdc4; box-shadow: 0 0 15px #4ecdc4; }
    .beat.playing { animation: beatPulse 0.2s ease-out; }
    @keyframes beatPulse { 0% { transform: scale(1); } 50% { transform: scale(1.8); } 100% { transform: scale(1); } }
    .debug { font-size: 0.8rem; opacity: 0.7; margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="title">MOTION SOUNDTRACK</h1>
  <button class="btn" id="startBtn">START LISTENING</button>
  <div class="status hidden" id="status">
    <div>Motion: <span id="motionLevel">0</span>%</div>
    <div>State: <span id="currentState">Still</span></div>
    <div>Tempo: <span id="tempoDisplay">0</span> BPM</div>
    <div class="motion-bar"><div class="motion-progress" id="progress"></div></div>
    <div class="rhythm-viz" id="rhythm"></div>
    <div class="debug">Playing: <span id="playingState">No</span> | Input: <span id="inputMode">-</span> | Steps: <span id="stepCount">0</span></div>
  </div>

  <script>
    let motion = 0, motionHistory = [], isPlaying = false, step = 0;
    let lastBeta = null, lastGamma = null, inputMode = 'none';
    const motionThreshold = 5, stopThreshold = 2;
    const baseTempo = 88; let currentTempo = baseTempo;
    let musicFadeTimeout = null;

    const patterns = {
      kick:   [1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0],
      snare:  [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
      hihat:  [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
      openhat:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      bass:   [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0]
    };

    document.getElementById('startBtn').onclick = async () => {
      await Tone.start();

      // Always prefer device motion
      if (DeviceMotionEvent?.requestPermission) {
        try {
          if ((await DeviceMotionEvent.requestPermission()) === 'granted') {
            window.addEventListener('devicemotion', handleMotion, { passive: true });
            inputMode = 'device-motion';
          }
        } catch {} 
      } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleMotion, { passive: true });
        inputMode = 'device-motion';
      }

      // Device orientation for tilt
      if (DeviceOrientationEvent?.requestPermission) {
        try {
          if ((await DeviceOrientationEvent.requestPermission()) === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation, { passive: true });
            inputMode = 'device-orientation';
          }
        } catch {} 
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', handleOrientation, { passive: true });
        inputMode = 'device-orientation';
      }

      // No fallback: only motion/orientation drives music
      initAudio();
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('status').classList.remove('hidden');
      setInterval(updateMusicState, 100);
      requestAnimationFrame(updateUI);
    };

    function initAudio() {
      // synth setup unchanged from previous
      synths = {};
      synths.kick = new Tone.MembraneSynth({ pitchDecay:0.05, octaves:10, oscillator:{type:'sine'}, envelope:{attack:0.001,decay:0.4,sustain:0.01,release:1.4} }).toDestination();
      synths.snare= new Tone.NoiseSynth({ noise:{type:'white'}, envelope:{attack:0.001,decay:0.13,sustain:0.2,release:0.03} }).toDestination();
      synths.hihat= new Tone.NoiseSynth({ noise:{type:'white'}, envelope:{attack:0.001,decay:0.02,sustain:0,release:0.01} }).toDestination();
      synths.openhat= new Tone.NoiseSynth({ noise:{type:'white'}, envelope:{attack:0.001,decay:0.15,sustain:0.05,release:0.05} }).toDestination();
      synths.bass= new Tone.MonoSynth({ oscillator:{type:'sine'}, envelope:{attack:0.001,decay:0.4,sustain:0.1,release:1.0}, filter:{Q:6,type:'lowpass',rolloff:-24}, filterEnvelope:{attack:0.001,decay:0.5,sustain:0.1,release:1.0,baseFrequency:200,octaves:2.6} }).toDestination();
      synths.pad = new Tone.PolySynth(Tone.Synth, { oscillator:{type:'sawtooth'}, envelope:{attack:0.8,decay:0.2,sustain:0.6,release:2.0}, filter:{Q:1,type:'lowpass',rolloff:-12} }).toDestination();
      // volume levels remain
      synths.kick.volume.value=-8; synths.snare.volume.value=-12;
      synths.hihat.volume.value=-18; synths.openhat.volume.value=-16;
      synths.bass.volume.value=-10; synths.pad.volume.value=-20;
    }

    function updateMusicState() {
      if (motion>0) { motion*=0.92; if (motion<0.5) motion=0; }
      if (motion>motionThreshold && !isPlaying) startMusic();
      else if (motion<stopThreshold && isPlaying) stopMusic();
      if (isPlaying && motion>0) {
        const target = Math.max(60,Math.min(140,baseTempo + motion*0.8));
        currentTempo = currentTempo*0.9 + target*0.1;
        Tone.Transport.bpm.value = currentTempo;
      }
    }

    function startMusic() {
      if (!isPlaying) {
        isPlaying=true;
        const tmp = Math.max(60,Math.min(140,baseTempo + motion*0.8));
        Tone.Transport.bpm.value=tmp;
        if (musicFadeTimeout) clearTimeout(musicFadeTimeout);
        if (Tone.Transport.state==='stopped') Tone.Transport.start();
        Tone.Transport.scheduleRepeat((time)=>{
          const pos=step%16, intensity=Math.max(0.1,motion/100);
          dropTheBeat(pos,time,intensity); updateRhythm(pos); step++; }, '16n');
      }
    }

    function stopMusic() {
      if (isPlaying) {
        isPlaying=false;
        musicFadeTimeout=setTimeout(()=>{ if (!isPlaying){ Tone.Transport.stop(); Tone.Transport.cancel(); clearRhythm(); } },500);
      }
    }

    function dropTheBeat(pos,time,intensity) {
      // beat logic unchanged
      if (patterns.kick[pos]) synths.kick.triggerAttackRelease('C1','8n',time,Math.min(1,intensity*1.2));
      if (patterns.snare[pos] && intensity>0.3) synths.snare.triggerAttackRelease('8n',time,Math.min(1,intensity));
      if (patterns.hihat[pos] && intensity>0.2) synths.hihat.triggerAttackRelease('32n',time,intensity*0.7);
      if (patterns.openhat[pos] && intensity>0.6) synths.openhat.triggerAttackRelease('16n',time,intensity*0.8);
      if (patterns.bass[pos] && intensity>0.4){ const notes=['E1','A1','D1','G1']; synths.bass.triggerAttackRelease(notes[Math.floor(intensity*4)%4],'4n',time,Math.min(1,intensity*1.1)); }
      if (intensity>0.7 && pos%8===0){ const chords=[['A2','C3','E3'],['F2','A2','C3'],['G2','B2','D3'],['D2','F#2','A2']]; synths.pad.triggerAttackRelease(chords[Math.floor(step/16)%4],'2n',time,intensity*0.4); }
    }

    function handleMotion(e) {
      const a=e.accelerationIncludingGravity; if(a?.x!=null){ const total=Math.hypot(a.x,a.y,a.z); motion=Math.min(100,Math.abs(total-9.8)*15); smoothMotion(); }}

    function handleOrientation(e) {
      const {beta,gamma}=e; if (lastBeta===null) lastBeta=beta; if(lastGamma===null) lastGamma=gamma;
      const d= Math.abs(beta-lastBeta)+Math.abs(gamma-lastGamma);
      motion=Math.min(100,d*0.7); lastBeta=beta; lastGamma=gamma; smoothMotion(); }

    function smoothMotion(){ motionHistory.push(motion); if(motionHistory.length>3) motionHistory.shift(); motion=motionHistory.reduce((s,v)=>s+v,0)/motionHistory.length; }

    function updateUI(){ document.getElementById('motionLevel').textContent=Math.round(motion);
      document.getElementById('tempoDisplay').textContent=Math.round(currentTempo);
      document.getElementById('playingState').textContent=isPlaying?'Yes':'No';
      document.getElementById('inputMode').textContent=inputMode;
      document.getElementById('currentState').textContent=
        motion<5?'Still':motion<20?'Gentle':motion<50?'Active':motion<80?'Energetic':'Intense';
      document.getElementById('progress').style.width=motion+'%';
      requestAnimationFrame(updateUI);
    }

    function updateRhythm(pos){ const r=document.getElementById('rhythm'); r.innerHTML=''; for(let i=0;i<16;i++){ const b=document.createElement('div'); b.className='beat'+(i===pos?' active':'')+(patterns.kick[i]?' kick':'')+(patterns.snare[i]?' snare':''); r.appendChild(b);} }
    function clearRhythm(){ const r=document.getElementById('rhythm'); r.innerHTML=''; for(let i=0;i<16;i++){ const b=document.createElement('div'); b.className='beat'; r.appendChild(b);} }
  </script>
</body>
</html>
