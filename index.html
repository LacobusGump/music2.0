<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PocketÂ LooperÂ â€” Motionâ€‘Driven Rap Beats</title>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{@apply m-0 min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white gap-4 overflow-hidden;}
    #dot{position:absolute;width:10px;height:10px;border-radius:50%;background:#0af;opacity:0;transition:opacity .2s}
  </style>
</head>
<body>
  <h1 class="text-3xl font-bold">PocketÂ Looper</h1>
  <p id="status" class="text-sm opacity-80 text-center max-w-xs">TapÂ <kbd>START</kbd> â€¢ allow mic & motion â€¢ then move!</p>
  <div class="flex gap-2">
    <button id="startBtn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">START</button>
    <button id="resetBtn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 hidden">RESET</button>
  </div>
  <canvas id="viz" class="w-full max-w-md h-24"></canvas>
  <div id="dot"></div>

<script>
const SAMPLES = {
  kick: 'https://tonejs.github.io/audio/drum-samples/breakbeat/kick.wav',
  snare: 'https://tonejs.github.io/audio/drum-samples/breakbeat/snare.wav'
};

let bpm = 90;
let layer = 0;
let lastMotion = 0;
let transportLive = false;
const ambientPlayers = [];

const master = new Tone.Gain(0.9).toDestination();
const kick = new Tone.Player({ url: SAMPLES.kick }).connect(master);
const snare = new Tone.Player({ url: SAMPLES.snare }).connect(master);
const recorder = new Tone.Recorder();
const mic = new Tone.UserMedia();
mic.connect(recorder);

const $ = s => document.querySelector(s);
const startBtn = $('#startBtn');
const resetBtn = $('#resetBtn');
const status = $('#status');
const dot = $('#dot');
const canvas = $('#viz');
const ctx = canvas.getContext('2d');
const analyser = new Tone.Analyser('waveform', 128);
master.connect(analyser);

function flashDot() {
  dot.style.transform = `translate(${Math.random() * innerWidth}px,${Math.random() * innerHeight}px)`;
  dot.style.opacity = 1;
  setTimeout(() => dot.style.opacity = 0, 200);
}

function draw() {
  canvas.width = canvas.clientWidth * devicePixelRatio;
  canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const d = analyser.getValue();
  ctx.beginPath();
  ctx.strokeStyle = '#0af';
  d.forEach((v, i) => {
    const x = i / d.length * canvas.clientWidth;
    const y = (1 - v) * canvas.clientHeight / 2;
    i ? ctx.lineTo(x, y) : ctx.moveTo(x, y);
  });
  ctx.stroke();
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

function buildDrums() {
  Tone.Transport.cancel();
  const part = new Tone.Part(time => {
    kick.start(time);
    snare.start(time + Tone.Time('4n'));
    kick.start(time + Tone.Time('2n'));
    kick.start(time + Tone.Time('2n+8n'));
    snare.start(time + Tone.Time('3n'));
  }, [[0]]);
  part.loop = true;
  part.loopEnd = '1m';
  Tone.Transport.bpm.value = bpm;
  part.start(0);
  if (!transportLive) {
    Tone.Transport.start();
    transportLive = true;
  }
  status.textContent = `ğŸ¥ Drums @ ${bpm}â€¯BPM â€” move for more layers`;
}

async function addAmbientLayer() {
  try {
    status.textContent = 'ğŸ¤ Recording ambientâ€¦';
    await mic.open();
    recorder.start();
    await Tone.sleep(2);
    const rec = await recorder.stop();
    const url = URL.createObjectURL(rec.blob);
    const pl = new Tone.Player({
      url,
      loop: true,
      fadeIn: 1,
      fadeOut: 1,
      playbackRate: 1 + (Math.random() * 0.5 - 0.25)
    }).connect(master);
    await pl.load();
    pl.start();
    ambientPlayers.push(pl);
    status.textContent = `âœ… Ambient layer ${ambientPlayers.length}`;
  } catch (e) {
    console.error(e);
    status.textContent = 'âŒ Ambient recording failed';
  }
}

function motionHandler(e) {
  const a = e.accelerationIncludingGravity || {};
  const mag = Math.hypot(a.x || 0, a.y || 0, a.z || 0);
  if (mag < 12) return;
  const now = Date.now();
  if (now - lastMotion < 300) return;
  lastMotion = now;
  flashDot();
  if (layer === 0) {
    bpm = Math.min(160, Math.max(60, Math.round(60 / ((Date.now() - lastMotion) / 1000 || 1))));
    buildDrums();
    layer = 1;
  } else if (layer < 4) {
    addAmbientLayer();
    layer++;
  }
}

async function armAudioAndMotion() {
  try {
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
      const p = await DeviceMotionEvent.requestPermission();
      if (p !== 'granted') throw new Error('Motion denied');
    }
    await Tone.start();
    status.textContent = 'ğŸ”Š Loading samplesâ€¦';
    await kick.load();
    await snare.load();
    status.textContent = 'âœ… Ready â€” move to start';
    window.addEventListener('devicemotion', motionHandler);
    resetBtn.classList.remove('hidden');
  } catch (e) {
    console.error(e);
    status.textContent = 'âŒ ' + e.message;
  }
}

function resetAll() {
  Tone.Transport.stop();
  Tone.Transport.cancel();
  transportLive = false;
  layer = 0;
  bpm = 90;
  ambientPlayers.forEach(p => p.stop());
  ambientPlayers.length = 0;
  status.textContent = 'ğŸ”„ Reset â€” move to start again';
}

startBtn.onclick = () => {
  armAudioAndMotion();
};
resetBtn.onclick = resetAll;
</script>
</body>
</html>
