<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>GUMP: Cinematic Void Engine</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js" defer></script>
  <style>
    /* reset & base */
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{width:100%;height:100%;overflow:hidden;background:#1a1a1a;color:#fff;font-family:'Courier New',monospace;transition:background 2s ease;display:flex;align-items:center;justify-content:center;}
    .hidden{display:none!important;}
    /* buttons & text */
    .start-screen, .instruction {position:absolute;text-align:center;z-index:100;pointer-events:none;}
    .start-btn{pointer-events:auto;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,0.1),transparent 70%);border:2px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;letter-spacing:2px;backdrop-filter:blur(10px);cursor:pointer;animation:pulse 6s ease-in-out infinite;transition:transform .3s,border-color .3s,background .3s;}
    .start-btn:hover{transform:scale(1.05);border-color:rgba(255,255,255,0.6);background:radial-gradient(circle,rgba(255,255,255,0.2),transparent 70%);}
    @keyframes pulse{0%,100%{box-shadow:0 0 30px rgba(255,255,255,0.2);}50%{box-shadow:0 0 60px rgba(255,255,255,0.4);}}
    .instruction{top:50%;left:50%;transform:translate(-50%, -50%);font-size:14px;color:rgba(255,255,255,0.7);letter-spacing:2px;font-weight:bold;opacity:0;transition:opacity 2s;}
    .instruction.show{opacity:1;pointer-events:none;}
    /* UI corners */
    .ui-corner{position:fixed;font-size:11px;color:rgba(255,255,255,0.8);background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;backdrop-filter:blur(8px);z-index:50;}
    .top-left{top:20px;left:20px;} .bottom-left{bottom:20px;left:20px;} .top-right{top:20px;right:20px;}
    .stage-name{font-size:14px;font-weight:bold;margin-bottom:6px;} .metric{font-size:10px;line-height:1.2;margin:2px 0;} .bar{width:80px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden;} .bar-fill{height:100%;background:linear-gradient(90deg,#4a90e2,#9b59b6);width:0;transition:width .3s;}
    /* orb & states */
    .orb{position:absolute;width:40px;height:40px;border-radius:50%;background:radial-gradient(circle,#fff 0%,rgba(255,255,255,0.3)50%,transparent80%);box-shadow:0 0 40px rgba(255,255,255,0.5);transition:transform .15s;} 
    .orb.pulse{transform:scale(2.2);} 
    .orb.tribal{background:radial-gradient(circle,#ff6b35,rgba(255,107,53,0.4));box-shadow:0 0 60px rgba(255,107,53,0.7);} 
    .orb.orchestral{background:radial-gradient(circle,#4a90e2,rgba(74,144,226,0.4));box-shadow:0 0 80px rgba(74,144,226,0.7);} 
    .orb.transcendent{background:radial-gradient(circle,#9b59b6,#e74c3c 40%,#f39c12 70%);box-shadow:0 0 120px rgba(155,89,182,0.8);animation:transcend 3s ease-in-out infinite;} 
    @keyframes transcend{0%,100%{transform:scale(1);}50%{transform:scale(1.4);}}
    /* overlays */
    .cinematic-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,transparent 30%,rgba(0,0,0,0.6)100%);opacity:0;transition:opacity 3s;z-index:30;} .cinematic-overlay.active{opacity:1;}
    .theme-text{position:fixed;bottom:30px;right:30px;font-size:12px;text-transform:uppercase;letter-spacing:3px;font-weight:bold;color:rgba(255,255,255,0.6);opacity:0;transition:opacity 2s;z-index:50;} .theme-text.visible{opacity:1;}
    /* viz & particles */
    .spectrum-viz{position:fixed;bottom:0;left:0;width:100%;height:100px;pointer-events:none;z-index:10;} .spectrum-bar{position:absolute;bottom:0;width:8px;border-radius:4px 4px 0 0;background:rgba(255,255,255,0.8);transition:height .1s;}
    canvas.particles, canvas#particleCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;}
    /* controls panels */
    .synthesis-controls, .mixer-panel{position:fixed;background:rgba(0,0,0,0.3);padding:10px;border-radius:5px;backdrop-filter:blur(10px);z-index:40;} 
    .synthesis-controls{bottom:120px;left:20px;} .mixer-panel{top:100px;right:20px;} 
    .control-group{margin-bottom:8px;} .control-label{font-size:10px;} .slider{width:140px;} .layer-fader{display:flex;align-items:center;margin-bottom:6px;} .fader-label{width:60px;font-size:10px;} .fader{flex:1;}
  </style>
</head>
<body>
  <div class="start-screen" id="startScreen">
    <div class="start-btn" id="startBtn">AWAKEN</div>
  </div>
  <div class="evolution-space hidden" id="evolutionSpace">
    <div class="orb" id="orb"></div>
    <div class="instruction" id="instruction">MOVE TO UNRAVEL THE VOID</div>
    <div class="ui-corner top-left">
      <div class="stage-name" id="stageName">SILENCE</div>
      <div class="metric">TECHNIQUE: <span id="technique">WAITING</span></div>
    </div>
    <div class="ui-corner bottom-left">
      <div class="metric">MOTION INTENSITY</div><div class="bar"><div class="bar-fill" id="motionBar"></div></div>
      <div class="metric">SHEPARD TENSION</div><div class="bar"><div class="bar-fill" id="shepardBar"></div></div>
    </div>
    <div class="ui-corner top-right">
      <div class="metric">BPM: <span id="bpmDisplay">--</span></div>
      <div class="metric">KEY: <span id="keyDisplay">--</span></div>
      <div class="metric">VOICES: <span id="voiceCount">0</span></div>
    </div>
    <canvas class="particles" id="particleCanvas"></canvas>
    <div class="spectrum-viz" id="spectrumViz"></div>
    <div class="synthesis-controls" id="synthesisControls"></div>
    <div class="mixer-panel" id="mixerPanel"></div>
    <div class="cinematic-overlay" id="cinematicOverlay"></div>
    <div class="theme-text" id="themeText"></div>
  </div>
  <script>
    (function(){
      const el = id=>document.getElementById(id);
      const elements = {};
      ['startScreen','startBtn','evolutionSpace','orb','instruction','stageName','technique','motionBar','shepardBar','bpmDisplay','keyDisplay','voiceCount','cinematicOverlay','themeText','spectrumViz','particleCanvas','synthesisControls','mixerPanel'].forEach(i=>elements[i]=el(i));
      const themes={awakening:{colors:['#1a1a1a','#2a2a2a'],text:'The Journey Begins'},adventure:{colors:['#ff6b35','#1a1a1a'],text:'Into the Unknown'},tension:{colors:['#4a90e2','#1a1a1a'],text:'Rising Storm'},triumph:{colors:['#9b59b6','#e74c3c'],text:'Epic Triumph'},reflection:{colors:['#f39c12','#1a1a1a'],text:'Eternal Reflection'}};
      let active=false,motionHistory=[],shepardIntensity=0,totalMotion=0;
      let analyser, synths={}, transportLoop;

      // unified permissions + init
      async function start(){
        try{
          if(DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
          if(DeviceOrientationEvent?.requestPermission) await DeviceOrientationEvent.requestPermission();
          await Tone.start();
          initAudio();
          elements.startScreen.classList.add('hidden');
          elements.evolutionSpace.classList.remove('hidden');
          setTimeout(()=>elements.instruction.classList.add('show'),500);
          setTimeout(()=>elements.instruction.classList.remove('show'),4500);
          active=true; animate(); bindMotion();
        }catch(err){alert('Init failed: '+err);console.error(err);}
      }

      // audio chain
      function initAudio(){
        analyser=new Tone.Analyser('fft',32);
        const master=new Tone.Volume(0).toDestination();
        const limiter=new Tone.Limiter(-6).connect(master);
        const compressor=new Tone.Compressor({threshold:-24,knee:16,ratio:8,attack:0.005,release:0.15}).connect(limiter);
        const reverb=new Tone.Reverb({decay:4,preDelay:0.1}).connect(limiter);
        const ping=new Tone.PingPongDelay(0.25,0.4).connect(limiter);
        // synth layers config
        const layers=['kick','bass','hihat','snare','ostinato','harmony','pad','atmosphere','strings','brass','choir','shepard','samples'];
        layers.forEach(l=>{ synths[l]=createSynth(l).connect(compressor); });
        Tone.Transport.bpm.value=60; Tone.Transport.start();
        transportLoop=new Tone.Loop(time=>step(time),'16n').start(0);
        setupSpectrum(); setupControls();
      }

      function createSynth(name){
        switch(name){
          case 'kick': return new Tone.MembraneSynth();
          case 'hihat': return new Tone.MetalSynth({frequency:8000});
          case 'snare': return new Tone.NoiseSynth();
          case 'shepard': return new Tone.PolySynth(Tone.Synth,{oscillator:{type:'sine'},maxPolyphony:6});
          case 'samples': return new Tone.Players();
          default: return new Tone.PolySynth(Tone.Synth,{oscillator:{type:'sine'},maxPolyphony:8});
        }
      }

      function bindMotion(){
        let lastAcc={x:0,y:0,z:0},lastTime=0;
        window.addEventListener('devicemotion',e=>{
          if(!active) return;
          const g=e.accelerationIncludingGravity||{};
          const now=Date.now(); if(now-lastTime<33) return; lastTime=now;
          const dx=Math.abs(g.x-lastAcc.x),dy=Math.abs(g.y-lastAcc.y),dz=Math.abs(g.z-lastAcc.z);
          const m=Math.sqrt(dx*dx+dy*dy+dz*dz)*0.6;
          lastAcc={x:g.x,y:g.y,z:g.z}; updateMotion(m);
        },{passive:true});
      }

      function updateMotion(val){
        motionHistory.push(val); if(motionHistory.length>120) motionHistory.shift();
        const avg=motionHistory.reduce((a,b)=>a+b)/motionHistory.length;
        totalMotion+=avg; shepardIntensity=Math.min(Math.max(shepardIntensity+(avg>1?0.03:-0.02),0),1);
        updateUI(avg);
      }

      function updateUI(avg){
        elements.motionBar.style.width=Math.min(avg*12,100)+'%';
        elements.shepardBar.style.width=(shepardIntensity*100)+'%';
        const bpm=60+avg*15; elements.bpmDisplay.textContent=Math.round(bpm);
        // dynamic BG
        const theme=themes[selectTheme(avg)];
        document.body.style.background=`radial-gradient(circle at 50% 50%,${theme.colors[0]} 0%,${theme.colors[1]} 40%,#0a0a0a 80%)`;
      }

      function selectTheme(avg){
        if(avg>4) return 'triumph'; if(avg>2.5) return 'tension'; if(avg>1) return 'adventure'; return 'awakening';
      }

      function setupSpectrum(){
        for(let i=0;i<32;i++){const b=document.createElement('div');b.className='spectrum-bar';b.style.left=(i*12)+'px';elements.spectrumViz.appendChild(b);}      }

      function step(time){
        // pulse orb
        elements.orb.classList.add('pulse'); setTimeout(()=>elements.orb.classList.remove('pulse'),150);
        // kick & hat for demo
        synths.kick.triggerAttackRelease('C1','8n',time,0.8);
        synths.hihat.triggerAttackRelease('16n',time,0.3);
      }

      function setupControls(){
        // placeholder: install sliders & mixer
      }

      function animate(){
        if(!active) return; requestAnimationFrame(animate);
      }

      elements.startBtn.addEventListener('click',start);
    })();
  </script>
</body>
</html>
