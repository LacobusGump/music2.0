<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Pocket Looper — Motion‑Driven Rap Beats</title>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{@apply m-0 min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white gap-4;}
    #dot{position:absolute;width:10px;height:10px;border-radius:50%;background:#0af;opacity:0;transition:opacity .2s}
  </style>
</head>
<body>
  <h1 class="text-3xl font-bold">Pocket Looper</h1>
  <p id="status" class="text-sm opacity-80">Tap START, grant mic & motion, then move!</p>
  <button id="startBtn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">START</button>
  <canvas id="viz" class="w-full max-w-md h-24"></canvas>
  <div id="dot"></div>

<script>
// ---------- CONFIG ----------
const KICK = 'https://tonejs.github.io/audio/drum-samples/breakbeat/kick.wav';
const SNARE = 'https://tonejs.github.io/audio/drum-samples/breakbeat/snare.wav';

// ---------- STATE ----------
let bpm = 90;
let layer = 0;      // 0 = drums, 1+ = ambient layers
let lastMotion = 0;
let transportStarted = false;
const ambientPlayers = [];

// ---------- AUDIO GRAPH ----------
const master = new Tone.Gain(1).toDestination();
const kick = new Tone.Player(KICK).toDestination();
const snare = new Tone.Player(SNARE).toDestination();
const recorder = new Tone.Recorder();
const mic = new Tone.UserMedia();
mic.connect(recorder);

// ---------- UI ----------
const $ = q=>document.querySelector(q);
const startBtn = $('#startBtn');
const status = $('#status');
const dot = $('#dot');
const canvas = $('#viz');
const ctx = canvas.getContext('2d');
const analyser = new Tone.Analyser('waveform',128);
master.connect(analyser);

function flashDot(){
  const x=Math.random()*innerWidth,y=Math.random()*innerHeight;
  dot.style.transform=`translate(${x}px,${y}px)`;
  dot.style.opacity=1;setTimeout(()=>dot.style.opacity=0,200);
}

function draw(){
  canvas.width=canvas.clientWidth*devicePixelRatio;
  canvas.height=canvas.clientHeight*devicePixelRatio;
  ctx.scale(devicePixelRatio,devicePixelRatio);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const data=analyser.getValue();
  ctx.beginPath();ctx.strokeStyle='#0af';
  data.forEach((v,i)=>{const x=i/data.length*canvas.clientWidth;const y=(1-v)*canvas.clientHeight/2;i?ctx.lineTo(x,y):ctx.moveTo(x,y)});
  ctx.stroke();requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

async function recordAmbient(){
  status.textContent='🎤 Recording ambient 2s…';
  await mic.open();
  recorder.start();
  await Tone.sleep(2);
  const rec = await recorder.stop();
  const url = URL.createObjectURL(rec.blob);
  const pl = new Tone.Player({url,loop:true,fadeIn:0.5,fadeOut:0.5,playbackRate:1+(Math.random()*0.4-0.2)}).connect(master);
  await pl.load();
  pl.start(0);
  ambientPlayers.push(pl);
  status.textContent='✅ Ambient layer added';
}

function buildDrumLoop(){
  // clear previous parts
  Tone.Transport.cancel();
  const part = new Tone.Part((time)=>{
    kick.start(time);
    snare.start(time+Tone.Time('4n'));
    kick.start(time+Tone.Time('2n'));
    kick.start(time+Tone.Time('2n+8n'));
    snare.start(time+Tone.Time('3n'));
  },[[0]]);
  part.loop=true;part.loopEnd='1m';
  Tone.Transport.bpm.value=bpm;
  part.start(0);
  if(!transportStarted){Tone.start();Tone.Transport.start();transportStarted=true;}
  status.textContent=`🥁 Drum loop running @ ${bpm} BPM`;
}

function onMotion(e){
  const acc=e.accelerationIncludingGravity||{};
  const mag=Math.hypot(acc.x||0,acc.y||0,acc.z||0);
  if(mag<12) return;
  const now=Date.now();
  if(now-lastMotion<300) return; // debounce ~200ms
  const interval=(now-lastMotion)/1000;
  lastMotion=now;
  flashDot();
  // first motion -> build drums, bpm from interval
  if(layer===0){
    bpm=Math.min(160,Math.max(60,Math.round(60/interval)));
    buildDrumLoop();
    layer=1;
  }else{
    // add new ambient layer every 4 motions
    if(layer<4 && (layer-1)%1===0){
      recordAmbient();
    }
    layer++;
  }
}

async function start(){
  try{
    status.textContent='🔊 Resuming audio…';
    await Tone.start();
    status.textContent='↪️ Waiting for motion…';
    if(typeof DeviceMotionEvent?.requestPermission==='function'){
      const p=await DeviceMotionEvent.requestPermission();
      if(p!=='granted') throw new Error('Motion denied');
    }
    window.addEventListener('devicemotion',onMotion);
  }catch(err){
    console.error(err);
    status.textContent='❌ Permission error: '+err.message;
  }
}

startBtn.onclick=start;
</script>
</body>
</html>
