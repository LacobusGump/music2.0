<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GUMP: Grand Unified Music Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height:100%; margin:0; padding:0; background:#0a0c11; overflow:hidden;}
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif;}
    .intro {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:radial-gradient(ellipse at 60% 50%,#161826 0%,#0a0c11 80%);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:20; transition:opacity 1.1s;
    }
    .intro-title {
      font-size:2.3rem; font-weight:900; letter-spacing:2px;
      color:#e5f8ff; text-shadow:0 0 60px #7fdaff,0 4px 16px #000b;
      margin-bottom:2.2rem; opacity:.94;
      animation:introFade 2.7s cubic-bezier(.9,0,.1,1) alternate infinite;
    }
    .intro-author {
      font-size:1.12rem; color:#b3e3f9; opacity:.84; margin-bottom:2.6rem; letter-spacing:.7px;
    }
    .intro-btn {
      background:linear-gradient(85deg,#00cfff 25%,#ed9fe7 90%);
      color:#111; font-weight:700; font-size:1.16rem; padding:19px 48px;
      border-radius:40px; border:none; cursor:pointer; box-shadow:0 0 36px #59d4fd22;
      letter-spacing:1px; transition:transform 0.16s;
    }
    .intro-btn:active { transform:scale(0.98);}
    @keyframes introFade {
      from { text-shadow:0 0 16px #b2fff7; }
      to { text-shadow:0 0 68px #fff9,0 4px 20px #b4d7ff88;}
    }
    .app {position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1;opacity:0;transition:opacity 1.3s;}
    .orb-viz {
      width:80vw; max-width:350px; height:80vw; max-height:350px;
      margin:0 auto; position:relative; top:7vh;
      border-radius:50%; background:radial-gradient(circle at 44% 50%,#222a44 12%,#0a0c11 90%);
      box-shadow:0 0 90px 12px #334f9655,0 0 130px #02122e88 inset;
      border:2.5px solid #3e579c60;
      display:flex; align-items:center; justify-content:center;
    }
    .music-orb {
      position:absolute; width:106px; height:106px; left:50%; top:50%;
      transform:translate(-50%,-50%);
      background:radial-gradient(circle at 50% 45%,#15132a 0%,#b4cfff28 69%,#171d27 100%);
      border-radius:50%;
      box-shadow:0 0 100px #a8c8fa32,0 0 32px #b9fff842;
      z-index:2; transition:background .9s,box-shadow 1.1s;
      animation:orbPulse 5.1s cubic-bezier(.65,0,.35,1) infinite alternate;
    }
    .music-orb.void {
      background:radial-gradient(circle at 48% 52%,#0e0c14 10%,#281e3b 55%,#18101c 100%);
      box-shadow:0 0 160px #a36ce255, 0 0 90px #22124599;
      animation:none;
    }
    .orb-glow {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:300px; height:300px; border-radius:50%; z-index:1;
      background:radial-gradient(circle at 52% 48%,#4250b933 1%,#bdf2ff40 36%,#0b0f1800 98%);
      pointer-events:none; mix-blend-mode:lighten; opacity:.65;
      filter:blur(9px); animation:orbPulse 4.6s cubic-bezier(.65,0,.35,1) infinite alternate;
    }
    @keyframes orbPulse {from{opacity:.69;}to{opacity:.92;}}
    .world-label {
      position:absolute; left:50%; top:92%; transform:translate(-50%,-50%);
      background:rgba(17,24,31,0.85); color:#e5f8ff; padding:12px 30px;
      border-radius:30px; font-size:1.12rem; letter-spacing:.6px;
      font-weight:600; opacity:0; pointer-events:none;
      box-shadow:0 8px 30px #0b0f1b36;
      transition:opacity 0.7s;
      z-index:10;
      text-align:center;
    }
    .world-label.show { opacity:1;}
    @media (max-width:500px) {
      .intro-title{font-size:1.22rem;}
      .world-label{font-size:.98rem;}
      .orb-viz{top:3vh;}
    }
  </style>
</head>
<body>
  <div class="intro" id="intro">
    <div class="intro-title">GUMP: Grand Unified Music Project</div>
    <div class="intro-author">By James McCandless</div>
    <button class="intro-btn" id="begin">Begin</button>
  </div>
  <div class="app" id="app">
    <div class="orb-viz">
      <div class="orb-glow"></div>
      <div class="music-orb" id="orb"></div>
      <div class="world-label" id="worldLabel"></div>
    </div>
  </div>
  <script>
  // === GUMP - Core Engine - ChatGPT x James McCandless 2025 ===

  // UTILITIES
  function lerp(a, b, t) { return a + (b - a) * t; }
  function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
  function rand(a,b){return a+Math.random()*(b-a);}
  function now(){return performance.now();}
  function fadeIn(el, ms=1000){el.style.transition=`opacity ${ms}ms`;el.style.opacity=1;}
  function fadeOut(el, ms=1000){el.style.transition=`opacity ${ms}ms`;el.style.opacity=0;}
  function capitalize(s){return s[0].toUpperCase()+s.slice(1);}
  function roundTemp(t){return Math.round(t*10)/10;}
  function mod(n, m) { return ((n % m) + m) % m; }

  // STATE
  let context = null, started = false, allowMotion = false, allowGeo = false;
  let weather = {desc:"", temp:0, main:"Clear", day:true};
  let city = "Nowhere", region = "", country = "";
  let timeInfo = {hour:12, min:0, weekday:"Monday", month:"January", season:"Winter"};
  let motion = {moving:false, level:0, heading:0, lastStep:0, steps:0};
  let geo = {lat:40.7, lon:-74, accuracy:300, street:"", lastCornerTime:0};
  let worldLabel = "";
  let worldLabelEl = null, orbEl = null;
  let voidMode = false, lastVoidSwitch = 0, musicState = "idle";
  let lastMovementTime = 0, buildStage = 0, sectionStep = 0, beat = 0;
  let gumpDNA = {};

  // MAIN FLOW
  window.onload = ()=>{
    orbEl = document.getElementById('orb');
    worldLabelEl = document.getElementById('worldLabel');
    document.getElementById('begin').onclick = startGUMP;
  };
  function startGUMP(){
    fadeOut(document.getElementById('intro'),900);
    setTimeout(()=>{
      document.getElementById('intro').classList.add('hidden');
      document.getElementById('app').style.opacity=1;
      setupWorld();
    },900);
  }
  // WORLD SETUP
  async function setupWorld(){
    // Time/Season
    const dt = new Date();
    timeInfo.hour = dt.getHours(); timeInfo.min = dt.getMinutes();
    timeInfo.weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dt.getDay()];
    timeInfo.month = ["January","February","March","April","May","June","July","August","September","October","November","December"][dt.getMonth()];
    const m = dt.getMonth(); timeInfo.season = (m<2||m===11)?"Winter":(m<5)?"Spring":(m<8)?"Summer":"Fall";
    // Location & weather
    getLocationAndWeather();
    // Get motion permission on iOS
    if(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission==="function"){
      DeviceMotionEvent.requestPermission().then(r=>{
        if(r==="granted") allowMotion=true;
      }).catch(()=>{});
    } else { allowMotion=true; }
    setupMotion();
    setTimeout(()=>initMusicEngine(),900);
  }
  // LOCATION, WEATHER
  function getLocationAndWeather(){
    if(!navigator.geolocation) { useDefaultLocation(); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      allowGeo=true;
      geo.lat = pos.coords.latitude; geo.lon = pos.coords.longitude; geo.accuracy = pos.coords.accuracy;
      // Reverse geocode city/region (Nominatim)
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${geo.lat}&lon=${geo.lon}&zoom=10`)
        .then(r=>r.json()).then(data=>{
          city = data.address.city||data.address.town||data.address.village||data.address.hamlet||"";
          region = data.address.state||data.address.county||"";
          country = data.address.country||"";
        });
      // Weather (Open-Meteo)
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current_weather=true`)
        .then(r=>r.json()).then(data=>{
          if(data.current_weather){
            weather.temp = data.current_weather.temperature;
            weather.main = decodeWeather(data.current_weather.weathercode);
            weather.desc = `${capitalize(weather.main)}`;
            weather.day = (data.current_weather.is_day===1);
          }
        });
      // Street name
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${geo.lat}&lon=${geo.lon}&zoom=18`)
        .then(r=>r.json()).then(data=>{
          geo.street = (data.address.road||"").replace(/^\d+\s*/,"");
        });
    }, useDefaultLocation, {enableHighAccuracy:true,timeout:6000});
  }
  function useDefaultLocation(){
    city="Jersey"; region="NJ"; country="USA";
    weather.temp=27; weather.main="Clear"; weather.day=true; weather.desc="Clear";
    geo.street = "";
  }
  function decodeWeather(code){
    if(code<3) return "Clear";
    if(code<5) return "Cloudy";
    if(code<7) return "Fog";
    if(code<20) return "Drizzle";
    if(code<30) return "Rain";
    if(code<40) return "Snow";
    if(code<50) return "Thunder";
    return "Clear";
  }
  // MOTION
  function setupMotion(){
    window.addEventListener('devicemotion',e=>{
      if(!allowMotion) return;
      let acc = e.accelerationIncludingGravity;
      if(!acc) return;
      let lv = Math.sqrt(acc.x*acc.x+acc.y*acc.y+acc.z*acc.z);
      let t = now();
      if(lv>13 && t-motion.lastStep>250){
        motion.steps++; motion.lastStep=t; lastMovementTime=t; motion.moving=true;
      }
      motion.level = lerp(motion.level, clamp(lv-9,0,30), 0.08);
      if(t-lastMovementTime>1800){ motion.moving=false; motion.level=lerp(motion.level,0,0.05);}
    });
    window.addEventListener('deviceorientation',e=>{
      if(typeof e.alpha === "number"){ motion.heading = e.alpha; }
    });
  }

  // MUSIC ENGINE
  let audio=null, bpm=120, baseInterval=250, tickId=null, padOscs=[], layers=[], dropTimer=0, buildStage=0, heavenTime=0;
  function initMusicEngine(){
    if(context) return;
    context = audio = new (window.AudioContext||window.webkitAudioContext)();
    bpm = 120; baseInterval = 60000/bpm/2;
    gumpDNA = worldToMusicDNA();
    setTimeout(mainTick, 800);
    fadeIn(orbEl,600);
  }
  function worldToMusicDNA(){
    let dna = {};
    let roots = [220, 247, 262, 294, 330, 349, 392, 440];
    let hr = timeInfo.hour;
    let seasonMap = {Winter:0,Spring:2,Summer:4,Fall:5};
    let rootI = mod(hr+seasonMap[timeInfo.season],roots.length);
    dna.root = roots[rootI];
    dna.scale = weather.day ? [0,2,4,5,7,9,11,12] : [0,2,3,5,7,8,10,12];
    let progs = [ [0,4,5,3], [0,3,4,5], [0,5,3,4], [0,2,5,4] ];
    dna.chordProg = progs[mod(timeInfo.hour+dtHash(timeInfo.weekday),progs.length)];
    dna.groove = (weather.main==="Rain"||weather.main==="Snow") ? "sparse" : 
                 (weather.main==="Cloudy"||weather.main==="Fog") ? "floaty" :
                 (weather.temp>28) ? "hot" :
                 (weather.temp<8) ? "chill" :
                 (["Saturday","Sunday"].includes(timeInfo.weekday)) ? "party" : "steady";
    dna.hasBells = (!weather.day||voidMode);
    dna.padDetune = weather.temp>30? 0.03 : weather.temp<10? 0.012 : 0.017;
    dna.subBoost = (!weather.day && hr>21)||(city.length>2 && city[0].toUpperCase()==="N")?1.5:1.0;
    dna.label = [
      weather.day? (hr<12?"Morning":"Afternoon") : (hr<21?"Evening":"Night"),
      capitalize(weather.main),
      `${roundTemp(weather.temp)}°`,
      (city?city:"")
    ].filter(Boolean).join(" · ");
    return dna;
  }
  function dtHash(s){let h=0;for(let i=0;i<s.length;i++)h+=s.charCodeAt(i);return h;}
  function mainTick(){
    if(!audio) return;
    let t = now();
    let movement = motion.moving||motion.level>3;
    let curVoid = !movement;
    if(curVoid !== voidMode){
      voidMode = curVoid;
      heavenTime = t;
      showWorldLabel(voidMode?gumpDNA.label.replace(/Morning|Afternoon|Evening|Night/i,"Heaven") : gumpDNA.label);
      orbEl.classList.toggle('void',voidMode);
      // Crossfade background for void
      if(voidMode){
        document.body.style.background = 'radial-gradient(ellipse at 60% 50%, #0e0c14 0%, #25163b 60%, #18101c 100%)';
      } else {
        document.body.style.background = 'radial-gradient(ellipse at 60% 50%, #161826 0%, #0a0c11 80%)';
      }
    }
    // Music build: drums>pad>sub>lead>bells, only build if moving
    if(!voidMode){
      if(movement){ buildStage = clamp(buildStage+1,0,8);}
      else{ buildStage = clamp(buildStage-1,0,8);}
    } else {
      buildStage = clamp(buildStage-1,0,8);
    }
    sectionStep++; beat++;
    if(voidMode){
      heavenMusic();
      fadeIn(orbEl,1100);
    } else {
      worldMusic(buildStage);
      fadeIn(orbEl,800);
    }
    if(motion.steps>0 && motion.steps%24===0 && (t-geo.lastCornerTime>16000)){
      geo.lastCornerTime = t;
      triggerDrop("Corner Drop");
    }
    tickId = setTimeout(mainTick, baseInterval);
  }
  function worldMusic(stage){
    stopPads();
    if(stage>0) drumLoop();
    if(stage>2) padLoop();
    if(stage>4) subLoop();
    if(stage>6) leadLoop();
    if(stage>7 && gumpDNA.hasBells) bellLoop();
  }
  function heavenMusic(){
    stopPads();
    // Deep, detuned, filtered triangle pads + sub + *soft* triangle bells (dark, lush, no shimmer)
    let baseF = gumpDNA.root * 0.44;
    for(let i=-2;i<=2;i++){
      let o = audio.createOscillator(), g = audio.createGain(), f = audio.createBiquadFilter();
      o.type = 'triangle';
      o.frequency.value = baseF * (1+i*0.009);
      g.gain.value = 0.12;
      f.type = 'lowpass'; f.frequency.value = 310 + (i*16); f.Q.value = 1.5;
      o.connect(f).connect(g).connect(audio.destination);
      o.start(); o.stop(audio.currentTime+1.97);
      padOscs.push(o); layers.push(g);
    }
    // Sub bass pulse
    let sub = audio.createOscillator(), sg = audio.createGain();
    sub.type = 'sine'; sub.frequency.value = gumpDNA.root * 0.25;
    sg.gain.setValueAtTime(0.17, audio.currentTime);
    sg.gain.linearRampToValueAtTime(0.03, audio.currentTime + 1.38);
    sub.connect(sg).connect(audio.destination);
    sub.start(); sub.stop(audio.currentTime + 1.53);
    padOscs.push(sub); layers.push(sg);
    // Bells, but only subtle and low-passed
    if(beat%9===0){
      let o = audio.createOscillator(), g = audio.createGain(), f = audio.createBiquadFilter();
      o.type = 'triangle';
      o.frequency.value = gumpDNA.root * 1.25 + rand(-3,2);
      f.type = 'lowpass'; f.frequency.value = 1000;
      g.gain.value = 0.057;
      o.connect(f).connect(g).connect(audio.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 2.13);
      o.stop(audio.currentTime + 2.13);
      padOscs.push(o); layers.push(g);
    }
  }
  // --- MUSIC COMPONENTS ---
  function drumLoop(){
    let kickT = beat%4===0, snareT = beat%8===4, hatT = beat%2===1;
    if(gumpDNA.groove==="party"){kickT=beat%4===0;snareT=beat%8===4;hatT=true;}
    if(gumpDNA.groove==="hot"){kickT=beat%2===0;snareT=beat%4===2;hatT=true;}
    if(gumpDNA.groove==="sparse"){kickT=beat%8===0;snareT=beat%16===8;hatT=beat%2===1;}
    if(gumpDNA.groove==="chill"){kickT=beat%8===0;snareT=beat%8===4;hatT=beat%4===2;}
    if(gumpDNA.groove==="floaty"){kickT=beat%12===0;snareT=beat%16===8;hatT=beat%3===1;}
    if(kickT) drumKick();
    if(snareT) drumSnare();
    if(hatT) drumHat();
  }
  function drumKick(){
    let o=audio.createOscillator(),g=audio.createGain();
    o.type='sine'; o.frequency.setValueAtTime(52,audio.currentTime);
    o.frequency.exponentialRampToValueAtTime(29,audio.currentTime+.12);
    g.gain.setValueAtTime(.42,audio.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.22);
    o.connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime+.22);
  }
  function drumSnare(){
    let buf=audio.createBuffer(1,audio.sampleRate*.13,audio.sampleRate);
    let out=buf.getChannelData(0);
    for(let i=0;i<buf.length;i++) out[i]=Math.random()*2-1;
    let noise=audio.createBufferSource(); noise.buffer=buf;
    let nGain=audio.createGain();
    nGain.gain.setValueAtTime(.21,audio.currentTime);
    nGain.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.09);
    noise.connect(nGain).connect(audio.destination);
    noise.start(); noise.stop(audio.currentTime+.11);
    let osc=audio.createOscillator(),g=audio.createGain();
    osc.type='triangle'; osc.frequency.setValueAtTime(215,audio.currentTime);
    g.gain.setValueAtTime(.04,audio.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.06);
    osc.connect(g).connect(audio.destination);
    osc.start(); osc.stop(audio.currentTime+.08);
  }
  function drumHat(){
    let buf=audio.createBuffer(1,audio.sampleRate*.06,audio.sampleRate);
    let data=buf.getChannelData(0);
    for(let i=0;i<buf.length;i++) data[i]=Math.random()*2-1;
    let noise=audio.createBufferSource(); noise.buffer=buf;
    let hp=audio.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3400;
    let g=audio.createGain();
    g.gain.setValueAtTime(.1,audio.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.03);
    noise.connect(hp).connect(g).connect(audio.destination);
    noise.start(); noise.stop(audio.currentTime+.05);
  }
  function padLoop(){
    stopPads();
    let root=gumpDNA.root,scale=gumpDNA.scale,prog=gumpDNA.chordProg;
    let step=beat%prog.length;
    let chord=prog[step];
    let freqs=[root*Math.pow(2,scale[chord]/12),root*Math.pow(2,scale[(chord+2)%scale.length]/12),root*Math.pow(2,scale[(chord+4)%scale.length]/12)];
    let det=gumpDNA.padDetune;
    for(let i=0;i<freqs.length;i++){
      let o=audio.createOscillator(),g=audio.createGain();
      o.type='sawtooth'; o.frequency.value=freqs[i]*(1+det*(i-1));
      g.gain.value=0.055; o.connect(g).connect(audio.destination);
      o.start(); o.stop(audio.currentTime+baseInterval/1000*1.6);
      padOscs.push(o); layers.push(g);
    }
  }
  function stopPads(){
    while(padOscs.length){try{padOscs.pop().stop();}catch(e){}}
    while(layers.length){try{layers.pop().disconnect();}catch(e){}}
  }
  function subLoop(){
    let o=audio.createOscillator(),g=audio.createGain();
    o.type='triangle'; o.frequency.value=gumpDNA.root*0.5;
    g.gain.value=0.15*gumpDNA.subBoost; o.connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime+baseInterval/1000*1.5);
    padOscs.push(o); layers.push(g);
  }
  function leadLoop(){
    let o=audio.createOscillator(),g=audio.createGain();
    o.type='triangle';
    let freq=gumpDNA.root*Math.pow(2,gumpDNA.scale[mod(sectionStep,gumpDNA.scale.length)]/12);
    o.frequency.value=freq+rand(-3,3);
    g.gain.value=0.10; o.connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime+baseInterval/1000*1.1);
    padOscs.push(o); layers.push(g);
  }
  function bellLoop(){
    let o=audio.createOscillator(),g=audio.createGain();
    o.type='sine'; o.frequency.value=gumpDNA.root*2.67;
    g.gain.value=0.18; o.connect(g).connect(audio.destination);
    o.start(); o.frequency.linearRampToValueAtTime(o.frequency.value*1.19,audio.currentTime+0.4);
    g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+1.05);
    o.stop(audio.currentTime+1.05); padOscs.push(o); layers.push(g);
  }
  function triggerDrop(label){
    fadeIn(orbEl,500); orbEl.classList.add('void');
    setTimeout(()=>{ orbEl.classList.remove('void'); },1300);
    let o=audio.createOscillator(),g=audio.createGain();
    o.type='sawtooth'; o.frequency.setValueAtTime(gumpDNA.root*4,audio.currentTime);
    o.frequency.linearRampToValueAtTime(gumpDNA.root*2,audio.currentTime+0.14);
    g.gain.setValueAtTime(.28,audio.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+0.39);
    o.connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime+0.39);
    showWorldLabel(label+" · "+gumpDNA.label,2200);
  }
  function showWorldLabel(str,dur=2200){
    if(worldLabel===str) return;
    worldLabel = str; worldLabelEl.textContent = str;
    worldLabelEl.classList.add('show');
    setTimeout(()=>{worldLabelEl.classList.remove('show');},dur);
  }
  </script>
</body>
</html>
