<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Soundtrack: Adaptive Music</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #000;
      color: #0f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    
    .title {
      font-size: 2rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 10px #0f0;
    }
    
    .start-btn {
      padding: 10px 20px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 20px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .control-btn {
      padding: 8px 16px;
      background: rgba(0,255,0,0.1);
      color: #0f0;
      border: 1px solid #0f0;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .control-btn:hover {
      background: rgba(0,255,0,0.2);
    }
    
    .control-btn.active {
      background: rgba(0,255,0,0.3);
    }
    
    .status {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 20px 0;
      font-size: 0.9rem;
    }
    
    .status-item {
      background: rgba(0,255,0,0.1);
      padding: 10px;
      border-radius: 3px;
      border: 1px solid rgba(0,255,0,0.3);
    }
    
    .layers {
      margin: 20px 0;
    }
    
    .layer-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin: 0 5px;
      background: rgba(0,255,0,0.3);
      transition: all 0.3s;
    }
    
    .layer-dot.active {
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">LIFE SOUNDTRACK</h1>
    <button class="start-btn" id="startBtn">Start Music</button>
    
    <div class="controls hidden" id="controls">
      <button class="control-btn" id="btnMotionPermission">Enable Motion Detection</button>
      <button class="control-btn" id="btnPicardy">Picardy</button>
      <div style="margin-top: 10px; font-size: 0.8rem; color: #0a0;">
        <div id="motionStatus">Motion detection inactive</div>
        <div id="motionDebug">Move your phone to see changes</div>
      </div>
    </div>
    
    <div class="status hidden" id="status">
      <div class="status-item">
        <div>Motion: <span id="motionLevel">0</span></div>
        <div>State: <span id="currentState">Still</span></div>
      </div>
      <div class="status-item">
        <div>Tempo: <span id="currentTempo">72</span> BPM</div>
        <div>Key: <span id="currentKey">A Minor</span></div>
      </div>
      <div class="status-item">
        <div>Stage: <span id="evolutionStage">Dormant</span></div>
        <div>Layers: <span id="layerCount">1</span></div>
      </div>
      <div class="status-item">
        <div>Emotion: <span id="emotionState">Neutral</span></div>
        <div>Complexity: <span id="complexity">Basic</span></div>
      </div>
    </div>
    
    <div class="layers hidden" id="layers">
      <div>Active Layers:</div>
      <div style="margin-top: 10px;">
        <span class="layer-dot active" id="layerAmbient" title="Ambient"></span>
        <span class="layer-dot" id="layerBass" title="Bass"></span>
        <span class="layer-dot" id="layerDrums" title="Drums"></span>
        <span class="layer-dot" id="layerHarmony" title="Harmony"></span>
        <span class="layer-dot" id="layerMelody" title="Melody"></span>
        <span class="layer-dot" id="layerTexture" title="Texture"></span>
      </div>
    </div>
  </div>

  <script>
    // Musical system
    const KEYS = {
      A_MINOR: {
        name: 'A Minor',
        chords: {
          i: ['A3', 'C4', 'E4'],
          ii: ['B3', 'D4', 'F4'],
          III: ['C4', 'E4', 'G4'],
          iv: ['D4', 'F4', 'A4'],
          v: ['E4', 'G4', 'B4'],
          VI: ['F4', 'A4', 'C5'],
          VII: ['G4', 'B4', 'D5'],
          picardy: ['A3', 'C#4', 'E4']
        }
      }
    };
    
    const PROGRESSIONS = {
      dormant: ['i'],
      contemplative: ['i', 'VI'],
      building: ['i', 'VI', 'III', 'VII'],
      active: ['i', 'iv', 'VI', 'v'],
      dynamic: ['i', 'VII', 'VI', 'III']
    };
    
    // State
    let state = {
      active: false,
      currentKey: KEYS.A_MINOR,
      motionIntensity: 0,
      activityState: 'still',
      tempo: 72,
      evolutionStage: 'dormant',
      activeLayers: new Set(['ambient']),
      complexity: 0,
      chordIndex: 0,
      emotionalState: 'neutral',
      beatCount: 0,
      picardyActive: false,
      motionHistory: [],
      lastMotionTime: 0,
      motionPermissionGranted: false
    };
    
    // Audio
    let instruments = {};
    let audioInitialized = false;
    
    // Initialize audio
    async function initAudio() {
      if (audioInitialized) return;
      
      await Tone.start();
      
      // Create instruments
      instruments.ambient = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: { attack: 2, decay: 1, sustain: 0.8, release: 3 }
      }).toDestination();
      
      instruments.bass = new Tone.MonoSynth({
        oscillator: { type: 'sawtooth' },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 0.8 }
      }).toDestination();
      
      instruments.drums = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
      }).toDestination();
      
      instruments.harmony = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.5, decay: 0.8, sustain: 0.6, release: 2 }
      }).toDestination();
      
      instruments.melody = new Tone.Synth({
        oscillator: { type: 'square' },
        envelope: { attack: 0.1, decay: 0.2, sustain: 0.3, release: 0.8 }
      }).toDestination();
      
      instruments.texture = new Tone.NoiseSynth({
        noise: { type: 'pink' },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.1, release: 0.5 }
      }).toDestination();
      
      // Set volumes
      instruments.ambient.volume.value = -20;
      instruments.bass.volume.value = -15;
      instruments.drums.volume.value = -18;
      instruments.harmony.volume.value = -22;
      instruments.melody.volume.value = -18;
      instruments.texture.volume.value = -25;
      
      Tone.Transport.bpm.value = state.tempo;
      Tone.Transport.start();
      
      audioInitialized = true;
      startSequence();
    }
    
    // Start musical sequence
    function startSequence() {
      Tone.Transport.scheduleRepeat((time) => {
        state.beatCount++;
        
        // Play chord every measure
        if (state.beatCount % 4 === 0) {
          playChord(time);
        }
        
        // Play bass on beats 1 and 3
        if (state.beatCount % 2 === 0 && state.activeLayers.has('bass')) {
          playBass(time);
        }
        
        // Play drums
        if (state.activeLayers.has('drums')) {
          playDrums(time);
        }
        
        // Play harmony
        if (state.activeLayers.has('harmony') && state.beatCount % 8 === 0) {
          playHarmony(time);
        }
        
        // Evolve music
        evolveMusic();
        updateUI();
        
      }, '4n');
    }
    
    // Play chord
    function playChord(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      let chord = state.currentKey.chords[chordName];
      
      // Use Picardy third if active
      if (state.picardyActive && chordName === 'i') {
        chord = state.currentKey.chords.picardy;
      }
      
      if (chord && state.activeLayers.has('ambient')) {
        instruments.ambient.triggerAttackRelease(chord, '2n', time);
      }
      
      state.chordIndex++;
    }
    
    // Play bass
    function playBass(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[state.chordIndex % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const bassNote = chord[0].replace('3', '2');
        instruments.bass.triggerAttackRelease(bassNote, '8n', time);
      }
    }
    
    // Play drums
    function playDrums(time) {
      const patterns = {
        still: [1, 0, 0, 0],
        walking: [1, 0, 1, 0],
        running: [1, 1, 0, 1],
        dancing: [1, 1, 1, 1]
      };
      
      const pattern = patterns[state.activityState];
      const beat = state.beatCount % 4;
      
      if (pattern[beat]) {
        instruments.drums.triggerAttackRelease('C2', '16n', time);
      }
    }
    
    // Play harmony
    function playHarmony(time) {
      const progression = PROGRESSIONS[state.evolutionStage];
      const chordName = progression[(state.chordIndex + 1) % progression.length];
      const chord = state.currentKey.chords[chordName];
      
      if (chord) {
        const harmonyChord = chord.map(note => note.replace('4', '5'));
        instruments.harmony.triggerAttackRelease(harmonyChord, '4n', time);
      }
    }
    
    // Evolve music
    function evolveMusic() {
      // Determine layers based on intensity
      if (state.motionIntensity < 0.5) {
        state.evolutionStage = 'dormant';
        state.activeLayers = new Set(['ambient']);
      } else if (state.motionIntensity < 1.5) {
        state.evolutionStage = 'contemplative';
        state.activeLayers = new Set(['ambient', 'harmony']);
      } else if (state.motionIntensity < 2.5) {
        state.evolutionStage = 'building';
        state.activeLayers = new Set(['ambient', 'harmony', 'bass']);
      } else if (state.motionIntensity < 3.5) {
        state.evolutionStage = 'active';
        state.activeLayers = new Set(['ambient', 'harmony', 'bass', 'drums']);
      } else {
        state.evolutionStage = 'dynamic';
        state.activeLayers = new Set(['ambient', 'harmony', 'bass', 'drums', 'melody']);
      }
      
      // Update tempo
      const targetTempo = 60 + (state.motionIntensity * 20);
      Tone.Transport.bpm.rampTo(targetTempo, 2);
      state.tempo = Math.round(targetTempo);
      
      // Update complexity
      state.complexity = Math.min(5, Math.floor(state.motionIntensity * 1.5));
      
      // Update emotional state
      if (state.motionIntensity < 0.5) {
        state.emotionalState = 'calm';
      } else if (state.motionIntensity > 3) {
        state.emotionalState = 'energetic';
      } else {
        state.emotionalState = 'neutral';
      }
    }
    
    // Update UI
    function updateUI() {
      document.getElementById('motionLevel').textContent = state.motionIntensity.toFixed(1);
      document.getElementById('currentState').textContent = state.activityState;
      document.getElementById('currentTempo').textContent = state.tempo;
      document.getElementById('currentKey').textContent = state.currentKey.name;
      document.getElementById('evolutionStage').textContent = state.evolutionStage;
      document.getElementById('layerCount').textContent = state.activeLayers.size;
      document.getElementById('emotionState').textContent = state.emotionalState;
      document.getElementById('complexity').textContent = ['None', 'Basic', 'Simple', 'Moderate', 'Complex', 'Rich'][state.complexity];
      
      // Update layer indicators
      const layers = ['ambient', 'bass', 'drums', 'harmony', 'melody', 'texture'];
      layers.forEach(layer => {
        const dot = document.getElementById(`layer${layer.charAt(0).toUpperCase() + layer.slice(1)}`);
        if (dot) {
          dot.classList.toggle('active', state.activeLayers.has(layer));
        }
      });
    }
    
    // Motion detection
    function requestMotionPermission() {
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        // iOS 13+ permission request
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              startMotionDetection();
            } else {
              document.getElementById('motionStatus').textContent = 'Motion permission denied';
            }
          })
          .catch(error => {
            document.getElementById('motionStatus').textContent = 'Motion permission error';
            console.error('Motion permission error:', error);
          });
      } else {
        // Android and older iOS
        startMotionDetection();
      }
    }
    
    function startMotionDetection() {
      state.motionPermissionGranted = true;
      document.getElementById('motionStatus').textContent = 'Motion detection active';
      document.getElementById('btnMotionPermission').classList.add('active');
      
      if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', handleMotion);
      } else {
        document.getElementById('motionStatus').textContent = 'Device motion not supported';
      }
    }
    
    function handleMotion(event) {
      if (!state.active || !state.motionPermissionGranted) return;
      
      const acceleration = event.accelerationIncludingGravity;
      const rotation = event.rotationRate;
      
      if (!acceleration) return;
      
      const now = Date.now();
      
      // Calculate motion intensity from acceleration
      const accelMagnitude = Math.sqrt(
        (acceleration.x || 0) ** 2 + 
        (acceleration.y || 0) ** 2 + 
        (acceleration.z || 0) ** 2
      );
      
      // Calculate rotation intensity
      const rotationMagnitude = rotation ? Math.sqrt(
        (rotation.alpha || 0) ** 2 + 
        (rotation.beta || 0) ** 2 + 
        (rotation.gamma || 0) ** 2
      ) : 0;
      
      // Combine acceleration and rotation for total motion
      const totalMotion = (accelMagnitude / 10) + (rotationMagnitude / 100);
      
      // Add to motion history
      state.motionHistory.push({
        intensity: totalMotion,
        timestamp: now
      });
      
      // Keep only last 2 seconds of data
      state.motionHistory = state.motionHistory.filter(m => now - m.timestamp < 2000);
      
      // Calculate smoothed motion intensity
      const recentMotion = state.motionHistory.slice(-10);
      const avgMotion = recentMotion.reduce((sum, m) => sum + m.intensity, 0) / recentMotion.length;
      
      // Apply smoothing and scaling
      state.motionIntensity = Math.min(5, Math.max(0, avgMotion * 2));
      
      // Determine activity state based on motion patterns
      determineActivityState();
      
      // Update debug info
      document.getElementById('motionDebug').textContent = 
        `Accel: ${accelMagnitude.toFixed(1)} | Rot: ${rotationMagnitude.toFixed(1)} | Total: ${totalMotion.toFixed(2)}`;
      
      state.lastMotionTime = now;
    }
    
    function determineActivityState() {
      const intensity = state.motionIntensity;
      const recentMotion = state.motionHistory.slice(-5);
      
      // Calculate motion variance to detect type of movement
      const motionValues = recentMotion.map(m => m.intensity);
      const variance = calculateVariance(motionValues);
      
      if (intensity < 0.3) {
        state.activityState = 'still';
      } else if (intensity < 1.0) {
        state.activityState = 'walking';
      } else if (intensity < 2.5) {
        if (variance > 0.5) {
          state.activityState = 'dancing'; // High variance = erratic movement
        } else {
          state.activityState = 'running'; // Low variance = steady movement
        }
      } else {
        state.activityState = 'dancing'; // Very high intensity
      }
      
      // Trigger Picardy effect on sudden motion changes
      if (recentMotion.length > 1) {
        const motionChange = Math.abs(recentMotion[recentMotion.length - 1].intensity - recentMotion[0].intensity);
        if (motionChange > 1.5) {
          triggerPicardyMoment();
        }
      }
    }
    
    function calculateVariance(values) {
      if (values.length < 2) return 0;
      const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
      const squareDiffs = values.map(val => (val - mean) ** 2);
      return squareDiffs.reduce((sum, diff) => sum + diff, 0) / values.length;
    }
    
    function triggerPicardyMoment() {
      state.picardyActive = true;
      document.getElementById('btnPicardy').classList.add('active');
      
      // Auto-disable after 4 beats
      setTimeout(() => {
        state.picardyActive = false;
        document.getElementById('btnPicardy').classList.remove('active');
      }, (60 / state.tempo) * 4 * 1000);
    }
    
    // Event listeners
    document.getElementById('startBtn').addEventListener('click', async () => {
      await initAudio();
      state.active = true;
      
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('controls').classList.remove('hidden');
      document.getElementById('status').classList.remove('hidden');
      document.getElementById('layers').classList.remove('hidden');
      
      updateUI();
    });
    
    document.getElementById('btnMotionPermission').addEventListener('click', requestMotionPermission);
    
    document.getElementById('btnPicardy').addEventListener('click', () => {
      state.picardyActive = !state.picardyActive;
      document.getElementById('btnPicardy').classList.toggle('active', state.picardyActive);
    });
    
    // Check for motion inactivity and reset
    setInterval(() => {
      if (state.active && state.motionPermissionGranted) {
        const now = Date.now();
        if (now - state.lastMotionTime > 3000) {
          // No motion for 3 seconds, gradually reduce intensity
          state.motionIntensity = Math.max(0, state.motionIntensity - 0.1);
          if (state.motionIntensity < 0.3) {
            state.activityState = 'still';
          }
        }
      }
    }, 500);
  </script>
</body>
</html>
