<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>ENVIRONMENTAL AI MUSIC</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  background: #000;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', monospace;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  position: fixed;
  touch-action: none;
}
#spatialGrid {
  position: fixed; inset: 0; pointer-events: none;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(0,255,255,0.07) 49px, rgba(0,255,255,0.07) 50px),
    repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(0,255,255,0.07) 49px, rgba(0,255,255,0.07) 50px);
  opacity: 0.35;
}
.audio-zone {
  position: absolute;
  border: 2px solid rgba(0,255,255,0.4);
  border-radius: 50%;
  pointer-events: none;
  transition: all 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  text-shadow: 0 0 8px #000;
  opacity: 0.6;
}
.audio-zone.active {
  border-color: #0ff;
  box-shadow: 0 0 45px rgba(0,255,255,0.7);
  opacity: 1;
  animation: pulse-zone 2.5s ease-in-out infinite;
}
.audio-zone.recording {
  border-color: #f0f;
  box-shadow: 0 0 60px rgba(255,0,255,0.9);
  animation: pulse-recording 0.8s ease-in-out infinite;
}
@keyframes pulse-zone { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
@keyframes pulse-recording { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2); } }
#userPosition {
  position: absolute;
  width: 34px; height: 34px;
  background: radial-gradient(circle, #f0f, #f0f 38%, transparent 70%);
  border: 2px solid #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 30px #f0f;
  z-index: 100; pointer-events: none;
}
#userPosition::before {
  content: ''; position: absolute; inset: -14px;
  border: 1px solid rgba(255,0,255,0.5);
  border-radius: 50%;
  animation: ripple 3s ease-out infinite;
}
@keyframes ripple { 0% { transform: scale(0.7); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
#startScreen {
  position: fixed; inset: 0;
  background: radial-gradient(circle at center, #000f0f 0%, #000 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 1000; padding: 20px;
  transition: opacity 1s ease;
}
#startScreen.hidden { opacity: 0; pointer-events: none; }
.start-title {
  font-size: 36px; font-weight: bold; margin-bottom: 14px;
  background: linear-gradient(90deg, #0ff, #f0f, #0ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: gradient-shift 5s ease infinite;
}
@keyframes gradient-shift { 0%,100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(45deg); } }
.start-subtitle { font-size: 15px; opacity: 0.8; text-align: center; margin-bottom: 50px; max-width: 340px; }
#startButton {
  padding: 22px 55px; font-size: 20px; font-weight: bold;
  background: linear-gradient(135deg, #0ff, #f0f); border: none; border-radius: 50px;
  color: #000; cursor: pointer; box-shadow: 0 0 45px rgba(0,255,255,0.7);
  transition: all 0.3s ease;
}
#startButton:active { transform: scale(0.94); }
.permission-status { margin-top: 40px; font-size: 13px; opacity: 0.7; text-align: center; }
.permission-item { margin: 7px 0; }
.permission-item.granted { color: #0f0; }
.permission-item.denied { color: #f88; }
#statusBar {
  position: fixed; top: 0; left: 0; right: 0; padding: 15px;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
  display: flex; justify-content: space-between; font-size: 12px; z-index: 50;
}
.status-group { display: flex; flex-direction: column; gap: 4px; }
.status-label { opacity: 0.6; font-size: 10px; }
.status-value { font-weight: bold; color: #0ff; }
#aiStatus {
  position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
  padding: 14px 28px; border-radius: 30px; border: 1px solid rgba(255,0,255,0.5);
  font-size: 14px; display: flex; align-items: center; gap: 14px;
  opacity: 0; transition: opacity 0.6s;
}
#aiStatus.visible { opacity: 1; }
.ai-indicator {
  width: 11px; height: 11px; background: #f0f; border-radius: 50%;
  animation: blink 1.4s ease-in-out infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
#musicInfo {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 20px; border-radius: 20px; border: 1px solid rgba(0,255,255,0.3);
  text-align: center; opacity: 0; transition: opacity 0.6s; max-width: 90%;
}
#musicInfo.visible { opacity: 1; }
.track-name { font-size: 19px; font-weight: bold; color: #0ff; margin-bottom: 7px; }
.track-details { font-size: 13px; opacity: 0.8; }
#controlPanel {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
  padding: 18px; border-radius: 30px; border: 1px solid rgba(0,255,255,0.3);
  display: flex; gap: 22px;
}
.control-button {
  width: 58px; height: 58px; border-radius: 50%;
  border: 2px solid #0ff; background: rgba(0,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; cursor: pointer; transition: all 0.2s;
}
.control-button:active { transform: scale(0.88); background: rgba(0,255,255,0.3); }
.control-button.active { background: rgba(0,255,255,0.5); box-shadow: 0 0 30px rgba(0,255,255,0.8); }
.error-message {
  background: rgba(255,0,0,0.2); border: 1px solid #f88; padding: 16px;
  border-radius: 12px; margin-top: 30px; font-size: 13px; max-width: 300px;
}
</style>
</head>
<body>
<div id="spatialGrid"></div>
<div id="userPosition"></div>
<div id="audioZonesContainer"></div>

<div id="startScreen">
  <div class="start-title">ENVIRONMENTAL AI MUSIC</div>
  <div class="start-subtitle">The world provides the sounds. You move through space to capture and transform them into an ever-evolving sonic creature.</div>
  <button id="startButton">TAP TO ENTER</button>
  <div class="permission-status">
    <div class="permission-item" id="motionStatus">◯ Motion</div>
    <div class="permission-item" id="orientationStatus">◯ Orientation</div>
    <div class="permission-item" id="micStatus">◯ Microphone</div>
  </div>
  <div class="error-message" id="errorMessage" style="display:none;"></div>
</div>

<div id="statusBar">
  <div class="status-group"><div class="status-label">POSITION</div><div class="status-value" id="positionDisplay">0, 0</div></div>
  <div class="status-group"><div class="status-label">LAYERS</div><div class="status-value" id="zonesDisplay">0/5</div></div>
  <div class="status-group"><div class="status-label">ENERGY</div><div class="status-value" id="energyDisplay">0%</div></div>
</div>

<div id="aiStatus">
  <div class="ai-indicator"></div>
  <span id="aiStatusText">AI Listening to the world...</span>
</div>

<div id="musicInfo">
  <div class="track-name" id="trackName">Silent Void</div>
  <div class="track-details" id="trackDetails">Make sounds and move into zones to capture</div>
</div>

<div id="controlPanel">
  <div class="control-button" id="calibrateBtn" title="Calibrate">⊙</div>
  <div class="control-button" id="toggleAudioBtn" class="active" title="Mute">♫</div>
  <div class="control-button" id="resetBtn" title="Reset">↻</div>
</div>

<script>
'use strict';

class EnvironmentalAIMusic {
  constructor() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.accel = { x: 0, y: 0 };
    this.orientation = { alpha: 0, beta: 0, gamma: 0 };
    this.calibration = { x: 0, y: 0 };

    this.zones = [];
    this.activeZones = new Set();
    this.recording = false;
    this.lastCaptureTime = 0;

    this.permissions = { motion: false, orientation: false, mic: false };

    this.ui = {
      startScreen: document.getElementById('startScreen'),
      startButton: document.getElementById('startButton'),
      userPosition: document.getElementById('userPosition'),
      zonesContainer: document.getElementById('audioZonesContainer'),
      positionDisplay: document.getElementById('positionDisplay'),
      zonesDisplay: document.getElementById('zonesDisplay'),
      energyDisplay: document.getElementById('energyDisplay'),
      aiStatus: document.getElementById('aiStatus'),
      aiStatusText: document.getElementById('aiStatusText'),
      trackName: document.getElementById('trackName'),
      trackDetails: document.getElementById('trackDetails'),
      motionStatus: document.getElementById('motionStatus'),
      orientationStatus: document.getElementById('orientationStatus'),
      micStatus: document.getElementById('micStatus'),
      errorMessage: document.getElementById('errorMessage'),
      calibrateBtn: document.getElementById('calibrateBtn'),
      toggleAudioBtn: document.getElementById('toggleAudioBtn'),
      resetBtn: document.getElementById('resetBtn')
    };

    this.setupEvents();
  }

  setupEvents() {
    this.ui.startButton.addEventListener('click', () => this.initialize());
    this.ui.calibrateBtn.addEventListener('click', () => this.calibrate());
    this.ui.toggleAudioBtn.addEventListener('click', () => this.toggleMute());
    this.ui.resetBtn.addEventListener('click', () => this.resetPosition());
  }

  async initialize() {
    this.ui.startButton.disabled = true;
    this.ui.startButton.textContent = 'AWAKENING THE WORLD...';

    try {
      await this.requestDevicePermissions();
      await Tone.start();
      await this.requestMic();
      this.setupAudio();
      this.setupMotion();
      this.createZones();
      this.startExperience();
      this.ui.startScreen.classList.add('hidden');
    } catch (err) {
      console.error(err);
      this.showError(err.message || 'Failed to start. Check permissions.');
      this.ui.startButton.disabled = false;
      this.ui.startButton.textContent = 'TAP TO ENTER';
    }
  }

  async requestDevicePermissions() {
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
      const res = await DeviceMotionEvent.requestPermission();
      this.permissions.motion = res === 'granted';
    } else this.permissions.motion = true;
    this.updatePermUI('motion', this.permissions.motion);

    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      const res = await DeviceOrientationEvent.requestPermission();
      this.permissions.orientation = res === 'granted';
    } else this.permissions.orientation = true;
    this.updatePermUI('orientation', this.permissions.orientation);

    if (!this.permissions.motion) throw new Error('Motion required for spatial control');
  }

  async requestMic() {
    try {
      this.stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
      });
      this.permissions.mic = true;
      this.updatePermUI('mic', true);
    } catch (e) {
      this.permissions.mic = false;
      this.updatePermUI('mic', false);
      throw new Error('Microphone access denied. Cannot capture world sounds.');
    }
  }

  updatePermUI(type, granted) {
    const el = this.ui[`${type}Status`];
    el.textContent = granted ? '✓ ' : '✗ ';
    el.textContent += type.charAt(0).toUpperCase() + type.slice(1);
    el.className = 'permission-item ' + (granted ? 'granted' : 'denied');
  }

  setupAudio() {
    this.reverb = new Tone.Reverb({ decay: 6, wet: 0.4 }).toDestination();
    this.reverb.generate();

    this.masterGain = new Tone.Gain(0.7).toDestination();
    this.reverb.connect(this.masterGain);

    this.meter = new Tone.Meter({ normalRange: true });
    const micSource = Tone.context.createMediaStreamSource(this.stream);
    micSource.connect(this.meter);
  }

  setupMotion() {
    window.addEventListener('devicemotion', e => {
      if (e.accelerationIncludingGravity) {
        this.accel.x = e.accelerationIncludingGravity.x || 0;
        this.accel.y = e.accelerationIncludingGravity.y || 0;
      }
    });

    window.addEventListener('deviceorientation', e => {
      this.orientation.alpha = e.alpha || 0;
      this.orientation.beta = e.beta || 0;
      this.orientation.gamma = e.gamma || 0;
    });
  }

  createZones() {
    const w = window.innerWidth, h = window.innerHeight;
    const names = ['Deep Void', 'Crystal Echo', 'Stellar Grain', 'Ethereal Drift', 'Cosmic Pulse'];

    const configs = [
      { x: w*0.25, y: h*0.3, size: 150, name: names[0] },
      { x: w*0.75, y: h*0.35, size: 140, name: names[1] },
      { x: w*0.5, y: h*0.65, size: 170, name: names[2] },
      { x: w*0.3, y: h*0.7, size: 120, name: names[3] },
      { x: w*0.7, y: h*0.75, size: 130, name: names[4] }
    ];

    configs.forEach((cfg, i) => {
      const zone = {
        id: i, x: cfg.x, y: cfg.y, size: cfg.size, name: cfg.name,
        element: null, panner: new Tone.Panner( (cfg.x / w * 2 - 1) ).connect(this.reverb),
        player: null, lastCapture: 0
      };

      zone.element = document.createElement('div');
      zone.element.className = 'audio-zone';
      zone.element.style.left = (cfg.x - cfg.size/2) + 'px';
      zone.element.style.top = (cfg.y - cfg.size/2) + 'px';
      zone.element.style.width = zone.element.style.height = cfg.size + 'px';
      zone.element.textContent = cfg.name;
      this.ui.zonesContainer.appendChild(zone.element);

      this.zones.push(zone);
    });
  }

  detectPitch(buffer) {
    const data = buffer.getChannelData(0);
    const sampleRate = buffer.sampleRate;
    let bestOffset = -1;
    let bestCorrelation = 0;
    let rms = 0;

    for (let i = 0; i < data.length; i++) rms += data[i] ** 2;
    rms = Math.sqrt(rms / data.length);
    if (rms < 0.02) return { freq: -1, confidence: 0 };

    let lastCorrelation = 1;
    for (let offset = 30; offset < Math.min(1000, data.length / 2); offset++) {
      let correlation = 0;
      for (let i = 0; i < data.length - offset; i++) {
        correlation += Math.abs(data[i] - data[i + offset]);
      }
      correlation = 1 - (correlation / (data.length - offset));
      if (correlation > bestCorrelation && correlation > lastCorrelation) {
        bestCorrelation = correlation;
        bestOffset = offset;
      }
      lastCorrelation = correlation;
    }

    if (bestCorrelation > 0.9) {
      return { freq: sampleRate / bestOffset, confidence: bestCorrelation };
    }
    return { freq: -1, confidence: 0 };
  }

  async captureToZone(zone) {
    if (this.recording || Date.now() - zone.lastCapture < 8000) return;
    this.recording = true;
    zone.element.classList.add('recording');
    this.ui.aiStatusText.textContent = 'Capturing the world...';

    const duration = 1.5 + Math.random() * 1.5;
    const recorder = new MediaRecorder(this.stream);
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const arrayBuffer = await blob.arrayBuffer();
      const buffer = await Tone.context.decodeAudioData(arrayBuffer);

      // Dispose old player if exists
      if (zone.player) {
        zone.player.stop();
        zone.player.dispose();
      }

      const { freq, confidence } = this.detectPitch(buffer);

      const grain = new Tone.GrainPlayer();
      grain.buffer = buffer;
      grain.loop = true;
      grain.volume.value = -Infinity;
      grain.connect(zone.panner);

      // Base params
      grain.grainSize = 0.2 + Math.random() * 0.3;
      grain.overlap = grain.grainSize * 0.6;

      let rate = 1;
      if (confidence > 0.9 && freq > 60 && freq < 1600) {
        const scaleFreqs = [130.81,155.56,174.61,196,233.08,261.63,311.13,349.23,392,466.16,523.25,622.25]; // Cm extended
        scaleFreqs.push(...scaleFreqs.map(f => f*2));
        let nearest = scaleFreqs.reduce((a,b) => Math.abs(Math.log2(b/freq)) < Math.abs(Math.log2(a/freq)) ? b : a);
        let semitones = 12 * Math.log2(nearest / freq);
        if (Math.random() < 0.75) rate = Math.pow(2, semitones / 12);
      }
      rate *= 0.75 + Math.random() * 0.5; // extra character
      grain.playbackRate = rate;
      grain.detune = (Math.random() - 0.5) * 300;

      grain.start();
      zone.player = grain;
      zone.lastCapture = Date.now();

      zone.element.classList.remove('recording');
      zone.element.classList.add('active');
      this.ui.aiStatusText.textContent = 'AI morphing reality...';
      this.recording = false;
    };

    recorder.start();
    setTimeout(() => recorder.stop(), duration * 1000);
  }

  startExperience() {
    this.ui.aiStatus.classList.add('visible');
    this.ui.musicInfo.classList.add('visible');
    requestAnimationFrame(() => this.updateLoop());

    // Slow evolution
    setInterval(() => {
      this.zones.forEach(zone => {
        if (zone.player) {
          const tweak = 0.95 + Math.random() * 0.1;
          zone.player.playbackRate.rampTo(zone.player.playbackRate.value * tweak, 6);
          zone.player.detune.rampTo((Math.random() - 0.5) * 400, 6);
        }
      });
    }, 12000);
  }

  updateLoop() {
    this.updateMovement();
    this.updateZones();
    this.updateUI();
    requestAnimationFrame(() => this.updateLoop());
  }

  updateMovement() {
    const sens = 7, damp = 0.92;
    const ax = (this.accel.x - this.calibration.x) * sens;
    const ay = (this.accel.y - this.calibration.y) * sens;

    this.velocity.x += ax;
    this.velocity.y += ay;
    this.velocity.x *= damp;
    this.velocity.y *= damp;

    this.position.x += this.velocity.x;
    this.position.y += this.velocity.y;

    const margin = 70;
    if (this.position.x < margin) { this.position.x = margin; this.velocity.x *= -0.5; }
    if (this.position.x > window.innerWidth - margin) { this.position.x = window.innerWidth - margin; this.velocity.x *= -0.5; }
    if (this.position.y < margin) { this.position.y = margin; this.velocity.y *= -0.5; }
    if (this.position.y > window.innerHeight - margin) { this.position.y = window.innerHeight - margin; this.velocity.y *= -0.5; }

    this.ui.userPosition.style.left = this.position.x + 'px';
    this.ui.userPosition.style.top = this.position.y + 'px';
  }

  updateZones() {
    let activeCount = 0;
    const speed = Math.hypot(this.velocity.x, this.velocity.y);
    const energyNorm = Math.min(speed * 7, 100) / 100;

    // Global morph from motion energy
    this.reverb.wet.rampTo(0.3 + (1 - energyNorm) * 0.6, 3);
    const rateMult = 0.7 + energyNorm * 0.7;
    this.zones.forEach(z => {
      if (z.player) z.player.playbackRate.rampTo(z.player.playbackRate.value * rateMult / (0.7 + (1-energyNorm)*0.7), 3);
    });

    const volLevel = this.meter.getValue();

    this.zones.forEach(zone => {
      const dx = this.position.x - zone.x;
      const dy = this.position.y - zone.y;
      const dist = Math.hypot(dx, dy);
      const proximity = Math.max(0, 1 - dist / (zone.size / 2));

      if (proximity > 0.1) {
        if (!this.activeZones.has(zone.id)) {
          this.activeZones.add(zone.id);
          zone.element.classList.add('active');
        }
        activeCount++;

        if (zone.player) {
          const vol = -25 + proximity * 45;
          zone.player.volume.rampTo(vol, 0.4);

          // Grain texture from proximity & energy
          zone.player.grainSize = 0.05 + proximity * (0.3 + energyNorm * 0.3);
        }

        // Trigger capture when very close + sound present
        if (dist < zone.size / 4 && volLevel > 0.15) {
          this.captureToZone(zone);
        }
      } else {
        if (this.activeZones.has(zone.id)) {
          this.activeZones.delete(zone.id);
          zone.element.classList.remove('active');
          if (zone.player) zone.player.volume.rampTo(-Infinity, 2);
        }
      }
    });

    this.ui.zonesDisplay.textContent = `${activeCount}/5`;
  }

  updateUI() {
    this.ui.positionDisplay.textContent = `${Math.round(this.position.x)}, ${Math.round(this.position.y)}`;

    const speed = Math.hypot(this.velocity.x, this.velocity.y);
    const energy = Math.min(Math.round(speed * 7), 100);
    this.ui.energyDisplay.textContent = `${energy}%`;

    const active = this.activeZones.size;
    if (active === 0) {
      this.ui.aiStatusText.textContent = 'AI listening to silence...';
      this.ui.trackName.textContent = 'Empty Canvas';
      this.ui.trackDetails.textContent = 'Create sound and move into zones';
    } else if (active < 3) {
      this.ui.aiStatusText.textContent = 'AI weaving first threads...';
      this.ui.trackName.textContent = 'Emerging Breath';
    } else {
      this.ui.aiStatusText.textContent = 'AI orchestrating living world...';
      this.ui.trackName.textContent = 'Environmental Symphony';
      this.ui.trackDetails.textContent = 'Your reality, transformed';
    }
  }

  calibrate() {
    this.calibration.x = this.accel.x;
    this.calibration.y = this.accel.y;
    this.velocity = { x: 0, y: 0 };
    this.ui.calibrateBtn.classList.add('active');
    setTimeout(() => this.ui.calibrateBtn.classList.remove('active'), 300);
  }

  toggleMute() {
    if (this.masterGain.gain.value > 0) {
      this.masterGain.gain.rampTo(0, 0.6);
      this.ui.toggleAudioBtn.classList.remove('active');
    } else {
      this.masterGain.gain.rampTo(0.7, 0.6);
      this.ui.toggleAudioBtn.classList.add('active');
    }
  }

  resetPosition() {
    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.velocity = { x: 0, y: 0 };
    this.calibrate();
    this.ui.resetBtn.classList.add('active');
    setTimeout(() => this.ui.resetBtn.classList.remove('active'), 300);
  }

  showError(msg) {
    this.ui.errorMessage.textContent = '⚠️ ' + msg;
    this.ui.errorMessage.style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  window.app = new EnvironmentalAIMusic();
});

document.addEventListener('visibilitychange', () => {
  if (document.hidden) Tone.Transport.pause();
  else Tone.Transport.start();
});
</script>
</body>
</html>
